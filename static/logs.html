<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时日志监控 - 临时邮箱服务</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: #0f1419;
            color: #e4e4e7;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: #18181b;
            border-bottom: 1px solid #27272a;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #27272a;
            color: #e4e4e7;
            border: 1px solid #3f3f46;
        }

        .btn-secondary:hover {
            background: #3f3f46;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .filters {
            background: #18181b;
            border-bottom: 1px solid #27272a;
            padding: 16px 24px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #a1a1aa;
        }

        .filter-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pill {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #3f3f46;
            background: #18181b;
            color: #a1a1aa;
        }

        .pill:hover {
            background: #27272a;
            color: #e4e4e7;
        }

        .pill.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #3f3f46;
            background: #18181b;
            color: #e4e4e7;
            font-size: 13px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .stats {
            background: #18181b;
            border-bottom: 1px solid #27272a;
            padding: 12px 24px;
            display: flex;
            gap: 24px;
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #a1a1aa;
        }

        .stat-value {
            color: #3b82f6;
            font-weight: 600;
        }

        .log-container {
            padding: 16px 24px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .log-entry:hover {
            background: #18181b;
        }

        .log-entry.new {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-entry.debug { border-left-color: #6b7280; }
        .log-entry.info { border-left-color: #3b82f6; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .log-entry.error { border-left-color: #ef4444; }
        .log-entry.success { border-left-color: #10b981; }

        .log-timestamp {
            color: #6b7280;
            min-width: 90px;
            flex-shrink: 0;
        }

        .log-level {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            min-width: 60px;
            text-align: center;
            flex-shrink: 0;
        }

        .log-level.debug { background: #374151; color: #9ca3af; }
        .log-level.info { background: #1e40af; color: #93c5fd; }
        .log-level.warning { background: #92400e; color: #fbbf24; }
        .log-level.error { background: #7f1d1d; color: #fca5a5; }
        .log-level.success { background: #065f46; color: #6ee7b7; }

        .log-type {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            background: #27272a;
            color: #a1a1aa;
            min-width: 80px;
            text-align: center;
            flex-shrink: 0;
        }

        .log-message {
            flex: 1;
            color: #e4e4e7;
            word-break: break-word;
        }

        .log-duration {
            color: #6b7280;
            font-size: 11px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .log-ip {
            color: #a1a1aa;
            font-size: 11px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 3px;
            padding: 2px 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 80px 24px;
            color: #71717a;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        #autoScroll:checked + label,
        #hideStats:checked + label {
            background: #3b82f6;
            color: white;
        }

        /* IP 统计弹窗樣式 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #18181b;
            border: 1px solid #3f3f46;
            border-radius: 12px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #27272a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: #27272a;
            border: 1px solid #3f3f46;
            color: #e4e4e7;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #3f3f46;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .ip-stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: #0f1419;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 16px;
        }

        .summary-label {
            font-size: 12px;
            color: #a1a1aa;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 600;
            color: #3b82f6;
        }

        .ip-table-container {
            overflow-x: auto;
        }

        .ip-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .ip-table th {
            background: #0f1419;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #3f3f46;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .ip-table td {
            padding: 12px;
            border-bottom: 1px solid #27272a;
        }

        .ip-table tr:hover {
            background: #0f1419;
        }

        .country-flag {
            display: inline-block;
            margin-right: 8px;
            font-size: 16px;
        }

        .request-count {
            background: #1e40af;
            color: #93c5fd;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #a1a1aa;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #3f3f46;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .country-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .country-stat-item {
            background: #0f1419;
            border: 1px solid #27272a;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .country-name {
            font-weight: 500;
        }

        .country-count {
            background: #065f46;
            color: #6ee7b7;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* 错误详情样式 */
        .log-details-toggle {
            cursor: pointer;
            color: #3b82f6;
            font-size: 11px;
            margin-left: 8px;
            padding: 2px 8px;
            border: 1px solid #3b82f6;
            border-radius: 3px;
            background: transparent;
            transition: all 0.2s;
            user-select: none;
        }

        .log-details-toggle:hover {
            background: #3b82f6;
            color: white;
        }

        .log-details {
            display: none;
            margin-top: 8px;
            padding: 12px;
            background: #0f1419;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-details.expanded {
            display: block;
        }

        .log-details-section {
            margin-bottom: 12px;
        }

        .log-details-section:last-child {
            margin-bottom: 0;
        }

        .log-details-title {
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .log-details-content {
            background: #18181b;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #27272a;
            color: #e4e4e7;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
        }

        .log-details-hint {
            background: #92400e;
            border: 1px solid #f59e0b;
            color: #fbbf24;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .log-details-error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 8px;
            border-radius: 4px;
        }

        /* 服务器离线全屏提示面板 */
        .server-offline-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .server-offline-overlay.active {
            display: flex;
        }

        .server-offline-panel {
            background: #18181b;
            border: 2px solid #ef4444;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(239, 68, 68, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .server-offline-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .server-offline-title {
            font-size: 24px;
            font-weight: 700;
            color: #ef4444;
            margin-bottom: 16px;
        }

        .server-offline-message {
            font-size: 16px;
            color: #a1a1aa;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .server-offline-details {
            background: #0f1419;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #e4e4e7;
            text-align: left;
        }

        .server-offline-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-reconnect {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-reconnect:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-reload {
            background: #27272a;
            color: #e4e4e7;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #3f3f46;
            transition: all 0.2s;
        }

        .btn-reload:hover {
            background: #3f3f46;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <span class="status-dot" id="statusDot"></span>
            <span>实时日志监控</span>
        </div>
        <div class="header-actions">
            <input type="checkbox" id="autoScroll" class="pill" checked hidden>
            <label for="autoScroll" class="pill">自动滚动</label>
            <button class="btn btn-secondary" id="pauseBtn">⏸ 暂停</button>
            <button class="btn btn-primary" id="ipStatsBtn">🌍 IP 统计</button>
            <button class="btn btn-secondary" id="exportBtn">📥 导出</button>
            <button class="btn btn-danger" id="clearBtn">🗑 清空</button>
        </div>
    </div>

    <div class="filters">
        <!-- 快速过滤预设 -->
        <div class="filter-group">
            <div class="filter-label">🎯 快速过滤</div>
            <div class="filter-pills">
                <div class="pill active" data-preset="all">全部</div>
                <div class="pill" data-preset="errors">仅错误</div>
                <div class="pill" data-preset="slow">慢请求</div>
                <div class="pill" data-preset="recent">最近 5 分钟</div>
            </div>
        </div>

        <!-- 日志级别 -->
        <div class="filter-group">
            <div class="filter-label">日志级别</div>
            <div class="filter-pills">
                <div class="pill active" data-level="all">全部</div>
                <div class="pill" data-level="debug">Debug</div>
                <div class="pill" data-level="info">Info</div>
                <div class="pill" data-level="warning">Warning</div>
                <div class="pill" data-level="error">Error</div>
                <div class="pill" data-level="success">Success</div>
            </div>
        </div>

        <!-- 日志类型 -->
        <div class="filter-group">
            <div class="filter-label">日志类型</div>
            <div class="filter-pills">
                <div class="pill active" data-type="all">全部</div>
                <div class="pill" data-type="request">请求</div>
                <div class="pill" data-type="response">响应</div>
                <div class="pill" data-type="email_gen">生成邮箱</div>
                <div class="pill" data-type="code_extract">提取验证码</div>
                <div class="pill" data-type="llm_call">LLM 调用</div>
            </div>
        </div>

        <!-- 请求方法 -->
        <div class="filter-group">
            <div class="filter-label">请求方法</div>
            <div class="filter-pills">
                <div class="pill active" data-method="all">全部</div>
                <div class="pill" data-method="GET">GET</div>
                <div class="pill" data-method="POST">POST</div>
                <div class="pill" data-method="DELETE">DELETE</div>
                <div class="pill" data-method="PUT">PUT</div>
            </div>
        </div>

        <!-- 时间范围 -->
        <div class="filter-group">
            <div class="filter-label">⏰ 时间范围</div>
            <div class="filter-pills">
                <div class="pill active" data-timerange="all">全部</div>
                <div class="pill" data-timerange="5m">5 分钟</div>
                <div class="pill" data-timerange="1h">1 小时</div>
                <div class="pill" data-timerange="today">今天</div>
                <div class="pill" data-timerange="24h">24 小时</div>
            </div>
        </div>

        <!-- 持续时间（慢请求） -->
        <div class="filter-group">
            <div class="filter-label">⏱️ 持续时间</div>
            <div class="filter-pills">
                <div class="pill active" data-duration="all">全部</div>
                <div class="pill" data-duration="fast">&lt; 100ms</div>
                <div class="pill" data-duration="medium">100-500ms</div>
                <div class="pill" data-duration="slow">&gt; 500ms</div>
                <div class="pill" data-duration="veryslow">&gt; 1000ms</div>
            </div>
        </div>

        <!-- 端点路径 -->
        <div class="filter-group" style="min-width: 200px;">
            <div class="filter-label">🎯 端点路径</div>
            <input type="text" class="search-input" id="pathFilter" placeholder="例如: /api/email" style="width: 100%;">
        </div>

        <!-- IP 地址 -->
        <div class="filter-group" style="min-width: 150px;">
            <div class="filter-label">🌐 IP 地址</div>
            <input type="text" class="search-input" id="ipFilter" placeholder="例如: 192.168">
        </div>

        <!-- 高级过滤 -->
        <div class="filter-group">
            <div class="filter-label">高级过滤</div>
            <div class="filter-pills">
                <input type="checkbox" id="hideStats" class="pill" checked hidden>
                <label for="hideStats" class="pill">隐藏统计</label>
            </div>
        </div>

        <!-- 关键字搜索 -->
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="🔍 搜索关键字...">
        </div>
    </div>

    <div class="stats" id="stats">
        <div class="stat-item">
            <span class="stat-label">总计:</span>
            <span class="stat-value" id="totalCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">显示:</span>
            <span class="stat-value" id="displayCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">订阅者:</span>
            <span class="stat-value" id="subscriberCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">独立IP:</span>
            <span class="stat-value" id="uniqueIpCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">当前IP:</span>
            <span class="stat-value" id="clientIp">-</span>
        </div>
    </div>

    <div class="log-container" id="logContainer">
        <div class="empty-state" id="emptyState">
            <div class="empty-icon">📋</div>
            <div>等待日志...</div>
        </div>
    </div>

    <!-- IP 统计弹窗 -->
    <div class="modal-overlay" id="ipStatsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span>🌍</span>
                    <span>IP 地理位置</span>
                </div>
                <button class="modal-close" id="closeIpStatsBtn">✕ 关闭</button>
            </div>
            <div class="modal-body" id="ipStatsModalBody">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <div>正在加载 IP 统计数据...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 服务器离线全屏提示面板 -->
    <div class="server-offline-overlay" id="serverOfflineOverlay">
        <div class="server-offline-panel">
            <div class="server-offline-icon">🔌</div>
            <div class="server-offline-title" id="offlineTitle">服务器连接失败</div>
            <div class="server-offline-message" id="offlineMessage">
                无法连接到日志服务器，请检查服务器是否正在运行。
            </div>
            <div class="server-offline-details" id="offlineDetails">
                <strong>详细信息:</strong><br>
                服务器可能已离线或网络连接中断。
            </div>
            <div class="server-offline-actions">
                <button class="btn-reconnect" id="btnReconnect">🔄 重新连接</button>
                <button class="btn-reload" id="btnReloadPage">↻ 刷新页面</button>
            </div>
        </div>
    </div>

    <script>
        // ===== 连接状态管理 =====
        let eventSource = null;
        let logs = [];
        let isPaused = false;
        let filters = {
            preset: 'all',           // 快速预设
            level: 'all',            // 日志级别
            types: [],               // 日志类型（多选）
            method: 'all',           // 请求方法
            timeRange: 'all',        // 时间范围
            duration: 'all',         // 持续时间
            pathFilter: '',          // 端点路径过滤
            ipFilter: '',            // IP 地址过滤
            keyword: '',             // 关键字搜索
            hideStats: true          // 隐藏统计请求
        };

        // 连接状态追踪
        let connectionState = {
            sseRetries: 0,           // SSE 重连次数
            maxSseRetries: 5,        // 最大 SSE 重试次数
            statsFailures: 0,        // 统计更新连续失败次数
            maxStatsFailures: 3,     // 最大统计失败次数
            statsInterval: null,     // 统计更新定时器
            isServerOffline: false   // 服务器是否离线
        };

        // ===== 工具函數: Fetch with Timeout =====
        /**
         * 带超时的 fetch 请求
         * @param {string} url - 请求 URL
         * @param {object} options - fetch 选项
         * @param {number} timeout - 超时时间(毫秒),默认 10 秒
         * @returns {Promise<Response>}
         */
        function fetchWithTimeout(url, options = {}, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            return fetch(url, {
                ...options,
                signal: controller.signal
            }).then(response => {
                clearTimeout(timeoutId);
                return response;
            }).catch(error => {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`请求超时 (${timeout}ms): ${url}`);
                }
                throw error;
            });
        }

        // ===== SSE 重連延遲計算 (指數退避) =====
        function getSseRetryDelay() {
            // 5s, 10s, 20s, 40s, 80s
            const baseDelay = 5000;
            const delay = baseDelay * Math.pow(2, connectionState.sseRetries);
            return Math.min(delay, 80000); // 最大 80 秒
        }

        const logContainer = document.getElementById('logContainer');
        const emptyState = document.getElementById('emptyState');
        const statusDot = document.getElementById('statusDot');
        const autoScrollCheckbox = document.getElementById('autoScroll');

        // 检查认证状态
        async function checkAuth() {
            try {
                const response = await fetchWithTimeout('/admin/verify', {
                    credentials: 'include'
                }, 5000);  // 5 秒超时
                const data = await response.json();

                if (!data.authenticated) {
                    // 未登录，重定向到 admin 页面
                    window.location.href = '/admin/?redirect=logs';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('认证检查失败:', error);

                // 区分超时错误和其他错误
                if (error.message.includes('请求超时')) {
                    showServerOfflinePanel('认证服务无响应', '无法连接到服务器,请检查服务器是否正在运行');
                } else {
                    alert('认证失败，请先登录\n\n将跳转到管理页面...');
                    window.location.href = '/admin/';
                }
                return false;
            }
        }

        // 连接 SSE (带重连策略和指数退避)
        function connectSSE() {
            // 检查是否已达到最大重试次数
            if (connectionState.sseRetries >= connectionState.maxSseRetries) {
                console.error('❌ SSE 连接已达到最大重试次数,停止重连');
                connectionState.isServerOffline = true;
                showServerOfflinePanel('日志流连接失败', `已重试 ${connectionState.sseRetries} 次,服务器可能已离线`);
                return;
            }

            if (connectionState.sseRetries > 0) {
                console.log(`🔄 SSE 连接尝试 ${connectionState.sseRetries + 1}/${connectionState.maxSseRetries}`);
            }

            eventSource = new EventSource('/admin/logs/stream', { withCredentials: true });

            eventSource.onopen = () => {
                console.log('✅ SSE 连接已建立');
                statusDot.classList.remove('disconnected');

                // 连接成功,重置重试计数器
                connectionState.sseRetries = 0;

                // 如果之前標記為離線,現在恢復在線
                if (connectionState.isServerOffline) {
                    connectionState.isServerOffline = false;
                    hideServerOfflinePanel();
                    // 重新启动统计更新
                    if (!connectionState.statsInterval) {
                        connectionState.statsInterval = setInterval(updateStats, 3000);
                    }
                    // 重置统计失败计数器
                    connectionState.statsFailures = 0;
                }
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'connected') {
                        console.log('日志流已连接');
                        return;
                    }
                    if (!isPaused) {
                        addLog(data);
                    }
                } catch (error) {
                    console.error('解析日志失败:', error);
                }
            };

            eventSource.onerror = (error) => {
                console.error('❌ SSE 连接错误:', error);
                statusDot.classList.add('disconnected');

                // 检查连接状态 (在关闭之前)
                const isClosed = eventSource && eventSource.readyState === EventSource.CLOSED;

                // 增加重试计数器
                connectionState.sseRetries++;

                // 关闭当前连接
                if (eventSource) {
                    try {
                        eventSource.close();
                    } catch (e) {
                        console.warn('关闭 SSE 连接时出错:', e);
                    }
                    eventSource = null;
                }

                // 检查是否已达到最大重试次数
                if (connectionState.sseRetries >= connectionState.maxSseRetries) {
                    connectionState.isServerOffline = true;
                    showServerOfflinePanel('日志流连接失败', `已重试 ${connectionState.sseRetries} 次,服务器可能已离线`);
                    return;
                }

                // 使用指數退避重連
                const retryDelay = getSseRetryDelay();
                console.log(`🔄 将在 ${(retryDelay / 1000).toFixed(1)} 秒后重连 (第 ${connectionState.sseRetries}/${connectionState.maxSseRetries} 次)`);

                // 如果连接已关闭,重新检查认证
                if (isClosed) {
                    console.log('⚠️ 连接已关闭，检查认证状态...');
                    checkAuth().then(isAuth => {
                        if (isAuth) {
                            // 如果仍然认证有效,延遲後重連
                            setTimeout(connectSSE, retryDelay);
                        } else {
                            // 认证失效,不再重连
                            console.error('❌ 认证失效,停止重连');
                            connectionState.isServerOffline = true;
                        }
                    }).catch(() => {
                        // 认证检查失败,仍尝试重连 (可能是网络问题)
                        setTimeout(connectSSE, retryDelay);
                    });
                } else {
                    // 其他错误,直接重连
                    setTimeout(connectSSE, retryDelay);
                }
            };
        }

        // 添加日志（用于 SSE 新日志）
        function addLog(log) {
            // 标记为新日志
            log._isNew = true;
            logs.unshift(log);
            if (logs.length > 500) {
                logs = logs.slice(0, 500);  // 只保留最新 500 条
            }
            renderLogs();
        }

        // 渲染日志
        function renderLogs() {
            const filtered = filterLogs();

            if (filtered.length === 0) {
                emptyState.style.display = 'block';
                logContainer.querySelectorAll('.log-entry').forEach(el => el.remove());
                return;
            }

            emptyState.style.display = 'none';

            // 🔧 修復：記錄當前展開的詳情面板
            const expandedLogs = new Set();
            logContainer.querySelectorAll('.log-entry').forEach(entry => {
                const detailsPanel = entry.querySelector('.log-details');
                if (detailsPanel && detailsPanel.classList.contains('expanded')) {
                    const logId = entry.dataset.logId;
                    if (logId) {
                        expandedLogs.add(logId);
                    }
                }
            });

            // 清空并重新渲染（简单实现，可优化为增量更新）
            logContainer.querySelectorAll('.log-entry').forEach(el => el.remove());

            filtered.forEach(log => {
                // 检查是否为新日志（从 SSE 接收的）
                const isNew = log._isNew === true;
                const entry = createLogEntry(log, isNew);
                // 清除标记
                if (isNew) {
                    delete log._isNew;
                }

                // 🔧 修復：恢復展開狀態
                const logId = entry.dataset.logId;
                if (logId && expandedLogs.has(logId)) {
                    const detailsPanel = entry.querySelector('.log-details');
                    const toggleButton = entry.querySelector('.log-details-toggle');
                    if (detailsPanel) {
                        detailsPanel.classList.add('expanded');
                    }
                    if (toggleButton) {
                        toggleButton.textContent = '🔼 收起';
                    }
                }

                logContainer.appendChild(entry);
            });

            // 自动滚动
            if (autoScrollCheckbox.checked) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            document.getElementById('displayCount').textContent = filtered.length;
        }

        // 创建日志条目
        function createLogEntry(log, isNew = false) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${log.level}${isNew ? ' new' : ''}`;

            // 🔧 修復：為每個日誌條目生成唯一 ID（用於追蹤展開狀態）
            const logId = `${log.timestamp}_${log.level}_${(log.message || '').substring(0, 50)}`;
            entry.dataset.logId = logId;

            const timestamp = new Date(log.timestamp).toLocaleTimeString('zh-CN', { hour12: false });
            const logType = (log.type || log.log_type || log.category || '').toString();
            const ip = ((log.details && (log.details.client_ip || log.details.ip)) || log.client_ip || '').toString();

            // 检查是否为错误日志（需要显示详情按钮）
            const isError = (
                log.level === 'error' ||
                log.level === 'warning' ||
                (log.details && log.details.status_code >= 400) ||
                (log.details && (log.details.traceback || log.details.error_hint || log.details.request_headers))
            );

            let html = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-level ${log.level}">${log.level}</span>
                <span class="log-type">${logType}</span>
                ${ip ? `<span class=\"log-ip\">${ip}</span>` : ''}
                <span class="log-message">${escapeHtml(log.message)}</span>
            `;

            if (log.duration_ms !== null && log.duration_ms !== undefined) {
                html += `<span class="log-duration">${log.duration_ms.toFixed(0)}ms</span>`;
            }

            // 如果是错误，添加「查看详情」按钮
            if (isError) {
                html += `<span class="log-details-toggle" onclick="toggleLogDetails(this)">🔍 详情</span>`;
            }

            entry.innerHTML = html;

            // 如果是错误，添加详情面板
            if (isError) {
                const detailsPanel = createLogDetailsPanel(log);
                entry.appendChild(detailsPanel);
            }

            // 只有新日志才移除动画类
            if (isNew) {
                setTimeout(() => entry.classList.remove('new'), 300);
            }

            return entry;
        }

        // 創建日誌詳情面板
        function createLogDetailsPanel(log) {
            const panel = document.createElement('div');
            panel.className = 'log-details';

            let detailsHtml = '';

            // 错误提示
            if (log.details && log.details.error_hint) {
                detailsHtml += `
                    <div class="log-details-hint">
                        ⚠️ ${escapeHtml(log.details.error_hint)}
                    </div>
                `;
            }

            // 错误信息
            if (log.details && log.details.error) {
                detailsHtml += `
                    <div class="log-details-section">
                        <div class="log-details-title">❌ 错误信息</div>
                        <div class="log-details-error">
                            <strong>${escapeHtml(log.details.error_type || 'Error')}</strong>: ${escapeHtml(log.details.error)}
                        </div>
                    </div>
                `;
            }

            // 请求信息
            if (log.details) {
                // 请求 Headers
                if (log.details.request_headers) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">📤 请求 Headers</div>
                            <div class="log-details-content">${escapeHtml(JSON.stringify(log.details.request_headers, null, 2))}</div>
                        </div>
                    `;
                }

                // 请求 Query 参数
                if (log.details.request_query && Object.keys(log.details.request_query).length > 0) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">🔗 Query 參數</div>
                            <div class="log-details-content">${escapeHtml(JSON.stringify(log.details.request_query, null, 2))}</div>
                        </div>
                    `;
                }

                // 请求 Body
                if (log.details.request_body) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">📝 请求 Body</div>
                            <div class="log-details-content">${escapeHtml(log.details.request_body)}</div>
                        </div>
                    `;
                }

                // 响应 Headers
                if (log.details.response_headers) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">📥 响应 Headers</div>
                            <div class="log-details-content">${escapeHtml(JSON.stringify(log.details.response_headers, null, 2))}</div>
                        </div>
                    `;
                }

                // 错误堆栈
                if (log.details.traceback) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">🐛 错误堆栈</div>
                            <div class="log-details-content">${escapeHtml(log.details.traceback)}</div>
                        </div>
                    `;
                }
            }

            // 如果没有任何详情，显示提示
            if (!detailsHtml) {
                detailsHtml = `
                    <div class="log-details-hint">
                        ℹ️ 没有可用的详细信息
                    </div>
                `;
            }

            panel.innerHTML = detailsHtml;
            return panel;
        }

        // 切換日誌詳情展開/收起
        function toggleLogDetails(button) {
            const logEntry = button.closest('.log-entry');
            const detailsPanel = logEntry.querySelector('.log-details');

            if (detailsPanel) {
                detailsPanel.classList.toggle('expanded');

                // 更新按鈕文本
                if (detailsPanel.classList.contains('expanded')) {
                    button.textContent = '🔼 收起';
                } else {
                    button.textContent = '🔍 详情';
                }
            }
        }

        // 过滤日志
        function filterLogs() {
            const now = new Date();

            return logs.filter(log => {
                // 时间范围过滤
                if (filters.timeRange !== 'all') {
                    const logTime = new Date(log.timestamp);
                    const diffMs = now - logTime;

                    switch (filters.timeRange) {
                        case '5m':
                            if (diffMs > 5 * 60 * 1000) return false;
                            break;
                        case '1h':
                            if (diffMs > 60 * 60 * 1000) return false;
                            break;
                        case 'today':
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            if (logTime < today) return false;
                            break;
                        case '24h':
                            if (diffMs > 24 * 60 * 60 * 1000) return false;
                            break;
                    }
                }

                // 持续时间过滤（慢请求）
                if (filters.duration !== 'all' && log.duration_ms !== null && log.duration_ms !== undefined) {
                    const duration = log.duration_ms;
                    switch (filters.duration) {
                        case 'fast':
                            if (duration >= 100) return false;
                            break;
                        case 'medium':
                            if (duration < 100 || duration >= 500) return false;
                            break;
                        case 'slow':
                            if (duration < 500) return false;
                            break;
                        case 'veryslow':
                            if (duration < 1000) return false;
                            break;
                    }
                } else if (filters.duration !== 'all' && (log.duration_ms === null || log.duration_ms === undefined)) {
                    // 如果选择了持续时间过滤，但日志没有 duration_ms，則过滤掉
                    return false;
                }

                // IP 地址过滤
                if (filters.ipFilter) {
                    const ip = ((log.details && (log.details.client_ip || log.details.ip)) || log.client_ip || '').toString();
                    if (!ip.includes(filters.ipFilter)) {
                        return false;
                    }
                }

                // 端点路径过滤
                if (filters.pathFilter) {
                    const path = (
                        (log.details && (log.details.path || log.details.url)) ||
                        ((log.message || '').split(' ')[1]) ||
                        ''
                    ).toString().toLowerCase();
                    if (!path.includes(filters.pathFilter.toLowerCase())) {
                        return false;
                    }
                }

                // 级别过滤
                if (filters.level !== 'all' && log.level !== filters.level) {
                    return false;
                }

                // 类型过滤（支持多选）
                if (filters.types.length > 0) {
                    const logType = (log.type || log.log_type || log.category || '').toString().toLowerCase();

                    // 检查日志类型是否在选中的类型列表中
                    let matchedType = filters.types.includes(logType);

                    // 如果直接匹配失败，尝试端点映射
                    if (!matchedType) {
                        const path = (
                            (log.details && (log.details.path || log.details.url)) ||
                            ((log.message || '').split(' ')[1]) ||
                            ''
                        ).toString();

                        // 对每个选中的类型进行映射检查
                        for (const selectedType of filters.types) {
                            if (selectedType === 'email_gen' && path.includes('/api/email/generate')) {
                                matchedType = true;
                                break;
                            }
                            if (selectedType === 'code_extract' && path.includes('/codes')) {
                                matchedType = true;
                                break;
                            }
                            if (selectedType === 'llm_call' && (path.includes('/codes') || path.includes('/llm'))) {
                                matchedType = true;
                                break;
                            }
                        }
                    }

                    if (!matchedType) {
                        return false;
                    }
                }

                // 方法过滤
                const method = ((log.details && (log.details.method || log.details.http_method)) || log.method || ((log.message || '').split(' ')[0] || '')).toString().toUpperCase();
                if (filters.method !== 'all' && method !== filters.method) {
                    return false;
                }

                // 隐藏统计请求
                if (filters.hideStats) {
                    const msg = (log.message || '').toString();
                    const path = (log.details && (log.details.path || log.details.url || '')) || '';
                    if (msg.includes('/admin/logs/stats') || path.includes('/admin/logs/stats')) {
                        return false;
                    }
                }

                // 关键字过滤
                if (filters.keyword) {
                    const keyword = filters.keyword.toLowerCase();
                    const searchText = (log.message + JSON.stringify(log.details || {})).toLowerCase();
                    if (!searchText.includes(keyword)) {
                        return false;
                    }
                }

                return true;
            });
        }

        // 载入历史日志
        async function loadHistoryLogs() {
            try {
                const response = await fetchWithTimeout('/admin/logs/history?limit=500', {
                    credentials: 'include'
                }, 8000);  // 8 秒超时 (历史日志可能较大)

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.logs.length > 0) {
                        // 将历史日志添加到数组（不触发动画）
                        logs = data.logs;
                        console.log(`✅ 载入了 ${logs.length} 条历史日志`);
                        renderLogs();
                        updateStats();
                    }
                }
            } catch (error) {
                console.error('载入历史日志失败:', error);
                // 历史日志失败不应阻止页面使用,只记录错误
                if (error.message.includes('请求超时')) {
                    console.warn('⚠️ 历史日志载入超时,跳过历史数据');
                }
            }
        }

        // 更新统计
        async function updateStats() {
            document.getElementById('totalCount').textContent = logs.length;

            try {
                // 获取订阅者数量（从后端）
                const res = await fetchWithTimeout('/admin/logs/stats', {
                    credentials: 'include'
                }, 5000);  // 5 秒超时

                const contentType = res.headers.get('content-type');

                // 如果是 JSON 响应
                if (contentType && contentType.includes('application/json')) {
                    const data = await res.json();

                    // HTTP 状态码成功（200-299）
                    if (res.ok) {
                        if (data.success) {
                            // ✅ 正常统计 - 重置失败计数器
                            connectionState.statsFailures = 0;

                            document.getElementById('subscriberCount').textContent = data.stats.subscribers;
                            document.getElementById('uniqueIpCount').textContent = data.stats.unique_ips || 0;

                            // 清除可能的错误提示
                            const existingError = document.getElementById('statsError');
                            if (existingError) {
                                existingError.remove();
                            }
                        } else {
                            // 统计服务内部错误（但 HTTP 200）
                            console.warn('统计服务内部错误:', data);
                            handleStatsFailure('统计服务部分功能异常', data.error || data.message);
                        }
                    } else {
                        // HTTP 错误状态码（4xx, 5xx）
                        const errorMsg = data.detail || data.error || data.message || '未知错误';
                        console.error(`统计 API 错误 (HTTP ${res.status}):`, data);

                        // 提取详细错误信息
                        let errorDetail = '';
                        if (typeof data.detail === 'object') {
                            errorDetail = data.detail.error_detail || data.detail.error || JSON.stringify(data.detail);
                        } else {
                            errorDetail = errorMsg;
                        }

                        handleStatsFailure(
                            `统计 API 错误 (HTTP ${res.status})`,
                            errorDetail
                        );
                    }
                } else {
                    // 非 JSON 响应（可能是 HTML 错误页面）
                    const text = await res.text();
                    console.error(`统计 API 返回非 JSON 响应 (HTTP ${res.status}):`, text.substring(0, 500));
                    handleStatsFailure(
                        `统计 API 错误 (HTTP ${res.status})`,
                        '服务器返回非 JSON 响应'
                    );
                }
            } catch (err) {
                // 网络错误或超時
                console.error('获取统计失败:', err);

                const errorMsg = err.message.includes('请求超时')
                    ? '统计服务请求超时'
                    : '网络错误';

                handleStatsFailure(errorMsg, err.message);
            }
        }

        // 处理统计更新失败
        function handleStatsFailure(title, detail) {
            connectionState.statsFailures++;

            console.warn(`⚠️ 统计失败次数: ${connectionState.statsFailures}/${connectionState.maxStatsFailures}`);

            if (connectionState.statsFailures >= connectionState.maxStatsFailures) {
                // 达到最大失败次数,停止定时更新
                if (connectionState.statsInterval) {
                    clearInterval(connectionState.statsInterval);
                    connectionState.statsInterval = null;
                    console.error('❌ 统计服务连续失败,已停止自动更新');
                }

                // 标记服务器离线并显示提示
                connectionState.isServerOffline = true;
                showServerOfflinePanel('统计服务无响应', detail);
            } else {
                // 尚未达到最大失败次数,显示警告
                showStatsError(title, detail, `连续失败 ${connectionState.statsFailures} 次,再失败 ${connectionState.maxStatsFailures - connectionState.statsFailures} 次将停止更新`);
            }
        }

        // 显示统计错误提示
        function showStatsError(title, errorDetail, hint) {
            // 移除旧的错误提示
            const existingError = document.getElementById('statsError');
            if (existingError) {
                existingError.remove();
            }

            // 创建错误提示元素
            const errorDiv = document.createElement('div');
            errorDiv.id = 'statsError';
            errorDiv.style.cssText = `
                background: #7f1d1d;
                border: 1px solid #ef4444;
                color: #fca5a5;
                padding: 12px 16px;
                margin: 12px 24px;
                border-radius: 6px;
                font-size: 13px;
                font-family: 'Monaco', 'Courier New', monospace;
                line-height: 1.5;
            `;

            errorDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">⚠️ ${escapeHtml(title)}</div>
                ${hint ? `<div style="margin-bottom: 6px; color: #fbbf24;">${escapeHtml(hint)}</div>` : ''}
                <details style="margin-top: 8px;">
                    <summary style="cursor: pointer; user-select: none;">🔍 查看详细错误</summary>
                    <pre style="margin-top: 8px; padding: 8px; background: #18181b; border: 1px solid #27272a; border-radius: 4px; overflow-x: auto; font-size: 11px; color: #e4e4e7;">${escapeHtml(errorDetail)}</pre>
                </details>
            `;

            // 插入到统计栏下方
            const statsDiv = document.getElementById('stats');
            if (statsDiv && statsDiv.nextSibling) {
                statsDiv.parentNode.insertBefore(errorDiv, statsDiv.nextSibling);
            } else if (statsDiv) {
                statsDiv.parentNode.appendChild(errorDiv);
            } else {
                // 如果找不到 stats div，插入到日誌容器前
                const logContainer = document.getElementById('logContainer');
                if (logContainer) {
                    logContainer.parentNode.insertBefore(errorDiv, logContainer);
                }
            }
        }

        // ===== 服务器离线面板控制 =====
        const serverOfflineOverlay = document.getElementById('serverOfflineOverlay');

        /**
         * 显示服务器离线提示面板
         * @param {string} title - 标题
         * @param {string} details - 详细信息
         */
        function showServerOfflinePanel(title, details) {
            const offlineTitle = document.getElementById('offlineTitle');
            const offlineMessage = document.getElementById('offlineMessage');
            const offlineDetailsEl = document.getElementById('offlineDetails');

            if (offlineTitle) offlineTitle.textContent = title || '服务器连接失败';
            if (offlineMessage) offlineMessage.textContent = '无法连接到日志服务器，请检查服务器是否正在运行。';
            if (offlineDetailsEl) {
                offlineDetailsEl.innerHTML = `<strong>详细信息:</strong><br>${escapeHtml(details || '服务器可能已离线或网络连接中断')}`;
            }

            serverOfflineOverlay.classList.add('active');
            console.error('🚨 服务器离线面板已显示:', title, details);
        }

        /**
         * 隐藏服务器离线提示面板
         */
        function hideServerOfflinePanel() {
            serverOfflineOverlay.classList.remove('active');
            console.log('✅ 服务器离线面板已隐藏');
        }

        // 绑定重新连接按钮
        document.getElementById('btnReconnect').addEventListener('click', () => {
            console.log('🔄 用户点击重新连接');
            hideServerOfflinePanel();

            // 重置连接状态
            connectionState.sseRetries = 0;
            connectionState.statsFailures = 0;
            connectionState.isServerOffline = false;

            // 关闭现有 SSE 连接
            if (eventSource) {
                try {
                    eventSource.close();
                } catch (e) {
                    console.warn('關閉 SSE 時出錯:', e);
                }
                eventSource = null;
            }

            // 重新连接
            connectSSE();

            // 重新启动统计更新
            if (!connectionState.statsInterval) {
                connectionState.statsInterval = setInterval(updateStats, 3000);
            }
            updateStats();
        });

        // 绑定刷新页面按钮
        document.getElementById('btnReloadPage').addEventListener('click', () => {
            console.log('↻ 用户点击刷新页面');
            window.location.reload();
        });

        // 过滤器事件
        document.querySelectorAll('[data-level]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('[data-level]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filters.level = pill.dataset.level;
                renderLogs();
            });
        });

        // 日志类型多选事件
        document.querySelectorAll('[data-type]').forEach(pill => {
            pill.addEventListener('click', () => {
                const type = pill.dataset.type;

                if (type === 'all') {
                    // 点击"全部"：清空所有选择，只选中"全部"
                    filters.types = [];
                    document.querySelectorAll('[data-type]').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                } else {
                    // 点击具体类型：切换选中状态
                    const allPill = document.querySelector('[data-type="all"]');
                    allPill.classList.remove('active');  // 取消"全部"的选中

                    if (pill.classList.contains('active')) {
                        // 已选中，取消选中
                        pill.classList.remove('active');
                        filters.types = filters.types.filter(t => t !== type);

                        // 如果没有任何选中，自动选中"全部"
                        if (filters.types.length === 0) {
                            allPill.classList.add('active');
                        }
                    } else {
                        // 未选中，添加到选中列表
                        pill.classList.add('active');
                        filters.types.push(type);
                    }
                }

                renderLogs();
            });
        });

        // 方法过滤事件
        document.querySelectorAll('[data-method]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('[data-method]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filters.method = pill.dataset.method;
                renderLogs();
            });
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            filters.keyword = e.target.value;
            renderLogs();
        });

        // 隐藏统计请求切换
        const hideStatsCheckbox = document.getElementById('hideStats');
        hideStatsCheckbox.addEventListener('change', () => {
            filters.hideStats = hideStatsCheckbox.checked;
            renderLogs();
        });

        // 🎯 快速预设过滤器
        document.querySelectorAll('[data-preset]').forEach(pill => {
            pill.addEventListener('click', () => {
                const preset = pill.dataset.preset;

                // 重置所有过滤器到默认状态
                function resetAllFilters() {
                    filters.level = 'all';
                    filters.types = [];
                    filters.method = 'all';
                    filters.timeRange = 'all';
                    filters.duration = 'all';
                    filters.pathFilter = '';
                    filters.ipFilter = '';
                    filters.keyword = '';

                    // 重置 UI
                    document.querySelectorAll('[data-level]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-level="all"]').classList.add('active');

                    document.querySelectorAll('[data-type]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-type="all"]').classList.add('active');

                    document.querySelectorAll('[data-method]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-method="all"]').classList.add('active');

                    document.querySelectorAll('[data-timerange]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-timerange="all"]').classList.add('active');

                    document.querySelectorAll('[data-duration]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-duration="all"]').classList.add('active');

                    document.getElementById('pathFilter').value = '';
                    document.getElementById('ipFilter').value = '';
                    document.getElementById('searchInput').value = '';
                }

                // 更新预设按钮状态
                document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');

                filters.preset = preset;

                switch (preset) {
                    case 'all':
                        // 全部：重置所有过滤器
                        resetAllFilters();
                        break;

                    case 'errors':
                        // 仅错误：显示 error 和 warning 级别
                        resetAllFilters();
                        filters.level = 'error';
                        document.querySelectorAll('[data-level]').forEach(p => p.classList.remove('active'));
                        document.querySelector('[data-level="error"]').classList.add('active');
                        break;

                    case 'slow':
                        // 慢请求：持续时间 > 500ms
                        resetAllFilters();
                        filters.duration = 'slow';
                        document.querySelectorAll('[data-duration]').forEach(p => p.classList.remove('active'));
                        document.querySelector('[data-duration="slow"]').classList.add('active');
                        break;

                    case 'recent':
                        // 最近 5 分钟
                        resetAllFilters();
                        filters.timeRange = '5m';
                        document.querySelectorAll('[data-timerange]').forEach(p => p.classList.remove('active'));
                        document.querySelector('[data-timerange="5m"]').classList.add('active');
                        break;
                }

                renderLogs();
            });
        });

        // ⏰ 时间范围过滤器
        document.querySelectorAll('[data-timerange]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('[data-timerange]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filters.timeRange = pill.dataset.timerange;

                // 如果不是 "all"，則取消快速预设
                if (filters.timeRange !== 'all') {
                    document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-preset="all"]').classList.add('active');
                    filters.preset = 'all';
                }

                renderLogs();
            });
        });

        // ⏱️ 持续时间过滤器
        document.querySelectorAll('[data-duration]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('[data-duration]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filters.duration = pill.dataset.duration;

                // 如果不是 "all"，則取消快速预设
                if (filters.duration !== 'all') {
                    document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-preset="all"]').classList.add('active');
                    filters.preset = 'all';
                }

                renderLogs();
            });
        });

        // 🎯 端点路径过滤器
        document.getElementById('pathFilter').addEventListener('input', (e) => {
            filters.pathFilter = e.target.value;

            // 如果有輸入，則取消快速预设
            if (filters.pathFilter) {
                document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                document.querySelector('[data-preset="all"]').classList.add('active');
                filters.preset = 'all';
            }

            renderLogs();
        });

        // 🌐 IP 地址过滤器
        document.getElementById('ipFilter').addEventListener('input', (e) => {
            filters.ipFilter = e.target.value;

            // 如果有輸入，則取消快速预设
            if (filters.ipFilter) {
                document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                document.querySelector('[data-preset="all"]').classList.add('active');
                filters.preset = 'all';
            }

            renderLogs();
        });

        // 暂停/继续
        document.getElementById('pauseBtn').addEventListener('click', (e) => {
            isPaused = !isPaused;
            e.target.textContent = isPaused ? '▶️ 继续' : '⏸ 暂停';
        });

        // 清空日志
        document.getElementById('clearBtn').addEventListener('click', async () => {
            if (!confirm('确定要清空所有日志吗？')) return;

            try {
                const response = await fetchWithTimeout('/admin/logs/clear', {
                    method: 'POST',
                    credentials: 'include'
                }, 5000);  // 5 秒超时

                if (response.ok) {
                    logs = [];
                    renderLogs();
                    updateStats();
                }
            } catch (error) {
                alert('清空失败: ' + error.message);
            }
        });

        // 导出日志
        document.getElementById('exportBtn').addEventListener('click', () => {
            const filtered = filterLogs();
            const text = filtered.map(log => {
                const time = new Date(log.timestamp).toISOString();
                const logType = (log.type || log.log_type || log.category || '').toString();
                return `[${time}] [${log.level.toUpperCase()}] [${logType}] ${log.message}`;
            }).join('\n');

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // HTML 转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // IP 统计功能
        const ipStatsModal = document.getElementById('ipStatsModal');
        const ipStatsModalBody = document.getElementById('ipStatsModalBody');
        const ipStatsBtn = document.getElementById('ipStatsBtn');
        const closeIpStatsBtn = document.getElementById('closeIpStatsBtn');

        // 国家代码到国旗 emoji 的映射
        function getCountryFlag(countryCode) {
            if (!countryCode || countryCode === '-') return '🏳️';
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        // 打開 IP 统计弹窗
        async function openIpStats() {
            ipStatsModal.classList.add('active');
            ipStatsModalBody.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <div>正在加载 IP 统计数据...</div>
                </div>
            `;

            try {
                const response = await fetchWithTimeout('/admin/logs/ip-stats', {
                    credentials: 'include'
                }, 8000);  // 8 秒超时 (IP 统计可能需要较长时间)

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderIpStats(data);
                } else {
                    throw new Error(data.message || '获取 IP 统计失败');
                }
            } catch (error) {
                console.error('加载 IP 统计失败:', error);

                const errorMsg = error.message.includes('请求超时')
                    ? '⏱️ IP 统计请求超时,请稍后再试'
                    : error.message;

                ipStatsModalBody.innerHTML = `
                    <div class="error-message">
                        <strong>❌ 加载失败</strong><br>
                        ${errorMsg}
                    </div>
                `;
            }
        }

        // 渲染 IP 统计数据
        function renderIpStats(data) {
            const { total_ips, total_requests, ips, country_stats } = data;

            let html = `
                <!-- 统计摘要 -->
                <div class="ip-stats-summary">
                    <div class="summary-card">
                        <div class="summary-label">唯一 IP 数量</div>
                        <div class="summary-value">${total_ips}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">总请求次数</div>
                        <div class="summary-value">${total_requests}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">国家/地区</div>
                        <div class="summary-value">${Object.keys(country_stats || {}).length}</div>
                    </div>
                </div>
            `;

            // 国家统计
            if (country_stats && Object.keys(country_stats).length > 0) {
                html += `
                    <h3 style="margin-bottom: 12px; font-size: 16px;">🌏 按国家统计</h3>
                    <div class="country-stats-grid">
                `;

                for (const [country, count] of Object.entries(country_stats)) {
                    html += `
                        <div class="country-stat-item">
                            <span class="country-name">${country}</span>
                            <span class="country-count">${count} 次请求</span>
                        </div>
                    `;
                }

                html += `</div>`;
            }

            // IP 列表表格
            html += `
                <h3 style="margin: 24px 0 12px; font-size: 16px;">📍 IP 详细列表</h3>
                <div class="ip-table-container">
                    <table class="ip-table">
                        <thead>
                            <tr>
                                <th>IP 地址</th>
                                <th>国家/地区</th>
                                <th>省份</th>
                                <th>城市</th>
                                <th>ISP</th>
                                <th style="text-align: right;">请求次数</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            ips.forEach(item => {
                const flag = getCountryFlag(item.country_code);
                const status = item.status || 'unknown';
                const rowClass = status === 'success' ? '' : 'opacity: 0.6;';

                html += `
                    <tr style="${rowClass}">
                        <td><code>${item.ip}</code></td>
                        <td>
                            <span class="country-flag">${flag}</span>
                            ${item.country}
                        </td>
                        <td>${item.region || '-'}</td>
                        <td>${item.city || '-'}</td>
                        <td style="font-size: 12px; color: #a1a1aa;">${item.isp || '-'}</td>
                        <td style="text-align: right;">
                            <span class="request-count">${item.requests}</span>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            ipStatsModalBody.innerHTML = html;
        }

        // 关闭 IP 统计弹窗
        function closeIpStats() {
            ipStatsModal.classList.remove('active');
        }

        // 綁定事件
        ipStatsBtn.addEventListener('click', openIpStats);
        closeIpStatsBtn.addEventListener('click', closeIpStats);

        // 点击遮罩层关闭弹窗
        ipStatsModal.addEventListener('click', (e) => {
            if (e.target === ipStatsModal) {
                closeIpStats();
            }
        });

        // ESC 键关闭弹窗
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && ipStatsModal.classList.contains('active')) {
                closeIpStats();
            }
        });

        // ===== 资源清理机制 =====
        /**
         * 清理所有资源 (在页面卸载时调用)
         */
        function cleanup() {
            console.log('🧹 开始清理资源...');

            // 清理统计更新定时器
            if (connectionState.statsInterval) {
                clearInterval(connectionState.statsInterval);
                connectionState.statsInterval = null;
                console.log('✓ 统设定时器已清理');
            }

            // 关闭 SSE 连接
            if (eventSource) {
                try {
                    eventSource.close();
                    eventSource = null;
                    console.log('✓ SSE 连接已关闭');
                } catch (e) {
                    console.warn('关闭 SSE 时出错:', e);
                }
            }

            console.log('✅ 资源清理完成');
        }

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            cleanup();
        });

        // 页面隐藏时也清理 (适用于移动设备或标签切换)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('⏸ 页面已隐藏,清理资源');
                cleanup();
            } else {
                console.log('▶️ 页面已显示,检查连接状态');
                // 如果页面重新显示且服务器离线,不自动重连
                if (!connectionState.isServerOffline && !eventSource) {
                    console.log('🔄 重新连接 SSE...');
                    connectSSE();
                }
                // 重新启动统计更新
                if (!connectionState.statsInterval && !connectionState.isServerOffline) {
                    connectionState.statsInterval = setInterval(updateStats, 3000);
                    updateStats();
                }
            }
        });

        // 初始化
        async function init() {
            // 先检查认证
            const isAuth = await checkAuth();
            if (!isAuth) {
                return; // 未认证，已重定向
            }

            // 显示客户端 IP
            try {
                const who = await fetchWithTimeout('/admin/whoami', {
                    credentials: 'include'
                }, 3000);  // 3 秒超时
                if (who.ok) {
                    const info = await who.json();
                    document.getElementById('clientIp').textContent = info.ip || '-';
                }
            } catch (e) {
                // 客户端 IP 获取失败不影响功能
                console.warn('⚠️ 无法获取客户端 IP:', e.message);
            }

            // 先载入历史日志
            await loadHistoryLogs();
            // 然后连接 SSE 接收新日志
            connectSSE();
            // 更新统计
            updateStats();
            // 每 3 秒更新一次统计 (保存到 connectionState)
            connectionState.statsInterval = setInterval(updateStats, 3000);
        }

        // 启动
        init();
    </script>
</body>
</html>
