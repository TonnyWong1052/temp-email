<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶æ—¥å¿—ç›‘æ§ - ä¸´æ—¶é‚®ç®±æœåŠ¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: #0f1419;
            color: #e4e4e7;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: #18181b;
            border-bottom: 1px solid #27272a;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #27272a;
            color: #e4e4e7;
            border: 1px solid #3f3f46;
        }

        .btn-secondary:hover {
            background: #3f3f46;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .filters {
            background: #18181b;
            border-bottom: 1px solid #27272a;
            padding: 16px 24px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #a1a1aa;
        }

        .filter-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pill {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #3f3f46;
            background: #18181b;
            color: #a1a1aa;
        }

        .pill:hover {
            background: #27272a;
            color: #e4e4e7;
        }

        .pill.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #3f3f46;
            background: #18181b;
            color: #e4e4e7;
            font-size: 13px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .stats {
            background: #18181b;
            border-bottom: 1px solid #27272a;
            padding: 12px 24px;
            display: flex;
            gap: 24px;
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #a1a1aa;
        }

        .stat-value {
            color: #3b82f6;
            font-weight: 600;
        }

        .log-container {
            padding: 16px 24px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .log-entry:hover {
            background: #18181b;
        }

        .log-entry.new {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-entry.debug { border-left-color: #6b7280; }
        .log-entry.info { border-left-color: #3b82f6; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .log-entry.error { border-left-color: #ef4444; }
        .log-entry.success { border-left-color: #10b981; }

        .log-timestamp {
            color: #6b7280;
            min-width: 90px;
            flex-shrink: 0;
        }

        .log-level {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            min-width: 60px;
            text-align: center;
            flex-shrink: 0;
        }

        .log-level.debug { background: #374151; color: #9ca3af; }
        .log-level.info { background: #1e40af; color: #93c5fd; }
        .log-level.warning { background: #92400e; color: #fbbf24; }
        .log-level.error { background: #7f1d1d; color: #fca5a5; }
        .log-level.success { background: #065f46; color: #6ee7b7; }

        .log-type {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            background: #27272a;
            color: #a1a1aa;
            min-width: 80px;
            text-align: center;
            flex-shrink: 0;
        }

        .log-message {
            flex: 1;
            color: #e4e4e7;
            word-break: break-word;
        }

        .log-duration {
            color: #6b7280;
            font-size: 11px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .log-ip {
            color: #a1a1aa;
            font-size: 11px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 3px;
            padding: 2px 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 80px 24px;
            color: #71717a;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        #autoScroll:checked + label,
        #hideStats:checked + label {
            background: #3b82f6;
            color: white;
        }

        /* IP ç»Ÿè®¡å¼¹çª—æ¨£å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #18181b;
            border: 1px solid #3f3f46;
            border-radius: 12px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #27272a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: #27272a;
            border: 1px solid #3f3f46;
            color: #e4e4e7;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #3f3f46;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .ip-stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: #0f1419;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 16px;
        }

        .summary-label {
            font-size: 12px;
            color: #a1a1aa;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 600;
            color: #3b82f6;
        }

        .ip-table-container {
            overflow-x: auto;
        }

        .ip-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .ip-table th {
            background: #0f1419;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #3f3f46;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .ip-table td {
            padding: 12px;
            border-bottom: 1px solid #27272a;
        }

        .ip-table tr:hover {
            background: #0f1419;
        }

        .country-flag {
            display: inline-block;
            margin-right: 8px;
            font-size: 16px;
        }

        .request-count {
            background: #1e40af;
            color: #93c5fd;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #a1a1aa;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #3f3f46;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .country-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .country-stat-item {
            background: #0f1419;
            border: 1px solid #27272a;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .country-name {
            font-weight: 500;
        }

        .country-count {
            background: #065f46;
            color: #6ee7b7;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* éŒ¯èª¤è©³æƒ…æ¨£å¼ */
        .log-details-toggle {
            cursor: pointer;
            color: #3b82f6;
            font-size: 11px;
            margin-left: 8px;
            padding: 2px 8px;
            border: 1px solid #3b82f6;
            border-radius: 3px;
            background: transparent;
            transition: all 0.2s;
            user-select: none;
        }

        .log-details-toggle:hover {
            background: #3b82f6;
            color: white;
        }

        .log-details {
            display: none;
            margin-top: 8px;
            padding: 12px;
            background: #0f1419;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-details.expanded {
            display: block;
        }

        .log-details-section {
            margin-bottom: 12px;
        }

        .log-details-section:last-child {
            margin-bottom: 0;
        }

        .log-details-title {
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .log-details-content {
            background: #18181b;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #27272a;
            color: #e4e4e7;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
        }

        .log-details-hint {
            background: #92400e;
            border: 1px solid #f59e0b;
            color: #fbbf24;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .log-details-error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <span class="status-dot" id="statusDot"></span>
            <span>å®æ—¶æ—¥å¿—ç›‘æ§</span>
        </div>
        <div class="header-actions">
            <input type="checkbox" id="autoScroll" class="pill" checked hidden>
            <label for="autoScroll" class="pill">è‡ªåŠ¨æ»šåŠ¨</label>
            <button class="btn btn-secondary" id="pauseBtn">â¸ æš‚åœ</button>
            <button class="btn btn-primary" id="ipStatsBtn">ğŸŒ IP ç»Ÿè®¡</button>
            <button class="btn btn-secondary" id="exportBtn">ğŸ“¥ å¯¼å‡º</button>
            <button class="btn btn-danger" id="clearBtn">ğŸ—‘ æ¸…ç©º</button>
        </div>
    </div>

    <div class="filters">
        <!-- å¿«é€Ÿè¿‡æ»¤é¢„è®¾ -->
        <div class="filter-group">
            <div class="filter-label">ğŸ¯ å¿«é€Ÿè¿‡æ»¤</div>
            <div class="filter-pills">
                <div class="pill active" data-preset="all">å…¨éƒ¨</div>
                <div class="pill" data-preset="errors">ä»…é”™è¯¯</div>
                <div class="pill" data-preset="slow">æ…¢è¯·æ±‚</div>
                <div class="pill" data-preset="recent">æœ€è¿‘ 5 åˆ†é’Ÿ</div>
            </div>
        </div>

        <!-- æ—¥å¿—çº§åˆ« -->
        <div class="filter-group">
            <div class="filter-label">æ—¥å¿—çº§åˆ«</div>
            <div class="filter-pills">
                <div class="pill active" data-level="all">å…¨éƒ¨</div>
                <div class="pill" data-level="debug">Debug</div>
                <div class="pill" data-level="info">Info</div>
                <div class="pill" data-level="warning">Warning</div>
                <div class="pill" data-level="error">Error</div>
                <div class="pill" data-level="success">Success</div>
            </div>
        </div>

        <!-- æ—¥å¿—ç±»å‹ -->
        <div class="filter-group">
            <div class="filter-label">æ—¥å¿—ç±»å‹</div>
            <div class="filter-pills">
                <div class="pill active" data-type="all">å…¨éƒ¨</div>
                <div class="pill" data-type="request">è¯·æ±‚</div>
                <div class="pill" data-type="response">å“åº”</div>
                <div class="pill" data-type="email_gen">ç”Ÿæˆé‚®ç®±</div>
                <div class="pill" data-type="code_extract">æå–éªŒè¯ç </div>
                <div class="pill" data-type="llm_call">LLM è°ƒç”¨</div>
            </div>
        </div>

        <!-- è¯·æ±‚æ–¹æ³• -->
        <div class="filter-group">
            <div class="filter-label">è¯·æ±‚æ–¹æ³•</div>
            <div class="filter-pills">
                <div class="pill active" data-method="all">å…¨éƒ¨</div>
                <div class="pill" data-method="GET">GET</div>
                <div class="pill" data-method="POST">POST</div>
                <div class="pill" data-method="DELETE">DELETE</div>
                <div class="pill" data-method="PUT">PUT</div>
            </div>
        </div>

        <!-- æ—¶é—´èŒƒå›´ -->
        <div class="filter-group">
            <div class="filter-label">â° æ—¶é—´èŒƒå›´</div>
            <div class="filter-pills">
                <div class="pill active" data-timerange="all">å…¨éƒ¨</div>
                <div class="pill" data-timerange="5m">5 åˆ†é’Ÿ</div>
                <div class="pill" data-timerange="1h">1 å°æ—¶</div>
                <div class="pill" data-timerange="today">ä»Šå¤©</div>
                <div class="pill" data-timerange="24h">24 å°æ—¶</div>
            </div>
        </div>

        <!-- æŒç»­æ—¶é—´ï¼ˆæ…¢è¯·æ±‚ï¼‰ -->
        <div class="filter-group">
            <div class="filter-label">â±ï¸ æŒç»­æ—¶é—´</div>
            <div class="filter-pills">
                <div class="pill active" data-duration="all">å…¨éƒ¨</div>
                <div class="pill" data-duration="fast">&lt; 100ms</div>
                <div class="pill" data-duration="medium">100-500ms</div>
                <div class="pill" data-duration="slow">&gt; 500ms</div>
                <div class="pill" data-duration="veryslow">&gt; 1000ms</div>
            </div>
        </div>

        <!-- ç«¯ç‚¹è·¯å¾„ -->
        <div class="filter-group" style="min-width: 200px;">
            <div class="filter-label">ğŸ¯ ç«¯ç‚¹è·¯å¾„</div>
            <input type="text" class="search-input" id="pathFilter" placeholder="ä¾‹å¦‚: /api/email" style="width: 100%;">
        </div>

        <!-- IP åœ°å€ -->
        <div class="filter-group" style="min-width: 150px;">
            <div class="filter-label">ğŸŒ IP åœ°å€</div>
            <input type="text" class="search-input" id="ipFilter" placeholder="ä¾‹å¦‚: 192.168">
        </div>

        <!-- é«˜çº§è¿‡æ»¤ -->
        <div class="filter-group">
            <div class="filter-label">é«˜çº§è¿‡æ»¤</div>
            <div class="filter-pills">
                <input type="checkbox" id="hideStats" class="pill" checked hidden>
                <label for="hideStats" class="pill">éšè—ç»Ÿè®¡</label>
            </div>
        </div>

        <!-- å…³é”®å­—æœç´¢ -->
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœç´¢å…³é”®å­—...">
        </div>
    </div>

    <div class="stats" id="stats">
        <div class="stat-item">
            <span class="stat-label">æ€»è®¡:</span>
            <span class="stat-value" id="totalCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">æ˜¾ç¤º:</span>
            <span class="stat-value" id="displayCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">è®¢é˜…è€…:</span>
            <span class="stat-value" id="subscriberCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">ç‹¬ç«‹IP:</span>
            <span class="stat-value" id="uniqueIpCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">å½“å‰IP:</span>
            <span class="stat-value" id="clientIp">-</span>
        </div>
    </div>

    <div class="log-container" id="logContainer">
        <div class="empty-state" id="emptyState">
            <div class="empty-icon">ğŸ“‹</div>
            <div>ç­‰å¾…æ—¥å¿—...</div>
        </div>
    </div>

    <!-- IP ç»Ÿè®¡å¼¹çª— -->
    <div class="modal-overlay" id="ipStatsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span>ğŸŒ</span>
                    <span>IP åœ°ç†ä½ç½®</span>
                </div>
                <button class="modal-close" id="closeIpStatsBtn">âœ• å…³é—­</button>
            </div>
            <div class="modal-body" id="ipStatsModalBody">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨åŠ è½½ IP ç»Ÿè®¡æ•°æ®...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let logs = [];
        let isPaused = false;
        let filters = {
            preset: 'all',           // å¿«é€Ÿé¢„è®¾
            level: 'all',            // æ—¥å¿—çº§åˆ«
            types: [],               // æ—¥å¿—ç±»å‹ï¼ˆå¤šé€‰ï¼‰
            method: 'all',           // è¯·æ±‚æ–¹æ³•
            timeRange: 'all',        // æ—¶é—´èŒƒå›´
            duration: 'all',         // æŒç»­æ—¶é—´
            pathFilter: '',          // ç«¯ç‚¹è·¯å¾„è¿‡æ»¤
            ipFilter: '',            // IP åœ°å€è¿‡æ»¤
            keyword: '',             // å…³é”®å­—æœç´¢
            hideStats: true          // éšè—ç»Ÿè®¡è¯·æ±‚
        };

        const logContainer = document.getElementById('logContainer');
        const emptyState = document.getElementById('emptyState');
        const statusDot = document.getElementById('statusDot');
        const autoScrollCheckbox = document.getElementById('autoScroll');

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            try {
                const response = await fetch('/admin/verify', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.authenticated) {
                    // æœªç™»å½•ï¼Œé‡å®šå‘åˆ° admin é¡µé¢
                    window.location.href = '/admin/?redirect=logs';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
                alert('è®¤è¯å¤±è´¥ï¼Œè¯·å…ˆç™»å½•\n\nå°†è·³è½¬åˆ°ç®¡ç†é¡µé¢...');
                window.location.href = '/admin/';
                return false;
            }
        }

        // è¿æ¥ SSE
        function connectSSE() {
            eventSource = new EventSource('/admin/logs/stream', { withCredentials: true });

            eventSource.onopen = () => {
                console.log('SSE è¿æ¥å·²å»ºç«‹');
                statusDot.classList.remove('disconnected');
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'connected') {
                        console.log('æ—¥å¿—æµå·²è¿æ¥');
                        return;
                    }
                    if (!isPaused) {
                        addLog(data);
                    }
                } catch (error) {
                    console.error('è§£ææ—¥å¿—å¤±è´¥:', error);
                }
            };

            eventSource.onerror = (error) => {
                console.error('SSE è¿æ¥é”™è¯¯:', error);
                statusDot.classList.add('disconnected');
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºè®¤è¯é”™è¯¯
                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('è¿æ¥å·²å…³é—­ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±æ•ˆ');
                    // é‡æ–°æ£€æŸ¥è®¤è¯
                    checkAuth().then(isAuth => {
                        if (isAuth) {
                            // å¦‚æœä»ç„¶è®¤è¯æœ‰æ•ˆï¼Œ5ç§’å¾Œé‡é€£
                            setTimeout(connectSSE, 5000);
                        }
                    });
                } else {
                    // 5ç§’å¾Œé‡é€£
                    setTimeout(connectSSE, 5000);
                }
            };
        }

        // æ·»åŠ æ—¥å¿—ï¼ˆç”¨äº SSE æ–°æ—¥å¿—ï¼‰
        function addLog(log) {
            // æ ‡è®°ä¸ºæ–°æ—¥å¿—
            log._isNew = true;
            logs.unshift(log);
            if (logs.length > 500) {
                logs = logs.slice(0, 500);  // åªä¿ç•™æœ€æ–° 500 æ¡
            }
            renderLogs();
        }

        // æ¸²æŸ“æ—¥å¿—
        function renderLogs() {
            const filtered = filterLogs();

            if (filtered.length === 0) {
                emptyState.style.display = 'block';
                logContainer.querySelectorAll('.log-entry').forEach(el => el.remove());
                return;
            }

            emptyState.style.display = 'none';

            // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“ï¼ˆç®€å•å®ç°ï¼Œå¯ä¼˜åŒ–ä¸ºå¢é‡æ›´æ–°ï¼‰
            logContainer.querySelectorAll('.log-entry').forEach(el => el.remove());

            filtered.forEach(log => {
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ–°æ—¥å¿—ï¼ˆä» SSE æ¥æ”¶çš„ï¼‰
                const isNew = log._isNew === true;
                const entry = createLogEntry(log, isNew);
                // æ¸…é™¤æ ‡è®°
                if (isNew) {
                    delete log._isNew;
                }
                logContainer.appendChild(entry);
            });

            // è‡ªåŠ¨æ»šåŠ¨
            if (autoScrollCheckbox.checked) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            document.getElementById('displayCount').textContent = filtered.length;
        }

        // åˆ›å»ºæ—¥å¿—æ¡ç›®
        function createLogEntry(log, isNew = false) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${log.level}${isNew ? ' new' : ''}`;

            const timestamp = new Date(log.timestamp).toLocaleTimeString('zh-CN', { hour12: false });
            const logType = (log.type || log.log_type || log.category || '').toString();
            const ip = ((log.details && (log.details.client_ip || log.details.ip)) || log.client_ip || '').toString();

            // æª¢æŸ¥æ˜¯å¦ç‚ºéŒ¯èª¤æ—¥èªŒï¼ˆéœ€è¦é¡¯ç¤ºè©³æƒ…æŒ‰éˆ•ï¼‰
            const isError = (
                log.level === 'error' ||
                log.level === 'warning' ||
                (log.details && log.details.status_code >= 400) ||
                (log.details && (log.details.traceback || log.details.error_hint || log.details.request_headers))
            );

            let html = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-level ${log.level}">${log.level}</span>
                <span class="log-type">${logType}</span>
                ${ip ? `<span class=\"log-ip\">${ip}</span>` : ''}
                <span class="log-message">${escapeHtml(log.message)}</span>
            `;

            if (log.duration_ms !== null && log.duration_ms !== undefined) {
                html += `<span class="log-duration">${log.duration_ms.toFixed(0)}ms</span>`;
            }

            // å¦‚æœæ˜¯éŒ¯èª¤ï¼Œæ·»åŠ ã€ŒæŸ¥çœ‹è©³æƒ…ã€æŒ‰éˆ•
            if (isError) {
                html += `<span class="log-details-toggle" onclick="toggleLogDetails(this)">ğŸ” è©³æƒ…</span>`;
            }

            entry.innerHTML = html;

            // å¦‚æœæ˜¯éŒ¯èª¤ï¼Œæ·»åŠ è©³æƒ…é¢æ¿
            if (isError) {
                const detailsPanel = createLogDetailsPanel(log);
                entry.appendChild(detailsPanel);
            }

            // åªæœ‰æ–°æ—¥å¿—æ‰ç§»é™¤åŠ¨ç”»ç±»
            if (isNew) {
                setTimeout(() => entry.classList.remove('new'), 300);
            }

            return entry;
        }

        // å‰µå»ºæ—¥èªŒè©³æƒ…é¢æ¿
        function createLogDetailsPanel(log) {
            const panel = document.createElement('div');
            panel.className = 'log-details';

            let detailsHtml = '';

            // éŒ¯èª¤æç¤º
            if (log.details && log.details.error_hint) {
                detailsHtml += `
                    <div class="log-details-hint">
                        âš ï¸ ${escapeHtml(log.details.error_hint)}
                    </div>
                `;
            }

            // éŒ¯èª¤ä¿¡æ¯
            if (log.details && log.details.error) {
                detailsHtml += `
                    <div class="log-details-section">
                        <div class="log-details-title">âŒ éŒ¯èª¤ä¿¡æ¯</div>
                        <div class="log-details-error">
                            <strong>${escapeHtml(log.details.error_type || 'Error')}</strong>: ${escapeHtml(log.details.error)}
                        </div>
                    </div>
                `;
            }

            // è«‹æ±‚ä¿¡æ¯
            if (log.details) {
                // è«‹æ±‚ Headers
                if (log.details.request_headers) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">ğŸ“¤ è«‹æ±‚ Headers</div>
                            <div class="log-details-content">${escapeHtml(JSON.stringify(log.details.request_headers, null, 2))}</div>
                        </div>
                    `;
                }

                // è«‹æ±‚ Query åƒæ•¸
                if (log.details.request_query && Object.keys(log.details.request_query).length > 0) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">ğŸ”— Query åƒæ•¸</div>
                            <div class="log-details-content">${escapeHtml(JSON.stringify(log.details.request_query, null, 2))}</div>
                        </div>
                    `;
                }

                // è«‹æ±‚ Body
                if (log.details.request_body) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">ğŸ“ è«‹æ±‚ Body</div>
                            <div class="log-details-content">${escapeHtml(log.details.request_body)}</div>
                        </div>
                    `;
                }

                // éŸ¿æ‡‰ Headers
                if (log.details.response_headers) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">ğŸ“¥ éŸ¿æ‡‰ Headers</div>
                            <div class="log-details-content">${escapeHtml(JSON.stringify(log.details.response_headers, null, 2))}</div>
                        </div>
                    `;
                }

                // éŒ¯èª¤å †æ£§
                if (log.details.traceback) {
                    detailsHtml += `
                        <div class="log-details-section">
                            <div class="log-details-title">ğŸ› éŒ¯èª¤å †æ£§</div>
                            <div class="log-details-content">${escapeHtml(log.details.traceback)}</div>
                        </div>
                    `;
                }
            }

            // å¦‚æœæ²’æœ‰ä»»ä½•è©³æƒ…ï¼Œé¡¯ç¤ºæç¤º
            if (!detailsHtml) {
                detailsHtml = `
                    <div class="log-details-hint">
                        â„¹ï¸ æ²’æœ‰å¯ç”¨çš„è©³ç´°ä¿¡æ¯
                    </div>
                `;
            }

            panel.innerHTML = detailsHtml;
            return panel;
        }

        // åˆ‡æ›æ—¥èªŒè©³æƒ…å±•é–‹/æ”¶èµ·
        function toggleLogDetails(button) {
            const logEntry = button.closest('.log-entry');
            const detailsPanel = logEntry.querySelector('.log-details');

            if (detailsPanel) {
                detailsPanel.classList.toggle('expanded');

                // æ›´æ–°æŒ‰éˆ•æ–‡æœ¬
                if (detailsPanel.classList.contains('expanded')) {
                    button.textContent = 'ğŸ”¼ æ”¶èµ·';
                } else {
                    button.textContent = 'ğŸ” è©³æƒ…';
                }
            }
        }

        // è¿‡æ»¤æ—¥å¿—
        function filterLogs() {
            const now = new Date();

            return logs.filter(log => {
                // æ—¶é—´èŒƒå›´è¿‡æ»¤
                if (filters.timeRange !== 'all') {
                    const logTime = new Date(log.timestamp);
                    const diffMs = now - logTime;

                    switch (filters.timeRange) {
                        case '5m':
                            if (diffMs > 5 * 60 * 1000) return false;
                            break;
                        case '1h':
                            if (diffMs > 60 * 60 * 1000) return false;
                            break;
                        case 'today':
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            if (logTime < today) return false;
                            break;
                        case '24h':
                            if (diffMs > 24 * 60 * 60 * 1000) return false;
                            break;
                    }
                }

                // æŒç»­æ—¶é—´è¿‡æ»¤ï¼ˆæ…¢è¯·æ±‚ï¼‰
                if (filters.duration !== 'all' && log.duration_ms !== null && log.duration_ms !== undefined) {
                    const duration = log.duration_ms;
                    switch (filters.duration) {
                        case 'fast':
                            if (duration >= 100) return false;
                            break;
                        case 'medium':
                            if (duration < 100 || duration >= 500) return false;
                            break;
                        case 'slow':
                            if (duration < 500) return false;
                            break;
                        case 'veryslow':
                            if (duration < 1000) return false;
                            break;
                    }
                } else if (filters.duration !== 'all' && (log.duration_ms === null || log.duration_ms === undefined)) {
                    // å¦‚æœé€‰æ‹©äº†æŒç»­æ—¶é—´è¿‡æ»¤ï¼Œä½†æ—¥å¿—æ²¡æœ‰ duration_msï¼Œå‰‡è¿‡æ»¤æ‰
                    return false;
                }

                // IP åœ°å€è¿‡æ»¤
                if (filters.ipFilter) {
                    const ip = ((log.details && (log.details.client_ip || log.details.ip)) || log.client_ip || '').toString();
                    if (!ip.includes(filters.ipFilter)) {
                        return false;
                    }
                }

                // ç«¯ç‚¹è·¯å¾„è¿‡æ»¤
                if (filters.pathFilter) {
                    const path = (
                        (log.details && (log.details.path || log.details.url)) ||
                        ((log.message || '').split(' ')[1]) ||
                        ''
                    ).toString().toLowerCase();
                    if (!path.includes(filters.pathFilter.toLowerCase())) {
                        return false;
                    }
                }

                // çº§åˆ«è¿‡æ»¤
                if (filters.level !== 'all' && log.level !== filters.level) {
                    return false;
                }

                // ç±»å‹è¿‡æ»¤ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
                if (filters.types.length > 0) {
                    const logType = (log.type || log.log_type || log.category || '').toString().toLowerCase();

                    // æ£€æŸ¥æ—¥å¿—ç±»å‹æ˜¯å¦åœ¨é€‰ä¸­çš„ç±»å‹åˆ—è¡¨ä¸­
                    let matchedType = filters.types.includes(logType);

                    // å¦‚æœç›´æ¥åŒ¹é…å¤±è´¥ï¼Œå°è¯•ç«¯ç‚¹æ˜ å°„
                    if (!matchedType) {
                        const path = (
                            (log.details && (log.details.path || log.details.url)) ||
                            ((log.message || '').split(' ')[1]) ||
                            ''
                        ).toString();

                        // å¯¹æ¯ä¸ªé€‰ä¸­çš„ç±»å‹è¿›è¡Œæ˜ å°„æ£€æŸ¥
                        for (const selectedType of filters.types) {
                            if (selectedType === 'email_gen' && path.includes('/api/email/generate')) {
                                matchedType = true;
                                break;
                            }
                            if (selectedType === 'code_extract' && path.includes('/codes')) {
                                matchedType = true;
                                break;
                            }
                            if (selectedType === 'llm_call' && (path.includes('/codes') || path.includes('/llm'))) {
                                matchedType = true;
                                break;
                            }
                        }
                    }

                    if (!matchedType) {
                        return false;
                    }
                }

                // æ–¹æ³•è¿‡æ»¤
                const method = ((log.details && (log.details.method || log.details.http_method)) || log.method || ((log.message || '').split(' ')[0] || '')).toString().toUpperCase();
                if (filters.method !== 'all' && method !== filters.method) {
                    return false;
                }

                // éšè—ç»Ÿè®¡è¯·æ±‚
                if (filters.hideStats) {
                    const msg = (log.message || '').toString();
                    const path = (log.details && (log.details.path || log.details.url || '')) || '';
                    if (msg.includes('/admin/logs/stats') || path.includes('/admin/logs/stats')) {
                        return false;
                    }
                }

                // å…³é”®å­—è¿‡æ»¤
                if (filters.keyword) {
                    const keyword = filters.keyword.toLowerCase();
                    const searchText = (log.message + JSON.stringify(log.details || {})).toLowerCase();
                    if (!searchText.includes(keyword)) {
                        return false;
                    }
                }

                return true;
            });
        }

        // è½½å…¥å†å²æ—¥å¿—
        async function loadHistoryLogs() {
            try {
                const response = await fetch('/admin/logs/history?limit=500', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.logs.length > 0) {
                        // å°†å†å²æ—¥å¿—æ·»åŠ åˆ°æ•°ç»„ï¼ˆä¸è§¦å‘åŠ¨ç”»ï¼‰
                        logs = data.logs;
                        console.log(`âœ… è½½å…¥äº† ${logs.length} æ¡å†å²æ—¥å¿—`);
                        renderLogs();
                        updateStats();
                    }
                }
            } catch (error) {
                console.error('è½½å…¥å†å²æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalCount').textContent = logs.length;

            // è·å–è®¢é˜…è€…æ•°é‡ï¼ˆä»åç«¯ï¼‰
            fetch('/admin/logs/stats', { credentials: 'include' })
                .then(async res => {
                    const contentType = res.headers.get('content-type');

                    // å¦‚æœæ˜¯ JSON å“åº”
                    if (contentType && contentType.includes('application/json')) {
                        const data = await res.json();

                        // HTTP çŠ¶æ€ç æˆåŠŸï¼ˆ200-299ï¼‰
                        if (res.ok) {
                            if (data.success) {
                                // æ­£å¸¸ç»Ÿè®¡
                                document.getElementById('subscriberCount').textContent = data.stats.subscribers;
                                document.getElementById('uniqueIpCount').textContent = data.stats.unique_ips || 0;

                                // æ¸…é™¤å¯èƒ½çš„é”™è¯¯æç¤º
                                const existingError = document.getElementById('statsError');
                                if (existingError) {
                                    existingError.remove();
                                }
                            } else {
                                // ç»Ÿè®¡æœåŠ¡å†…éƒ¨é”™è¯¯ï¼ˆä½† HTTP 200ï¼‰
                                console.warn('ç»Ÿè®¡æœåŠ¡å†…éƒ¨é”™è¯¯:', data);
                                showStatsError('ç»Ÿè®¡æœåŠ¡éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸', data.error, data.message);
                            }
                        } else {
                            // HTTP é”™è¯¯çŠ¶æ€ç ï¼ˆ4xx, 5xxï¼‰
                            const errorMsg = data.detail || data.error || data.message || 'æœªçŸ¥é”™è¯¯';
                            console.error(`ç»Ÿè®¡ API é”™è¯¯ (HTTP ${res.status}):`, data);

                            // æå–è¯¦ç»†é”™è¯¯ä¿¡æ¯
                            let errorDetail = '';
                            if (typeof data.detail === 'object') {
                                errorDetail = data.detail.error_detail || data.detail.error || JSON.stringify(data.detail);
                            } else {
                                errorDetail = errorMsg;
                            }

                            showStatsError(
                                `ç»Ÿè®¡ API é”™è¯¯ (HTTP ${res.status})`,
                                errorDetail,
                                `çŠ¶æ€ç : ${res.status} ${res.statusText}`
                            );
                        }
                    } else {
                        // é JSON å“åº”ï¼ˆå¯èƒ½æ˜¯ HTML é”™è¯¯é¡µé¢ï¼‰
                        const text = await res.text();
                        console.error(`ç»Ÿè®¡ API è¿”å›é JSON å“åº” (HTTP ${res.status}):`, text.substring(0, 500));
                        showStatsError(
                            `ç»Ÿè®¡ API é”™è¯¯ (HTTP ${res.status})`,
                            'æœå‹™å™¨è¿”å›é JSON å“åº”',
                            `çŠ¶æ€ç : ${res.status} ${res.statusText}`
                        );
                    }
                })
                .catch(err => {
                    // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸
                    console.error('è·å–ç»Ÿè®¡å¤±è´¥:', err);
                    showStatsError(
                        'ç½‘ç»œé”™è¯¯',
                        err.message,
                        'æ— æ³•è¿æ¥åˆ°ç»Ÿè®¡æœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
                    );
                });
        }

        // æ˜¾ç¤ºç»Ÿè®¡é”™è¯¯æç¤º
        function showStatsError(title, errorDetail, hint) {
            // ç§»é™¤æ—§çš„é”™è¯¯æç¤º
            const existingError = document.getElementById('statsError');
            if (existingError) {
                existingError.remove();
            }

            // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
            const errorDiv = document.createElement('div');
            errorDiv.id = 'statsError';
            errorDiv.style.cssText = `
                background: #7f1d1d;
                border: 1px solid #ef4444;
                color: #fca5a5;
                padding: 12px 16px;
                margin: 12px 24px;
                border-radius: 6px;
                font-size: 13px;
                font-family: 'Monaco', 'Courier New', monospace;
                line-height: 1.5;
            `;

            errorDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">âš ï¸ ${escapeHtml(title)}</div>
                ${hint ? `<div style="margin-bottom: 6px; color: #fbbf24;">${escapeHtml(hint)}</div>` : ''}
                <details style="margin-top: 8px;">
                    <summary style="cursor: pointer; user-select: none;">ğŸ” æŸ¥çœ‹è¯¦ç»†é”™è¯¯</summary>
                    <pre style="margin-top: 8px; padding: 8px; background: #18181b; border: 1px solid #27272a; border-radius: 4px; overflow-x: auto; font-size: 11px; color: #e4e4e7;">${escapeHtml(errorDetail)}</pre>
                </details>
            `;

            // æ’å…¥åˆ°ç»Ÿè®¡æ ä¸‹æ–¹
            const statsDiv = document.getElementById('stats');
            if (statsDiv && statsDiv.nextSibling) {
                statsDiv.parentNode.insertBefore(errorDiv, statsDiv.nextSibling);
            } else if (statsDiv) {
                statsDiv.parentNode.appendChild(errorDiv);
            } else {
                // å¦‚æœæ‰¾ä¸åˆ° stats divï¼Œæ’å…¥åˆ°æ—¥èªŒå®¹å™¨å‰
                const logContainer = document.getElementById('logContainer');
                if (logContainer) {
                    logContainer.parentNode.insertBefore(errorDiv, logContainer);
                }
            }
        }

        // è¿‡æ»¤å™¨äº‹ä»¶
        document.querySelectorAll('[data-level]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('[data-level]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filters.level = pill.dataset.level;
                renderLogs();
            });
        });

        // æ—¥å¿—ç±»å‹å¤šé€‰äº‹ä»¶
        document.querySelectorAll('[data-type]').forEach(pill => {
            pill.addEventListener('click', () => {
                const type = pill.dataset.type;

                if (type === 'all') {
                    // ç‚¹å‡»"å…¨éƒ¨"ï¼šæ¸…ç©ºæ‰€æœ‰é€‰æ‹©ï¼Œåªé€‰ä¸­"å…¨éƒ¨"
                    filters.types = [];
                    document.querySelectorAll('[data-type]').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                } else {
                    // ç‚¹å‡»å…·ä½“ç±»å‹ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
                    const allPill = document.querySelector('[data-type="all"]');
                    allPill.classList.remove('active');  // å–æ¶ˆ"å…¨éƒ¨"çš„é€‰ä¸­

                    if (pill.classList.contains('active')) {
                        // å·²é€‰ä¸­ï¼Œå–æ¶ˆé€‰ä¸­
                        pill.classList.remove('active');
                        filters.types = filters.types.filter(t => t !== type);

                        // å¦‚æœæ²¡æœ‰ä»»ä½•é€‰ä¸­ï¼Œè‡ªåŠ¨é€‰ä¸­"å…¨éƒ¨"
                        if (filters.types.length === 0) {
                            allPill.classList.add('active');
                        }
                    } else {
                        // æœªé€‰ä¸­ï¼Œæ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
                        pill.classList.add('active');
                        filters.types.push(type);
                    }
                }

                renderLogs();
            });
        });

        // æ–¹æ³•è¿‡æ»¤äº‹ä»¶
        document.querySelectorAll('[data-method]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('[data-method]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filters.method = pill.dataset.method;
                renderLogs();
            });
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            filters.keyword = e.target.value;
            renderLogs();
        });

        // éšè—ç»Ÿè®¡è¯·æ±‚åˆ‡æ¢
        const hideStatsCheckbox = document.getElementById('hideStats');
        hideStatsCheckbox.addEventListener('change', () => {
            filters.hideStats = hideStatsCheckbox.checked;
            renderLogs();
        });

        // ğŸ¯ å¿«é€Ÿé¢„è®¾è¿‡æ»¤å™¨
        document.querySelectorAll('[data-preset]').forEach(pill => {
            pill.addEventListener('click', () => {
                const preset = pill.dataset.preset;

                // é‡ç½®æ‰€æœ‰è¿‡æ»¤å™¨åˆ°é»˜è®¤çŠ¶æ€
                function resetAllFilters() {
                    filters.level = 'all';
                    filters.types = [];
                    filters.method = 'all';
                    filters.timeRange = 'all';
                    filters.duration = 'all';
                    filters.pathFilter = '';
                    filters.ipFilter = '';
                    filters.keyword = '';

                    // é‡ç½® UI
                    document.querySelectorAll('[data-level]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-level="all"]').classList.add('active');

                    document.querySelectorAll('[data-type]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-type="all"]').classList.add('active');

                    document.querySelectorAll('[data-method]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-method="all"]').classList.add('active');

                    document.querySelectorAll('[data-timerange]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-timerange="all"]').classList.add('active');

                    document.querySelectorAll('[data-duration]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-duration="all"]').classList.add('active');

                    document.getElementById('pathFilter').value = '';
                    document.getElementById('ipFilter').value = '';
                    document.getElementById('searchInput').value = '';
                }

                // æ›´æ–°é¢„è®¾æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');

                filters.preset = preset;

                switch (preset) {
                    case 'all':
                        // å…¨éƒ¨ï¼šé‡ç½®æ‰€æœ‰è¿‡æ»¤å™¨
                        resetAllFilters();
                        break;

                    case 'errors':
                        // ä»…é”™è¯¯ï¼šæ˜¾ç¤º error å’Œ warning çº§åˆ«
                        resetAllFilters();
                        filters.level = 'error';
                        document.querySelectorAll('[data-level]').forEach(p => p.classList.remove('active'));
                        document.querySelector('[data-level="error"]').classList.add('active');
                        break;

                    case 'slow':
                        // æ…¢è¯·æ±‚ï¼šæŒç»­æ—¶é—´ > 500ms
                        resetAllFilters();
                        filters.duration = 'slow';
                        document.querySelectorAll('[data-duration]').forEach(p => p.classList.remove('active'));
                        document.querySelector('[data-duration="slow"]').classList.add('active');
                        break;

                    case 'recent':
                        // æœ€è¿‘ 5 åˆ†é˜
                        resetAllFilters();
                        filters.timeRange = '5m';
                        document.querySelectorAll('[data-timerange]').forEach(p => p.classList.remove('active'));
                        document.querySelector('[data-timerange="5m"]').classList.add('active');
                        break;
                }

                renderLogs();
            });
        });

        // â° æ—¶é—´èŒƒå›´è¿‡æ»¤å™¨
        document.querySelectorAll('[data-timerange]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('[data-timerange]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filters.timeRange = pill.dataset.timerange;

                // å¦‚æœä¸æ˜¯ "all"ï¼Œå‰‡å–æ¶ˆå¿«é€Ÿé¢„è®¾
                if (filters.timeRange !== 'all') {
                    document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-preset="all"]').classList.add('active');
                    filters.preset = 'all';
                }

                renderLogs();
            });
        });

        // â±ï¸ æŒç»­æ—¶é—´è¿‡æ»¤å™¨
        document.querySelectorAll('[data-duration]').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('[data-duration]').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filters.duration = pill.dataset.duration;

                // å¦‚æœä¸æ˜¯ "all"ï¼Œå‰‡å–æ¶ˆå¿«é€Ÿé¢„è®¾
                if (filters.duration !== 'all') {
                    document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                    document.querySelector('[data-preset="all"]').classList.add('active');
                    filters.preset = 'all';
                }

                renderLogs();
            });
        });

        // ğŸ¯ ç«¯ç‚¹è·¯å¾„è¿‡æ»¤å™¨
        document.getElementById('pathFilter').addEventListener('input', (e) => {
            filters.pathFilter = e.target.value;

            // å¦‚æœæœ‰è¼¸å…¥ï¼Œå‰‡å–æ¶ˆå¿«é€Ÿé¢„è®¾
            if (filters.pathFilter) {
                document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                document.querySelector('[data-preset="all"]').classList.add('active');
                filters.preset = 'all';
            }

            renderLogs();
        });

        // ğŸŒ IP åœ°å€è¿‡æ»¤å™¨
        document.getElementById('ipFilter').addEventListener('input', (e) => {
            filters.ipFilter = e.target.value;

            // å¦‚æœæœ‰è¼¸å…¥ï¼Œå‰‡å–æ¶ˆå¿«é€Ÿé¢„è®¾
            if (filters.ipFilter) {
                document.querySelectorAll('[data-preset]').forEach(p => p.classList.remove('active'));
                document.querySelector('[data-preset="all"]').classList.add('active');
                filters.preset = 'all';
            }

            renderLogs();
        });

        // æš‚åœ/ç»§ç»­
        document.getElementById('pauseBtn').addEventListener('click', (e) => {
            isPaused = !isPaused;
            e.target.textContent = isPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ æš‚åœ';
        });

        // æ¸…ç©ºæ—¥å¿—
        document.getElementById('clearBtn').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) return;

            try {
                const response = await fetch('/admin/logs/clear', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    logs = [];
                    renderLogs();
                    updateStats();
                }
            } catch (error) {
                alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
            }
        });

        // å¯¼å‡ºæ—¥å¿—
        document.getElementById('exportBtn').addEventListener('click', () => {
            const filtered = filterLogs();
            const text = filtered.map(log => {
                const time = new Date(log.timestamp).toISOString();
                const logType = (log.type || log.log_type || log.category || '').toString();
                return `[${time}] [${log.level.toUpperCase()}] [${logType}] ${log.message}`;
            }).join('\n');

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // IP ç»Ÿè®¡åŠŸèƒ½
        const ipStatsModal = document.getElementById('ipStatsModal');
        const ipStatsModalBody = document.getElementById('ipStatsModalBody');
        const ipStatsBtn = document.getElementById('ipStatsBtn');
        const closeIpStatsBtn = document.getElementById('closeIpStatsBtn');

        // åœ‹å®¶ä»£ç¢¼åˆ°åœ‹æ—— emoji çš„æ˜ å°„
        function getCountryFlag(countryCode) {
            if (!countryCode || countryCode === '-') return 'ğŸ³ï¸';
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        // æ‰“é–‹ IP ç»Ÿè®¡å¼¹çª—
        async function openIpStats() {
            ipStatsModal.classList.add('active');
            ipStatsModalBody.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨åŠ è½½ IP ç»Ÿè®¡æ•°æ®...</div>
                </div>
            `;

            try {
                const response = await fetch('/admin/logs/ip-stats', { credentials: 'include' });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderIpStats(data);
                } else {
                    throw new Error(data.message || 'è·å– IP ç»Ÿè®¡å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ IP ç»Ÿè®¡å¤±è´¥:', error);
                ipStatsModalBody.innerHTML = `
                    <div class="error-message">
                        <strong>âŒ åŠ è½½å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ IP ç»Ÿè®¡æ•°æ®
        function renderIpStats(data) {
            const { total_ips, total_requests, ips, country_stats } = data;

            let html = `
                <!-- ç»Ÿè®¡æ‘˜è¦ -->
                <div class="ip-stats-summary">
                    <div class="summary-card">
                        <div class="summary-label">å”¯ä¸€ IP æ•°é‡</div>
                        <div class="summary-value">${total_ips}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">æ€»è¯·æ±‚æ¬¡æ•°</div>
                        <div class="summary-value">${total_requests}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">å›½å®¶/åœ°åŒº</div>
                        <div class="summary-value">${Object.keys(country_stats || {}).length}</div>
                    </div>
                </div>
            `;

            // å›½å®¶ç»Ÿè®¡
            if (country_stats && Object.keys(country_stats).length > 0) {
                html += `
                    <h3 style="margin-bottom: 12px; font-size: 16px;">ğŸŒ æŒ‰å›½å®¶ç»Ÿè®¡</h3>
                    <div class="country-stats-grid">
                `;

                for (const [country, count] of Object.entries(country_stats)) {
                    html += `
                        <div class="country-stat-item">
                            <span class="country-name">${country}</span>
                            <span class="country-count">${count} æ¬¡è¯·æ±‚</span>
                        </div>
                    `;
                }

                html += `</div>`;
            }

            // IP åˆ—è¡¨è¡¨æ ¼
            html += `
                <h3 style="margin: 24px 0 12px; font-size: 16px;">ğŸ“ IP è¯¦ç»†åˆ—è¡¨</h3>
                <div class="ip-table-container">
                    <table class="ip-table">
                        <thead>
                            <tr>
                                <th>IP åœ°å€</th>
                                <th>å›½å®¶/åœ°åŒº</th>
                                <th>çœä»½</th>
                                <th>åŸå¸‚</th>
                                <th>ISP</th>
                                <th style="text-align: right;">è¯·æ±‚æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            ips.forEach(item => {
                const flag = getCountryFlag(item.country_code);
                const status = item.status || 'unknown';
                const rowClass = status === 'success' ? '' : 'opacity: 0.6;';

                html += `
                    <tr style="${rowClass}">
                        <td><code>${item.ip}</code></td>
                        <td>
                            <span class="country-flag">${flag}</span>
                            ${item.country}
                        </td>
                        <td>${item.region || '-'}</td>
                        <td>${item.city || '-'}</td>
                        <td style="font-size: 12px; color: #a1a1aa;">${item.isp || '-'}</td>
                        <td style="text-align: right;">
                            <span class="request-count">${item.requests}</span>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            ipStatsModalBody.innerHTML = html;
        }

        // å…³é—­ IP ç»Ÿè®¡å¼¹çª—
        function closeIpStats() {
            ipStatsModal.classList.remove('active');
        }

        // ç¶å®šäº‹ä»¶
        ipStatsBtn.addEventListener('click', openIpStats);
        closeIpStatsBtn.addEventListener('click', closeIpStats);

        // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
        ipStatsModal.addEventListener('click', (e) => {
            if (e.target === ipStatsModal) {
                closeIpStats();
            }
        });

        // ESC é”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && ipStatsModal.classList.contains('active')) {
                closeIpStats();
            }
        });

        // åˆå§‹åŒ–
        async function init() {
            // å…ˆæ£€æŸ¥è®¤è¯
            const isAuth = await checkAuth();
            if (!isAuth) {
                return; // æœªè®¤è¯ï¼Œå·²é‡å®šå‘
            }
            
            // æ˜¾ç¤ºå®¢æˆ·ç«¯ IP
            try {
                const who = await fetch('/admin/whoami', { credentials: 'include' });
                if (who.ok) {
                    const info = await who.json();
                    document.getElementById('clientIp').textContent = info.ip || '-';
                }
            } catch (e) {
                // ignore
            }
            
            // å…ˆè½½å…¥å†å²æ—¥å¿—
            await loadHistoryLogs();
            // ç„¶åè¿æ¥ SSE æ¥æ”¶æ–°æ—¥å¿—
            connectSSE();
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            // æ¯ 3 ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡
            setInterval(updateStats, 3000);
        }

        // å¯åŠ¨
        init();
    </script>
</body>
</html>
