
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统管理中心</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #EEF2FF;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 24px 0;
            overflow-y: auto;
            z-index: 100;
        }

        .logo {
            padding: 0 24px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 0 16px;
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .nav-link.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }

        .topbar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .topbar-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-ghost {
            background: transparent;
            color: var(--gray-600);
            border: 1px solid var(--gray-300);
        }

        .btn-ghost:hover {
            background: var(--gray-100);
        }

        .content {
            padding: 32px;
        }

        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .form-input:disabled {
            background: var(--gray-100);
            cursor: not-allowed;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .form-hint {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 6px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            flex-direction: column;
        }

        .alert.show {
            display: flex !important;
            align-items: stretch;
            gap: 10px;
        }

        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #10B981;
        }

        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #EF4444;
        }

        .alert-warning {
            background: #FEF3C7;
            color: #92400E;
            border: 1px solid #F59E0B;
        }

        .alert-info {
            background: var(--primary-light);
            color: var(--primary-dark);
            border: 1px solid var(--primary);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-info {
            background: var(--primary-light);
            color: var(--primary);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loginContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f8fafc;
            position: relative;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 48px;
            width: 100%;
            max-width: 420px;
            border: 1px solid #e2e8f0;
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo {
            width: 56px;
            height: 56px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--gray-600);
        }

        #configContainer {
            display: none;
        }

        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



        /* === Mobile Menu Toggle Button === */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            width: 44px;
            height: 44px;
            border: none;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            box-shadow: var(--shadow-lg);
            transform: scale(1.05);
        }

        .mobile-menu-toggle svg {
            width: 24px;
            height: 24px;
            color: var(--gray-700);
        }

        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
        }

        /* === Tablet & Mobile Responsive === */
        @media (max-width: 1024px) {
            .topbar-title {
                font-size: 18px;
            }

            .topbar-actions {
                gap: 8px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            /* Show mobile menu toggle */
            .mobile-menu-toggle {
                display: flex;
            }

            /* Sidebar transformations */
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: var(--shadow-xl);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            /* Main content adjustments */
            .main-content {
                margin-left: 0;
                width: 100%;
            }

            /* Topbar mobile layout */
            .topbar {
                padding: 16px 20px;
                padding-left: 76px; /* Space for hamburger menu */
            }

            .topbar-title {
                font-size: 16px;
            }

            .topbar-actions {
                flex-wrap: wrap;
                gap: 6px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .btn svg {
                width: 14px;
                height: 14px;
            }

            /* Content padding */
            .content {
                padding: 20px 16px;
            }

            /* Card adjustments */
            .card {
                margin-bottom: 20px;
            }

            .card-header {
                padding: 16px;
            }

            .card-title {
                font-size: 16px;
            }

            .card-body {
                padding: 16px;
            }

            /* Form grid to single column */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* Form elements */
            .form-label {
                font-size: 13px;
            }

            .form-input,
            .form-textarea,
            .form-select {
                font-size: 14px;
                padding: 10px 12px;
            }

            /* Badges */
            .badge {
                font-size: 10px;
                padding: 2px 6px;
            }

            /* Login page */
            .login-card {
                padding: 32px 24px;
                margin: 16px;
            }

            .login-logo {
                width: 64px;
                height: 64px;
                font-size: 32px;
            }

            .login-title {
                font-size: 24px;
            }

            /* Stats grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 11px;
            }

            /* Nav menu adjustments */
            .nav-link {
                padding: 12px 16px;
                font-size: 14px;
            }

            .nav-icon {
                width: 20px;
                height: 20px;
            }
        }

        /* === Small Mobile Devices === */
        @media (max-width: 480px) {
            /* Mobile menu button */
            .mobile-menu-toggle {
                top: 16px;
                left: 16px;
                width: 40px;
                height: 40px;
            }

            .mobile-menu-toggle svg {
                width: 20px;
                height: 20px;
            }

            /* Topbar compact layout */
            .topbar {
                padding: 12px 16px;
                padding-left: 64px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .topbar-title {
                font-size: 14px;
                width: 100%;
            }

            .topbar-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .btn {
                padding: 8px 10px;
                font-size: 11px;
            }

            .btn span {
                display: none; /* Hide button text on very small screens */
            }

            .btn svg {
                width: 16px;
                height: 16px;
                margin: 0;
            }

            /* Content adjustments */
            .content {
                padding: 16px 12px;
            }

            /* Cards */
            .card {
                border-radius: 12px;
                margin-bottom: 16px;
            }

            .card-header {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .card-title {
                font-size: 14px;
            }

            .card-body {
                padding: 12px;
            }

            /* Form elements */
            .form-group {
                margin-bottom: 14px;
            }

            .form-label {
                font-size: 12px;
                margin-bottom: 6px;
            }

            .form-input,
            .form-textarea,
            .form-select {
                font-size: 14px;
                padding: 10px;
            }

            .form-hint {
                font-size: 11px;
            }

            /* Stats - full width on very small screens */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
            }

            .stat-icon svg {
                width: 20px;
                height: 20px;
            }

            .stat-value {
                font-size: 18px;
            }

            .stat-label {
                font-size: 11px;
            }

            /* Alerts */
            .alert {
                padding: 10px 12px;
                font-size: 12px;
            }

            /* Sidebar adjustments */
            .logo {
                padding: 0 16px 16px;
            }

            .logo-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .logo-text {
                font-size: 16px;
            }

            .nav-link {
                padding: 10px 14px;
                font-size: 13px;
            }

            .nav-icon {
                width: 18px;
                height: 18px;
            }

            /* Login page */
            .login-card {
                padding: 24px 16px;
                margin: 12px;
            }

            .login-logo {
                width: 56px;
                height: 56px;
                font-size: 28px;
            }

            .login-title {
                font-size: 20px;
            }

            /* Modal responsive */
            .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-title {
                font-size: 16px;
            }

            .modal-body {
                padding: 16px;
            }

            .wizard-step {
                padding: 14px;
                margin-bottom: 16px;
            }

            .wizard-step-icon {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .wizard-step-title {
                font-size: 14px;
            }

            .wizard-step-desc {
                font-size: 12px;
            }

            /* Checkbox and form controls */
            .checkbox-group {
                flex-direction: row;
                align-items: center;
                gap: 8px;
            }

            .checkbox {
                width: 18px;
                height: 18px;
            }
        }

        /* === Landscape Orientation on Mobile === */
        @media (max-width: 768px) and (orientation: landscape) {
            .sidebar {
                width: 200px;
            }

            .topbar {
                padding: 10px 16px;
                padding-left: 56px;
            }

            .content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 配置向导模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-body {
            padding: 24px;
        }

        .wizard-step {
            margin-bottom: 24px;
            padding: 20px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .wizard-step:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .wizard-step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .wizard-step-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-light);
            border-radius: 10px;
        }

        .wizard-step-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .wizard-step-desc {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 12px;
            line-height: 1.6;
            white-space: pre-line;
        }

        .wizard-step-hint {
            font-size: 13px;
            color: var(--primary);
            background: var(--primary-light);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .wizard-step-actions {
            display: flex;
            gap: 8px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: var(--gray-50);
            margin-bottom: 8px;
        }

        .check-item.passed {
            background: #D1FAE5;
            border: 1px solid #10B981;
        }

        .check-item.failed {
            background: #FEE2E2;
            border: 1px solid #EF4444;
        }

        .check-icon {
            font-size: 20px;
        }

        .check-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .check-message {
            font-size: 13px;
            color: var(--gray-600);
            margin-top: 4px;
        }

        /* 流程图样式 */
        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 24px;
        }

        .flow-step {
            border-radius: 12px;
            padding: 20px;
            color: white;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .flow-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .flow-step::after {
            content: '↓';
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .flow-step:last-child::after {
            display: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .step-number {
            background: rgba(255,255,255,0.25);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .step-icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            flex: 1;
        }

        .step-description {
            font-size: 14px;
            line-height: 1.8;
            opacity: 0.95;
            margin-left: 48px;
        }

        .step-detail {
            margin-left: 48px;
            margin-top: 12px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 13px;
            backdrop-filter: blur(10px);
        }

        .step-detail code {
            background: rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .step-detail strong {
            font-weight: 600;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .flow-diagram {
                padding: 16px;
                gap: 20px;
            }

            .flow-step {
                padding: 16px;
            }

            .step-title {
                font-size: 18px;
            }

            .step-description {
                font-size: 13px;
                margin-left: 44px;
            }

            .step-detail {
                margin-left: 44px;
                font-size: 12px;
            }

            .flow-step::after {
                font-size: 24px;
                bottom: -22px;
            }
        }
    </style>
</head>
<body>
    <div id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">⚙️</div>
                <h1 class="login-title">系统管理中心</h1>
                <p class="login-subtitle">请登录以管理系统配置</p>
            </div>

            <div id="loginMessage" class="alert"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">用户名</label>
                    <input type="text" id="username" class="form-input" placeholder="请输入用户名" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">密码</label>
                    <input type="password" id="password" class="form-input" placeholder="请输入密码" required autocomplete="current-password">
                </div>

                <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 10px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <svg width="18" height="18" fill="none" stroke="#0284c7" viewBox="0 0 24 24" style="flex-shrink: 0;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span style="font-weight: 600; color: #0c4a6e; font-size: 14px;">默认管理员账户</span>
                    </div>
                    <div style="font-size: 13px; color: #0c4a6e; line-height: 1.6; margin-left: 26px;">
                        <div style="margin-bottom: 4px;">
                            用户名：<code style="background: white; padding: 2px 8px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; color: #0284c7; font-weight: 600;">admin</code>
                        </div>
                        <div>
                            密码：<code style="background: white; padding: 2px 8px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; color: #0284c7; font-weight: 600;">admin123</code>
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #bae6fd;">
                        <div style="display: flex; align-items: start; gap: 6px; font-size: 12px; color: #f59e0b;">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; margin-top: 1px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span>生产环境请务必修改默认密码</span>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%; justify-content: center;">
                    登录
                </button>
            </form>
        </div>
    </div>

    <div id="configContainer">
        <!-- Mobile Menu Toggle Button -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="開啟選單">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">⚙️</div>
                <span class="logo-text">系统管理</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="server">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                        </svg>
                        服务器配置
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="cloudflare">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                        </svg>
                        cloudflare域名配置
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="llm">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        验证码智能提取
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/logs.html" target="_blank" style="color: #6b7280;">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        实时日志 🔗
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="topbar">
                <h1 class="topbar-title">系统配置管理</h1>
                <div class="topbar-actions">
                    <button class="btn btn-primary" id="saveBtn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        保存配置
                    </button>
                    <button class="btn btn-secondary" id="reloadBtn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        重载配置
                    </button>
                    <button class="btn btn-ghost" id="logoutBtn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        登出
                    </button>
                </div>
            </div>

            <div class="content">
                <div id="message" class="alert"></div>

                <div class="section-content active" id="section-server">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                                </svg>
                                服务器配置
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="port">
                                        端口 <span class="badge badge-warning">需重启</span>
                                    </label>
                                    <input type="number" id="port" class="form-input" placeholder="1234">
                                    <div class="form-hint">服务器监听端口</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="host">
                                        主机地址 <span class="badge badge-warning">需重启</span>
                                    </label>
                                    <input type="text" id="host" class="form-input" placeholder="0.0.0.0">
                                    <div class="form-hint">服务器绑定地址</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="reload" class="checkbox">
                                    <label class="form-label" for="reload" style="margin: 0;">
                                        开发模式自动重载 <span class="badge badge-warning">需重启</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 管理员账户配置 -->
                            <div style="border-top: 1px solid var(--gray-200); margin-top: 24px; padding-top: 24px;">
                                <h3 style="font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 16px;">
                                    管理员账户 <span class="badge badge-warning">需重启</span>
                                </h3>
                                <div class="alert alert-warning show">
                                    ⚠️ 修改管理员账户后需要重新登录
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label" for="adminUsername">管理员用户名</label>
                                        <input type="text" id="adminUsername" class="form-input" placeholder="admin">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="adminPassword">管理员密码</label>
                                        <input type="password" id="adminPassword" class="form-input" placeholder="留空则不修改">
                                        <div class="form-hint">留空表示不修改密码</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="section-content" id="section-cloudflare">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                </svg>
                                Cloudflare 配置 <span class="badge badge-info">即时生效</span>
                            </h2>
                            <button class="btn btn-ghost" id="showFlowBtn"
                                    style="padding: 6px 12px; font-size: 13px; text-decoration: none;"
                                    title="查看邮件转发工作原理">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                工作原理
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 按钮组 -->
                            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" id="wizardBtn" style="flex: 1; min-width: 150px;">
                                    📖 配置向导
                                </button>
                                <button class="btn btn-primary" id="testConnectionBtn" style="flex: 1; min-width: 200px;">
                                    🔍 测试连接并检查状态
                                </button>
                            </div>

                            <!-- 结果显示区 -->
                            <div id="cfHelperResult" class="alert" style="display: none;"></div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="cfAccountId">Cloudflare 账户 ID</label>
                                    <input type="text" id="cfAccountId" class="form-input" placeholder="your-account-id">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="cfKvNamespaceId">KV Namespace ID</label>
                                    <input type="text" id="cfKvNamespaceId" class="form-input" placeholder="your-namespace-id">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="cfApiToken">Cloudflare API Token</label>
                                <input type="password" id="cfApiToken" class="form-input" placeholder="your-api-token">
                                <div class="form-hint">
                                    <strong>🔑 所需权限：</strong><br>
                                    • <strong>Account Settings: Read</strong> - 读取账户信息<br>
                                    • <strong>Workers KV Storage: Read</strong> - 读取 KV 数据<br>
                                    • <strong>Zone: Read</strong> - 读取域名列表（域名检查功能）<br>
                                    • <strong>Email Routing Rules: Read</strong> - 读取 Email Routing 配置（域名检查功能）<br>
                                    <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" style="color: #3498db; text-decoration: none;">📖 创建 API Token →</a>
                                </div>
                            </div>

                            <!-- 配置检查器提示信息 -->
                            <div class="alert alert-info show" style="margin-top: 16px;">
                                <div style="font-weight: 600; margin-bottom: 6px;">💡 关于配置检查器</div>
                                <div style="font-size: 13px; line-height: 1.6;">
                                    • 即使检查器显示错误，如果您的配置正确，<strong>功能可能仍然正常工作</strong><br>
                                    • 这通常是因为 Docker 环境变量未正确挂载或权限问题导致检查器无法读取配置<br>
                                    • <strong>建议</strong>：先实际测试功能（生成邮箱并尝试接收邮件），如果功能正常，可以忽略检查器警告
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                                </svg>
                                域名管理 <span class="badge badge-info">即时生效</span>
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group" style="display: none;">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="enableCustomDomains" class="checkbox" checked>
                                    <label class="form-label" for="enableCustomDomains" style="margin: 0;">启用自定义域名</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="customDomains">自定义域名列表</label>
                                <textarea id="customDomains" class="form-input" placeholder="example.com
your-domain.com
test.com" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;"></textarea>
                                <div class="form-hint">每行输入一个域名（自动使用 Cloudflare KV）<br>⚠️ 注意：域名必须已添加到您的 Cloudflare 账户中并完成 Email Routing 配置</div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="enableBuiltinDomains" class="checkbox">
                                    <label class="form-label" for="enableBuiltinDomains" style="margin: 0;">启用内置域名</label>
                                </div>
                                <div class="form-hint" style="margin-left: 28px;">20 个预设的临时邮箱域名（自动使用外部 API）</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-content" id="section-llm">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                验证码智能提取 <span class="badge badge-info">即时生效</span>
                            </h2>
                            <a href="/docs#/email/get_codes_api_email__token__codes_get" target="_blank" class="btn btn-ghost" style="padding: 6px 12px; font-size: 13px; text-decoration: none;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                API 文档
                            </a>
                        </div>
                        <div class="card-body">
                            <!-- LLM 验证码提取默认已启用，无需显示开关 -->
                            <div class="form-group" style="display: none;">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="useLlmExtraction" class="checkbox" checked>
                                    <label class="form-label" for="useLlmExtraction" style="margin: 0;">启用 LLM 验证码提取</label>
                                </div>
                                <div class="form-hint" style="margin-left: 28px;">使用 AI 模型智能识别验证码</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="openaiApiKey">OpenAI API Key</label>
                                <input type="password" id="openaiApiKey" class="form-input" placeholder="sk-xxx 或 ak-xxx">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="openaiApiBase">API Base URL</label>
                                <input type="text" id="openaiApiBase" class="form-input" placeholder="https://api.openai.com/v1">
                                <div class="form-hint">自定义 API 端点（支持兼容服务）</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="openaiModel">
                                    模型名称
                                    <button type="button" class="btn btn-ghost" id="detectModelsBtn"
                                            style="margin-left: 8px; padding: 4px 10px; font-size: 12px;"
                                            title="从 API 端点获取可用模型列表">
                                        🔍 自动检测
                                    </button>
                                </label>
                                <div style="position: relative;">
                                    <select id="openaiModelSelect" class="form-input" style="display: none;">
                                        <option value="">-- 从下拉选择或切换到手动输入 --</option>
                                    </select>
                                    <input type="text" id="openaiModel" class="form-input"
                                           placeholder="gpt-3.5-turbo（手动输入）">
                                    <button type="button" id="toggleModelInput" class="btn btn-ghost"
                                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 4px 8px; font-size: 12px;"
                                            title="切换输入方式">
                                        📋 切换
                                    </button>
                                </div>
                                <div class="form-hint" id="modelHint">
                                    手动输入模型名称，或点击「自动检测」加载模型列表后切换到下拉选择
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="defaultCodeExtractionMethod">
                                    前端默认提取方法
                                    <span class="badge badge-info">前端默认</span>
                                </label>
                                <select id="defaultCodeExtractionMethod" class="form-input" style="cursor: pointer;">
                                    <option value="llm">🤖 LLM 智能提取（AI 分析）</option>
                                    <option value="pattern">📌 模式训练提取（基于学习）</option>
                                </select>
                                <div class="form-hint">
                                    设置前端调用 API 时的默认提取方法。LLM 模式更智能但需要 API Key，模式训练基于管理员学习的规则，成本更低。
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                模式训练 <span class="badge badge-info">即时生效</span>
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info show">
                                ℹ️ 粘贴邮件样本，选中验证码文本后点击「学习模式」，系统会自动识别关键词并保存提取规则
                            </div>
                            
                            <!-- 邮件样本输入 -->
                            <div class="form-group">
                                <label class="form-label" for="emailSample">邮件样本</label>
                                <textarea id="emailSample" class="form-input"
                                          placeholder="粘贴邮件内容，然后选中验证码进行训练...&#10;&#10;例如：&#10;您的验证码是：123456&#10;有效期为5分钟"
                                          style="min-height: 200px; font-family: monospace; font-size: 13px;"></textarea>
                                <div class="form-hint">
                                    💡 <strong>操作步骤：</strong>
                                    ① 粘贴邮件内容到上方文本框 →
                                    ② 使用鼠标拖动选中验证码文本（例如 <code>123456</code>）→
                                    ③ 「📌 学习选中的验证码模式」按钮会自动激活 →
                                    ④ 点击按钮完成训练
                                </div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="form-group" style="display: flex; gap: 12px;">
                                <button id="learnPatternBtn" class="btn btn-primary" disabled>
                                    📌 学习选中的验证码模式
                                </button>
                                <button id="clearSampleBtn" class="btn btn-secondary">
                                    🗑️ 清空
                                </button>
                            </div>
                            
                            <!-- 已学习模式列表 -->
                            <div class="form-group">
                                <label class="form-label">
                                    已学习的模式
                                    <button class="btn btn-ghost" style="margin-left: 12px; padding: 4px 12px; font-size: 12px;" onclick="loadPatterns()">
                                        🔄 重新加载
                                    </button>
                                </label>
                                <div id="patternsList" style="margin-top: 12px;">
                                    <div style="text-align: center; padding: 20px; color: var(--gray-500);">
                                        加载中...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 配置向导模态框 -->
    <div id="wizardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📖 Cloudflare 配置向导</h3>
                <button class="modal-close" onclick="closeWizardModal()">✕</button>
            </div>
            <div class="modal-body" id="wizardSteps">
                <!-- 动态加载向导步骤 -->
            </div>
        </div>
    </div>

    <!-- 手动配置说明模态框 -->
    <div id="manualConfigModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">📝 手动部署配置说明</h3>
                <button class="modal-close" onclick="closeManualConfigModal()">✕</button>
            </div>
            <div class="modal-body" id="manualConfigContent">
                <!-- 动态加载手动配置内容 -->
            </div>
        </div>
    </div>

    <!-- 工作原理流程图模态框 -->
    <div id="flowDiagramModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">📧 邮件转发工作原理</h3>
                <button class="modal-close" onclick="closeFlowDiagramModal()">✕</button>
            </div>
            <div class="modal-body">
                <!-- 图形化流程图 -->
                <div class="flow-diagram">
                    <!-- 步骤 1: 用户发送邮件 -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="step-header">
                            <div class="step-number">①</div>
                            <div class="step-icon">📧</div>
                            <div class="step-title">用户发送邮件</div>
                        </div>
                        <div class="step-description">
                            用户向临时邮箱地址发送邮件（例如：test@yourdomain.com）<br>
                            邮件服务器查询 DNS MX 记录，确定邮件接收服务器
                        </div>
                        <div class="step-detail">
                            <strong>示例：</strong> gmail.com → DNS 查询 → yourdomain.com MX 记录
                        </div>
                    </div>

                    <!-- 步骤 2: Cloudflare DNS -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="step-header">
                            <div class="step-number">②</div>
                            <div class="step-icon">☁️</div>
                            <div class="step-title">Cloudflare DNS 解析</div>
                        </div>
                        <div class="step-description">
                            DNS MX 记录指向 Cloudflare Email Routing<br>
                            邮件被路由到 Cloudflare 基础设施进行处理
                        </div>
                        <div class="step-detail">
                            <strong>MX 记录：</strong> yourdomain.com → isaac.mx.cloudflare.net (优先级 10)
                        </div>
                    </div>

                    <!-- 步骤 3: Email Routing -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="step-header">
                            <div class="step-number">③</div>
                            <div class="step-icon">📨</div>
                            <div class="step-title">Cloudflare Email Routing</div>
                        </div>
                        <div class="step-description">
                            Cloudflare 接收邮件并验证发件人<br>
                            触发配置的 Email Worker 进行自定义处理
                        </div>
                        <div class="step-detail">
                            <strong>配置位置：</strong> Cloudflare Dashboard → Email → Email Routing → Routes
                        </div>
                    </div>

                    <!-- 步骤 4: Email Worker -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="step-header">
                            <div class="step-number">④</div>
                            <div class="step-icon">⚙️</div>
                            <div class="step-title">Email Worker 处理</div>
                        </div>
                        <div class="step-description">
                            JavaScript Worker 拦截邮件并执行以下操作：<br>
                            • 解析邮件内容（纯文本 + HTML）<br>
                            • 提取发件人、收件人、主题、时间戳<br>
                            • 生成唯一的邮件 ID（基于内容哈希）
                        </div>
                        <div class="step-detail">
                            <strong>Worker 文件：</strong> workers/email-handler.js
                        </div>
                    </div>

                    <!-- 步骤 5: Workers KV Storage -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="step-header">
                            <div class="step-number">⑤</div>
                            <div class="step-icon">💾</div>
                            <div class="step-title">存储到 Workers KV</div>
                        </div>
                        <div class="step-description">
                            将邮件数据存储到 Cloudflare Workers KV（键值数据库）<br>
                            • Key 格式：<code>mail:{邮箱地址}:{时间戳}</code><br>
                            • 自动设置 1 小时过期时间（TTL=3600 秒）<br>
                            • 维护每个邮箱的邮件索引列表（最多 50 封）
                        </div>
                        <div class="step-detail">
                            <strong>示例 Key：</strong> mail:test@example.com:1704096000000
                        </div>
                    </div>

                    <!-- 步骤 6: FastAPI 后端 -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <div class="step-header">
                            <div class="step-number">⑥</div>
                            <div class="step-icon">🐍</div>
                            <div class="step-title">FastAPI 后端读取</div>
                        </div>
                        <div class="step-description">
                            Python 后端通过 Cloudflare KV API 读取数据：<br>
                            • 使用 Account ID + Namespace ID + API Token 认证<br>
                            • 调用 Cloudflare REST API 获取邮件<br>
                            • 返回 JSON 格式的邮件数据给前端
                        </div>
                        <div class="step-detail">
                            <strong>API 端点：</strong> GET /api/email/{token}/mails
                        </div>
                    </div>

                    <!-- 步骤 7: 用户查看 -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <div class="step-header">
                            <div class="step-number">⑦</div>
                            <div class="step-icon">🌐</div>
                            <div class="step-title">用户查看邮件</div>
                        </div>
                        <div class="step-description">
                            Web 前端显示邮件内容：<br>
                            • 显示邮件列表（发件人、主题、时间）<br>
                            • 显示邮件详细内容（纯文本 + HTML）<br>
                            • 自动提取验证码（使用 LLM 或正则表达式）
                        </div>
                        <div class="step-detail">
                            <strong>前端页面：</strong> http://localhost:1234/
                        </div>
                    </div>
                </div>

                <!-- 底部说明 -->
                <div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">💡 技术优势</div>
                    <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; font-size: 14px; line-height: 1.8;">
                        <li><strong>零成本</strong>：Cloudflare Workers KV 免费额度充足（每天 10 万次读取）</li>
                        <li><strong>高性能</strong>：全球 CDN 节点，毫秒级响应速度</li>
                        <li><strong>安全可靠</strong>：邮件自动过期，无需担心数据泄露</li>
                        <li><strong>易于扩展</strong>：支持多个自定义域名，轻松扩展临时邮箱服务</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const loginContainer = document.getElementById('loginContainer');
        const configContainer = document.getElementById('configContainer');
        const loginMessage = document.getElementById('loginMessage');
        const message = document.getElementById('message');

        // 导航切换
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const section = link.dataset.section;

                // 跳过外部链接（如实时日志）
                if (!section) {
                    return; // 允许默认行为（打开链接）
                }

                e.preventDefault();

                // 更新导航状态
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // 显示对应区块
                document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
                document.getElementById('section-' + section).classList.add('active');

                // 在移動端點擊導航後自動關閉側邊欄
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            });
        });

        // 移動端選單控制
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function openSidebar() {
            sidebar.classList.add('show');
            sidebarOverlay.style.display = 'block';
            setTimeout(() => {
                sidebarOverlay.classList.add('show');
            }, 10);
            document.body.style.overflow = 'hidden'; // 防止背景滾動
        }

        function closeSidebar() {
            sidebar.classList.remove('show');
            sidebarOverlay.classList.remove('show');
            setTimeout(() => {
                sidebarOverlay.style.display = 'none';
            }, 300);
            document.body.style.overflow = ''; // 恢復滾動
        }

        // 漢堡選單按鈕點擊
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                if (sidebar.classList.contains('show')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
        }

        // 點擊遮罩層關閉側邊欄
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeSidebar);
        }

        // 監聽視窗大小變化,在桌面模式下移除移動端類別
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('show');
                sidebarOverlay.style.display = 'none';
                sidebarOverlay.classList.remove('show');
                document.body.style.overflow = '';
            }
        });

        function showMessage(element, text, type) {
            // 支持用 | 分隔多行消息（用于后端返回的详细配置信息）
            if (text.includes('|')) {
                element.innerHTML = text.split('|').map(line => line.trim()).join('<br>');
            } else {
                element.textContent = text;
            }
            element.className = `alert alert-${type} show`;
            // 根据消息长度动态调整显示时间（最少 5 秒，最多 30 秒）
            const messageLength = text.length;
            const displayTime = Math.min(30000, Math.max(5000, messageLength * 5));
            setTimeout(() => {
                element.className = 'alert';
            }, displayTime);
        }

        // 检查 JWT
        async function checkSession() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                return false;
            }

            try {
                const response = await fetch('/admin/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.authenticated) {
                    await loadConfig();
                    loginContainer.style.display = 'none';
                    configContainer.style.display = 'block';
                    return true;
                } else {
                    // Token 无效，清除本地存储
                    localStorage.removeItem('admin_token');
                    return false;
                }
            } catch (error) {
                // 请求失败，清除本地存储
                localStorage.removeItem('admin_token');
                return false;
            }
        }

        // 登入
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('loginBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> 登录中...';
            btn.disabled = true;

            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // 保存 JWT 到 localStorage
                    localStorage.setItem('admin_token', data.token);
                    showMessage(loginMessage, '登录成功！', 'success');
                    await loadConfig();
                    loginContainer.style.display = 'none';
                    configContainer.style.display = 'block';
                } else {
                    showMessage(loginMessage, data.detail || '登录失败', 'error');
                }
            } catch (error) {
                showMessage(loginMessage, '网络错误: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // 载入配置
        async function loadConfig() {
            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    throw new Error('未登录');
                }

                const response = await fetch('/admin/config/env', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('未授权');
                }

                const data = await response.json();
                const config = data.config;

                // Server
                document.getElementById('port').value = config.server?.port || '';
                document.getElementById('host').value = config.server?.host || '';
                document.getElementById('reload').checked = (config.server?.reload === 'true');

                // Domains - 处理自定义域名列表
                const customDomains = config.domains?.custom_domains || '';

                // 调试输出：显示原始数据
                console.log('原始自定义域名数据:', customDomains, '类型:', typeof customDomains);

                // 智能处理各种可能的域名格式并转换为每行一个域名的格式
                let displayValue = '';
                if (customDomains && customDomains.trim() !== '') {
                    try {
                        // 首先尝试作为 JSON 解析
                        let parsed;

                        // 处理可能的转义字符
                        let cleanInput = customDomains;
                        if (customDomains.includes('\\"')) {
                            cleanInput = customDomains.replace(/\\"/g, '"');
                        }

                        // 尝试解析为 JSON
                        parsed = JSON.parse(cleanInput);

                        if (Array.isArray(parsed)) {
                            // 是数组，转换为多行格式
                            displayValue = parsed.filter(domain => domain && domain.trim()).join('\n');
                        } else if (typeof parsed === 'string') {
                            // 是字符串，直接使用
                            displayValue = parsed.trim();
                        } else {
                            throw new Error('非预期的数据类型');
                        }
                    } catch (jsonError) {
                        // JSON 解析失败，尝试其他格式
                        console.log('JSON 解析失败，尝试其他格式:', jsonError);

                        // 移除可能的引号
                        let cleanValue = customDomains.replace(/^["']|["']$/g, '');

                        // 检查是否包含逗号（可能是逗号分隔）
                        if (cleanValue.includes(',')) {
                            displayValue = cleanValue
                                .split(',')
                                .map(domain => domain.trim())
                                .filter(domain => domain.length > 0)
                                .join('\n');
                        } else if (cleanValue.includes('\n')) {
                            // 已经是多行格式
                            displayValue = cleanValue;
                        } else if (cleanValue.trim().length > 0) {
                            // 单一域名
                            displayValue = cleanValue.trim();
                        }
                        // 如果全部都失败，displayValue 保持为空字符串
                    }
                }

                // 调试输出：显示处理后的结果
                console.log('处理后的域名显示值:', displayValue);

                document.getElementById('customDomains').value = displayValue;

                document.getElementById('enableCustomDomains').checked = true; // 始终为 true（已隐藏 UI）
                document.getElementById('enableBuiltinDomains').checked = (config.domains?.enable_builtin_domains === 'true');

                // Cloudflare (KV checkbox removed - always enabled)
                document.getElementById('cfAccountId').value = config.cloudflare?.cf_account_id || '';
                document.getElementById('cfKvNamespaceId').value = config.cloudflare?.cf_kv_namespace_id || '';
                document.getElementById('cfApiToken').value = config.cloudflare?.cf_api_token || '';

                // LLM
                document.getElementById('useLlmExtraction').checked = (config.llm?.use_llm_extraction === 'true');
                document.getElementById('openaiApiKey').value = config.llm?.openai_api_key || '';
                document.getElementById('openaiApiBase').value = config.llm?.openai_api_base || '';
                document.getElementById('openaiModel').value = config.llm?.openai_model || '';
                document.getElementById('defaultCodeExtractionMethod').value = config.llm?.default_code_extraction_method || 'llm';

                // Admin
                document.getElementById('adminUsername').value = config.admin?.admin_username || '';

            } catch (error) {
                console.error('加载配置时发生错误:', error);
                showMessage(message, '加载配置失败: ' + error.message, 'error');

                // 如果是域名配置问题，设置为空值以避免显示错误数据
                if (error.message.includes('domain') || error.message.includes('JSON')) {
                    document.getElementById('customDomains').value = '';
                }
            }
        }

        // 模型输入模式切换
        let isSelectMode = false;  // 当前是否为下拉选择模式
        let availableModels = [];  // 存储可用的模型列表

        // 切换输入方式按钮
        document.getElementById('toggleModelInput')?.addEventListener('click', function() {
            const modelInput = document.getElementById('openaiModel');
            const modelSelect = document.getElementById('openaiModelSelect');
            const modelHint = document.getElementById('modelHint');

            // 如果当前是手动输入模式，想切换到下拉模式，需要先有模型列表
            if (!isSelectMode && availableModels.length === 0) {
                modelHint.style.color = '#e74c3c';
                modelHint.textContent = '⚠️ 请先点击「自动检测」加载模型列表';
                setTimeout(() => {
                    modelHint.style.color = '';
                    modelHint.textContent = '手动输入模型名称，或点击「自动检测」加载模型列表后切换到下拉选择';
                }, 3000);
                return;
            }

            // 切换模式
            isSelectMode = !isSelectMode;

            if (isSelectMode) {
                // 切换到下拉选择模式
                modelInput.style.display = 'none';
                modelSelect.style.display = 'block';
                this.textContent = '⌨️ 手动输入';
                modelHint.textContent = `从下拉选择模型（共 ${availableModels.length} 个）`;

                // 同步当前值
                if (modelInput.value.trim()) {
                    modelSelect.value = modelInput.value.trim();
                }
            } else {
                // 切换到手动输入模式（总是允许切换回来）
                modelInput.style.display = 'block';
                modelSelect.style.display = 'none';
                this.textContent = '📋 下拉选择';
                modelHint.textContent = '手动输入模型名称，或点击「自动检测」从 API 加载可用模型列表';

                // 同步当前值
                if (modelSelect.value) {
                    modelInput.value = modelSelect.value;
                }
            }
        });

        // 下拉选择改变时同步到输入框
        document.getElementById('openaiModelSelect')?.addEventListener('change', function() {
            document.getElementById('openaiModel').value = this.value;
        });

        // 自動檢測可用的 AI 模型
        document.getElementById('detectModelsBtn')?.addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            const modelInput = document.getElementById('openaiModel');
            const modelSelect = document.getElementById('openaiModelSelect');
            const modelHint = document.getElementById('modelHint');
            const toggleBtn = document.getElementById('toggleModelInput');

            // 获取当前配置
            const apiBase = document.getElementById('openaiApiBase').value.trim();
            const apiKey = document.getElementById('openaiApiKey').value.trim();

            // 验证必需参数
            if (!apiBase) {
                modelHint.style.color = '#e74c3c';
                modelHint.textContent = '⚠️ 请先填写 API Base URL';
                setTimeout(() => {
                    modelHint.style.color = '';
                    modelHint.textContent = '手动输入模型名称，或点击「自动检测」加载模型列表后切换到下拉选择';
                }, 3000);
                return;
            }

            if (!apiKey) {
                modelHint.style.color = '#e74c3c';
                modelHint.textContent = '⚠️ 请先填写 API Key';
                setTimeout(() => {
                    modelHint.style.color = '';
                    modelHint.textContent = '手动输入模型名称，或点击「自动检测」加载模型列表后切换到下拉选择';
                }, 3000);
                return;
            }

            // 显示加载状态
            btn.disabled = true;
            btn.innerHTML = '⏳ 检测中...';
            modelHint.style.color = '#3498db';
            modelHint.textContent = '🔍 正在从 API 获取模型列表...';

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/admin/llm/models', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        openai_api_base: apiBase,
                        openai_api_key: apiKey
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.models && result.models.length > 0) {
                    // 存储模型列表
                    availableModels = result.models;

                    // 更新下拉选择框
                    modelSelect.innerHTML = '<option value="">-- 选择一个模型 --</option>';
                    result.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });

                    // 如果当前输入框为空，自动填入第一个模型
                    if (!modelInput.value.trim() && result.models.length > 0) {
                        modelInput.value = result.models[0];
                        modelSelect.value = result.models[0];
                    } else if (modelInput.value.trim()) {
                        // 同步现有值到下拉框
                        modelSelect.value = modelInput.value.trim();
                    }

                    // 自动切换到下拉选择模式
                    isSelectMode = true;
                    modelInput.style.display = 'none';
                    modelSelect.style.display = 'block';
                    toggleBtn.textContent = '⌨️ 手动输入';

                    // 显示成功消息
                    modelHint.style.color = '#27ae60';
                    modelHint.textContent = `✅ 成功检测到 ${result.models.length} 个可用模型！已自动切换到下拉选择`;

                    // 3秒后恢复提示
                    setTimeout(() => {
                        modelHint.style.color = '';
                        modelHint.textContent = `从下拉选择模型（共 ${result.models.length} 个），或点击「⌨️ 手动输入」切换`;
                    }, 3000);
                } else {
                    // API 返回失败
                    availableModels = [];
                    modelHint.style.color = '#e74c3c';
                    modelHint.textContent = `❌ ${result.message || '无法获取模型列表'}`;

                    setTimeout(() => {
                        modelHint.style.color = '';
                        modelHint.textContent = '手动输入模型名称，或点击「自动检测」加载模型列表后切换到下拉选择';
                    }, 5000);
                }
            } catch (error) {
                console.error('检测模型失败:', error);
                availableModels = [];
                modelHint.style.color = '#e74c3c';
                modelHint.textContent = `❌ 检测失败: ${error.message}`;

                setTimeout(() => {
                    modelHint.style.color = '';
                    modelHint.textContent = '手动输入模型名称，或点击「自动检测」加载模型列表后切换到下拉选择';
                }, 5000);
            } finally {
                // 恢復按鈕狀態
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // 保存配置
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> 保存中...';
            btn.disabled = true;

            try {
                const configData = {};

                // Server
                if (document.getElementById('port').value) {
                    configData.port = parseInt(document.getElementById('port').value);
                }
                if (document.getElementById('host').value) {
                    configData.host = document.getElementById('host').value;
                }
                configData.reload = document.getElementById('reload').checked;

                // Domains - 将多行域名转换为 JSON 数组格式
                const domainsInput = document.getElementById('customDomains').value.trim();
                if (domainsInput) {
                    // 按行分割并过滤空行
                    const domainsArray = domainsInput
                        .split('\n')
                        .map(domain => domain.trim())
                        .filter(domain => domain.length > 0);

                    // 转换为 JSON 字符串
                    configData.custom_domains = JSON.stringify(domainsArray);
                }
                configData.enable_custom_domains = true; // 始终启用自定义域名（已隐藏 UI 并默认选中）
                configData.enable_builtin_domains = document.getElementById('enableBuiltinDomains').checked;

                // Cloudflare (KV always enabled)
                configData.use_cloudflare_kv = true;
                if (document.getElementById('cfAccountId').value) {
                    configData.cf_account_id = document.getElementById('cfAccountId').value;
                }
                if (document.getElementById('cfKvNamespaceId').value) {
                    configData.cf_kv_namespace_id = document.getElementById('cfKvNamespaceId').value;
                }
                if (document.getElementById('cfApiToken').value) {
                    configData.cf_api_token = document.getElementById('cfApiToken').value;
                }

                // LLM
                configData.use_llm_extraction = document.getElementById('useLlmExtraction').checked;
                if (document.getElementById('openaiApiKey').value) {
                    configData.openai_api_key = document.getElementById('openaiApiKey').value;
                }
                if (document.getElementById('openaiApiBase').value) {
                    configData.openai_api_base = document.getElementById('openaiApiBase').value;
                }
                if (document.getElementById('openaiModel').value) {
                    configData.openai_model = document.getElementById('openaiModel').value;
                }
                if (document.getElementById('defaultCodeExtractionMethod').value) {
                    configData.default_code_extraction_method = document.getElementById('defaultCodeExtractionMethod').value;
                }

                // Admin
                if (document.getElementById('adminUsername').value) {
                    configData.admin_username = document.getElementById('adminUsername').value;
                }
                if (document.getElementById('adminPassword').value) {
                    configData.admin_password = document.getElementById('adminPassword').value;
                }
                // JWT 密钥不允许从管理界面修改，只能通过环境变量配置
                // if (document.getElementById('adminSecretKey').value) {
                //     configData.admin_secret_key = document.getElementById('adminSecretKey').value;
                // }

                const token = localStorage.getItem('admin_token');
                if (!token) {
                    showMessage(message, '❌ 请先登录', 'error');
                    return;
                }

                const response = await fetch('/admin/config/env', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(configData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showMessage(message, data.message || '✅ 配置保存成功！', 'success');
                } else {
                    showMessage(message, '❌ ' + (data.detail || '保存失败'), 'error');
                }
            } catch (error) {
                showMessage(message, '❌ 网络错误: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // 重载配置
        document.getElementById('reloadBtn').addEventListener('click', async () => {
            const btn = document.getElementById('reloadBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> 重载中...';
            btn.disabled = true;

            try {
                await loadConfig();
                showMessage(message, '✅ 配置重载成功！', 'success');
            } catch (error) {
                showMessage(message, '❌ 重载失败: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // 登出
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    await fetch('/admin/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                }

                // 清除本地存储的 JWT
                localStorage.removeItem('admin_token');
                loginContainer.style.display = 'flex';
                configContainer.style.display = 'none';
                loginForm.reset();
                showMessage(loginMessage, '✅ 已登出', 'success');
            } catch (error) {
                // 即使请求失败，也清除本地存储
                localStorage.removeItem('admin_token');
                loginContainer.style.display = 'flex';
                configContainer.style.display = 'none';
                loginForm.reset();
                showMessage(loginMessage, '✅ 已登出', 'success');
            }
        });

        // 页面加载时检查 session
        checkSession();

        // ==================== Cloudflare 辅助功能 ====================

        // 配置向导
        document.getElementById('wizardBtn').addEventListener('click', async () => {
            const btn = document.getElementById('wizardBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> 加载中...';
            btn.disabled = true;

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/admin/cloudflare/wizard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showWizardModal(data.steps);
                } else {
                    showCfHelperResult('加载向导失败: ' + (data.detail || '未知错误'), 'error');
                }
            } catch (error) {
                showCfHelperResult('网络错误: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // 测试连接并检查状态（流式检查 - SSE）
        document.getElementById('testConnectionBtn').addEventListener('click', async () => {
            const btn = document.getElementById('testConnectionBtn');
            const resultDiv = document.getElementById('cfHelperResult');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<span class="loading"></span> 检查中...';
            btn.disabled = true;
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info show';
            resultDiv.innerHTML = '<div id="streamProgress"></div>';

            try {
                const token = localStorage.getItem('admin_token');

                // 收集前端输入框的当前值
                const formData = {
                    cf_account_id: document.getElementById('cfAccountId').value.trim() || null,
                    cf_kv_namespace_id: document.getElementById('cfKvNamespaceId').value.trim() || null,
                    cf_api_token: document.getElementById('cfApiToken').value.trim() || null
                };

                // 创建进度条
                let progressBar = document.createElement('div');
                progressBar.style.cssText = 'background: #e0e0e0; height: 24px; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);';
                progressBar.innerHTML = '<div id="progressFill" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;"></div>';
                document.getElementById('streamProgress').appendChild(progressBar);

                // 创建消息容器
                let messageContainer = document.createElement('pre');
                messageContainer.style.cssText = 'max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 16px; border-radius: 8px; font-size: 13px; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; border: 1px solid #e0e0e0;';
                document.getElementById('streamProgress').appendChild(messageContainer);

                let messages = [];

                // 使用 POST 请求传递参数 (SSE 不支持 request body，所以用 URL params)
                const params = new URLSearchParams({
                    ...formData,
                    token: token
                });

                // 创建 EventSource 进行流式通信
                const url = `/admin/cloudflare/test-and-check-stream?${params}`;

                // 使用 fetch + ReadableStream 替代 EventSource (因为需要 POST 和 Auth header)
                const response = await fetch('/admin/cloudflare/test-and-check-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                // 添加取消按钮
                let cancelBtn = document.createElement('button');
                cancelBtn.textContent = '✕ 取消';
                cancelBtn.className = 'btn btn-ghost';
                cancelBtn.style.cssText = 'margin-top: 12px;';
                let cancelled = false;
                cancelBtn.onclick = () => {
                    cancelled = true;
                    reader.cancel();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    messages.push('\n⚠️ 检查已取消');
                    messageContainer.textContent = messages.join('\n');
                };
                document.getElementById('streamProgress').appendChild(cancelBtn);

                // 读取流式数据
                while (true) {
                    const { done, value } = await reader.read();
                    if (done || cancelled) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const data = JSON.parse(jsonStr);

                                // 更新进度条
                                if (data.progress !== undefined) {
                                    const progressFill = document.getElementById('progressFill');
                                    progressFill.style.width = data.progress + '%';
                                    progressFill.textContent = data.progress + '%';
                                }

                                // 添加消息
                                if (data.message) {
                                    messages.push(`[${data.stage || 'info'}] ${data.message}`);
                                    messageContainer.textContent = messages.join('\n');
                                    messageContainer.scrollTop = messageContainer.scrollHeight;
                                }

                                // 检查是否完成或错误
                                if (data.stage === 'done') {
                                    btn.innerHTML = originalText;
                                    btn.disabled = false;
                                    resultDiv.className = 'alert alert-success show';
                                    cancelBtn.remove();

                                    // 显示最终摘要
                                    setTimeout(() => {
                                        messages.push('\n✅ 检查完成！所有配置正常。');
                                        messageContainer.textContent = messages.join('\n');
                                    }, 300);
                                    break;
                                } else if (data.stage === 'error') {
                                    btn.innerHTML = originalText;
                                    btn.disabled = false;
                                    resultDiv.className = 'alert alert-warning show';  // 改为警告样式
                                    cancelBtn.remove();

                                    // 添加友好提示
                                    messages.push(`\n\n⚠️ ${data.message}`);
                                    if (data.can_continue) {
                                        messages.push(`\n💡 友好提示：虽然检测到错误，但这不代表服务无法使用！`);
                                        messages.push(`   建议您先尝试正常使用服务，如果遇到实际问题，再返回此处调整配置。`);
                                    }
                                    messageContainer.textContent = messages.join('\n');
                                    break;
                                } else if (data.stage === 'warning') {
                                    // 警告阶段不中断流程，继续显示消息
                                    // 不需要 break，让流程继续
                                }
                            } catch (e) {
                                // JSON 解析失败，忽略
                            }
                        }
                    }
                }

                // 流式读取完成
                if (!cancelled) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    cancelBtn.remove();
                }

            } catch (error) {
                resultDiv.className = 'alert alert-error show';
                resultDiv.innerHTML = `<div style="padding: 16px;">❌ 网络错误: ${error.message}</div>`;
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ===== 可复用操作函数：供配置页按钮和配置向导调用 =====
        // 自动检测功能（从配置向导调用）
        async function autoDetectAction() {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/admin/cloudflare/auto-detect', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success && data.detected) {
                    // 自动填充
                    if (data.data.cf_account_id) {
                        document.getElementById('cfAccountId').value = data.data.cf_account_id;
                    }
                    if (data.data.cf_kv_namespace_id) {
                        document.getElementById('cfKvNamespaceId').value = data.data.cf_kv_namespace_id;
                    }

                    let msg = `✅ ${data.message}\n`;
                    if (data.data.logged_in_as) {
                        msg += `登录账户: ${data.data.logged_in_as}\n`;
                    }
                    if (data.data.wrangler_version) {
                        msg += `Wrangler 版本: ${data.data.wrangler_version}\n`;
                    }
                    if (data.data.namespace_title) {
                        msg += `检测到 Namespace: ${data.data.namespace_title}\n`;
                    }
                    if (data.warning) {
                        msg += `⚠️ ${data.warning}\n`;
                    }
                    msg += '\n' + data.note;

                    showCfHelperResult(msg, 'success');
                } else {
                    // 构建错误消息
                    let errorMsg = `⚠️ ${data.error || '自动检测失败'}\n\n`;
                    errorMsg += `💡 ${data.suggestion || '请使用配置向导或手动填写'}\n`;

                    // 如果有可用的 namespace 列表，显示出来
                    if (data.available_namespaces && data.available_namespaces.length > 0) {
                        errorMsg += `\n📦 当前可用的 KV Namespaces:\n`;
                        data.available_namespaces.forEach(name => {
                            errorMsg += `   • ${name}\n`;
                        });
                    }

                    // 如果有额外说明
                    if (data.note) {
                        errorMsg += `\n${data.note}\n`;
                    }

                    // 优先使用后端返回的 fallback_hint，如果没有则使用默认提示
                    if (data.fallback_hint) {
                        errorMsg += `\n${data.fallback_hint}`;
                    } else {
                        errorMsg += `\n✨ 即使自动检测失败，您仍可点击「📖 配置向导」按钮，获取详细的配置步骤指引`;
                    }

                    showCfHelperResult(errorMsg, 'warning');
                }
            } catch (error) {
                // 构建友好的错误提示
                let errorMsg = `❌ 自动检测失败\n\n`;
                errorMsg += `错误原因: ${error.message}\n\n`;
                errorMsg += `💡 请先安装 Wrangler CLI: npm install -g wrangler\n\n`;
                errorMsg += `✨ 即使自动检测失败，您仍可点击「📖 配置向导」按钮，获取详细的配置步骤指引`;

                showCfHelperResult(errorMsg, 'error');

                // 高亮配置向导按钮以引导用户注意
                const wizardBtn = document.getElementById('wizardBtn');
                if (wizardBtn) {
                    wizardBtn.style.animation = 'pulse 2s ease-in-out 3';
                    setTimeout(() => {
                        wizardBtn.style.animation = '';
                    }, 6000);
                }
            }
        }

        // ===== 其他可复用操作函数 =====
        async function ensureNamespaceAction() {
            const accountId = document.getElementById('cfAccountId').value;
            const apiToken = document.getElementById('cfApiToken').value;

            if (!accountId || !apiToken) {
                showCreateNamespaceModal('请先填写 Cloudflare 账户 ID 与 API Token', 'warning');
                return;
            }

            // 显示载入状态
            showCreateNamespaceModal('🔄 正在创建 KV Namespace...', 'info');

            try {
                const token = localStorage.getItem('admin_token');
                const resp = await fetch('/admin/cloudflare/kv/ensure-namespace', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'EMAIL_STORAGE', cf_account_id: accountId, cf_api_token: apiToken })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    document.getElementById('cfKvNamespaceId').value = data.id;
                    const msg = data.created
                        ? `✅ 已创建 Namespace EMAIL_STORAGE\n\nNamespace ID: ${data.id}\n\n此 ID 已自动填入下方字段，您可以继续配置其他选项。`
                        : `✅ 已选择现有 Namespace EMAIL_STORAGE\n\nNamespace ID: ${data.id}\n\n此 ID 已自动填入下方字段，您可以继续配置其他选项。`;
                    showCreateNamespaceModal(msg, 'success');
                } else {
                    showCreateNamespaceModal('❌ 操作失败\n\n' + (data.detail || '未知错误'), 'error');
                }
            } catch (e) {
                showCreateNamespaceModal('❌ 网络错误\n\n' + e.message, 'error');
            }
        }

        // 创建独立的 KV Namespace 结果消息框
        function showCreateNamespaceModal(message, type) {
            // 移除现有的消息框（如果存在）
            const existingModal = document.getElementById('createNamespaceModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 创建新的消息框
            const modal = document.createElement('div');
            modal.id = 'createNamespaceModal';
            modal.className = 'modal show';
            modal.style.zIndex = '1050'; // 确保在其他模态框之上

            const typeColors = {
                success: { bg: '#D1FAE5', border: '#10B981', text: '#065F46', icon: '✅' },
                error: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B', icon: '❌' },
                warning: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E', icon: '⚠️' },
                info: { bg: 'var(--primary-light)', border: 'var(--primary)', text: 'var(--primary-dark)', icon: 'ℹ️' }
            };

            const colors = typeColors[type] || typeColors.info;

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; margin-top: 100px;">
                    <div class="modal-header" style="background: ${colors.bg}; border-color: ${colors.border};">
                        <h3 class="modal-title" style="color: ${colors.text}; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${colors.icon}</span>
                            KV Namespace 操作結果
                        </h3>
                        <button class="modal-close" onclick="closeCreateNamespaceModal()">✕</button>
                    </div>
                    <div class="modal-body">
                        <div style="
                            background: ${colors.bg};
                            border: 2px solid ${colors.border};
                            color: ${colors.text};
                            padding: 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            line-height: 1.6;
                            white-space: pre-line;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        ">
                            ${message}
                        </div>
                        ${type === 'success' || type === 'error' || type === 'warning' ? `
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="closeCreateNamespaceModal()">确定</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCreateNamespaceModal();
                }
            });

            // ESC 键关闭
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeCreateNamespaceModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // 关闭 KV Namespace 结果消息框
        function closeCreateNamespaceModal() {
            const modal = document.getElementById('createNamespaceModal');
            if (modal) {
                modal.remove();
            }
        }

        // 全局变量存储当前片段内容
        let currentSnippetContent = '';

        // 创建 Wrangler 片段消息框
        function showWranglerSnippetModal(message, type, snippet = null) {
            // 移除现有的消息框（如果存在）
            const existingModal = document.getElementById('wranglerSnippetModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 存储片段内容到全局变量
            currentSnippetContent = snippet || '';

            // 创建新的消息框
            const modal = document.createElement('div');
            modal.id = 'wranglerSnippetModal';
            modal.className = 'modal show';
            modal.style.zIndex = '1050';

            const typeColors = {
                success: { bg: '#D1FAE5', border: '#10B981', text: '#065F46', icon: '✅' },
                error: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B', icon: '❌' },
                warning: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E', icon: '⚠️' },
                info: { bg: 'var(--primary-light)', border: 'var(--primary)', text: 'var(--primary-dark)', icon: 'ℹ️' }
            };

            const colors = typeColors[type] || typeColors.info;

            // 生成代码片段显示区域
            const snippetHtml = snippet ? `
                <div style="margin-top: 16px;">
                    <div id="snippetCodeDisplay" style="
                        background: #1f2937;
                        color: #10b981;
                        padding: 16px;
                        border-radius: 8px;
                        font-family: 'Monaco', 'Courier New', monospace;
                        font-size: 13px;
                        white-space: pre-line;
                        border: 2px solid #374151;
                        position: relative;
                        user-select: text;
                        cursor: text;
                    ">${snippet}</div>
                    <div style="margin-top: 12px; text-align: center;">
                        <button class="btn btn-secondary" onclick="copyCurrentSnippet()">
                            📋 复制配置片段
                        </button>
                        <button class="btn btn-secondary" onclick="selectSnippetText()" style="margin-left: 8px;">
                            🎯 选取文本
                        </button>
                    </div>
                </div>
            ` : '';

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; margin-top: 50px;">
                    <div class="modal-header" style="background: ${colors.bg}; border-color: ${colors.border};">
                        <h3 class="modal-title" style="color: ${colors.text}; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${colors.icon}</span>
                            Wrangler 配置片段
                        </h3>
                        <button class="modal-close" onclick="closeWranglerSnippetModal()">✕</button>
                    </div>
                    <div class="modal-body">
                        <div style="
                            background: ${colors.bg};
                            border: 2px solid ${colors.border};
                            color: ${colors.text};
                            padding: 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            line-height: 1.6;
                            white-space: pre-line;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        ">
                            ${message}
                        </div>
                        ${snippetHtml}
                        ${type === 'success' || type === 'error' || type === 'warning' ? `
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="closeWranglerSnippetModal()">确定</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeWranglerSnippetModal();
                }
            });

            // ESC 键关闭
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeWranglerSnippetModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // 关闭 Wrangler 片段消息框
        function closeWranglerSnippetModal() {
            const modal = document.getElementById('wranglerSnippetModal');
            if (modal) {
                modal.remove();
            }
        }

        // 复制当前片段到剪贴板
        function copyCurrentSnippet() {
            if (!currentSnippetContent) {
                alert('没有可复制的配置片段');
                return;
            }

            // 使用现代 Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentSnippetContent).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    // Fallback to older method
                    fallbackCopySnippet();
                });
            } else {
                // Fallback for older browsers
                fallbackCopySnippet();
            }
        }

        // 显示复制成功提示
        function showCopySuccess() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const originalBg = btn.style.background;
            const originalColor = btn.style.color;

            btn.innerHTML = '✅ 已复制';
            btn.style.background = '#10B981';
            btn.style.color = 'white';

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = originalBg;
                btn.style.color = originalColor;
            }, 2000);
        }

        // 旧版浏览器的复制方法
        function fallbackCopySnippet() {
            // 创建临时文本区域
            const textArea = document.createElement('textarea');
            textArea.value = currentSnippetContent;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);

            try {
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    throw new Error('execCommand failed');
                }
            } catch (err) {
                // 最终的错误处理
                alert('复制失败，请手动选取并复制代码片段\n\n您可以点击「🎯 选取文本」按钮来选取代码');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // 选取片段文本
        function selectSnippetText() {
            const codeDisplay = document.getElementById('snippetCodeDisplay');
            if (!codeDisplay) {
                alert('找不到代码片段');
                return;
            }

            // 选取文本
            if (window.getSelection && document.createRange) {
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(codeDisplay);
                selection.removeAllRanges();
                selection.addRange(range);

                // 提示用户
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '✅ 已选取';
                btn.style.background = '#3B82F6';
                btn.style.color = 'white';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);

                // 提示用户可以复制
                setTimeout(() => {
                    alert('代码已选取，请按 Ctrl+C (Windows) 或 Cmd+C (Mac) 复制');
                }, 100);
            } else {
                alert('您的浏览器不支持自动选取，请手动选取代码片段');
            }
        }

        // 创建写入 Wrangler 文件消息框
        function showWriteWranglerModal(message, type) {
            // 移除现有的消息框（如果存在）
            const existingModal = document.getElementById('writeWranglerModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 创建新的消息框
            const modal = document.createElement('div');
            modal.id = 'writeWranglerModal';
            modal.className = 'modal show';
            modal.style.zIndex = '1050';

            const typeColors = {
                success: { bg: '#D1FAE5', border: '#10B981', text: '#065F46', icon: '✅' },
                error: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B', icon: '❌' },
                warning: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E', icon: '⚠️' },
                info: { bg: 'var(--primary-light)', border: 'var(--primary)', text: 'var(--primary-dark)', icon: 'ℹ️' }
            };

            const colors = typeColors[type] || typeColors.info;

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; margin-top: 100px;">
                    <div class="modal-header" style="background: ${colors.bg}; border-color: ${colors.border};">
                        <h3 class="modal-title" style="color: ${colors.text}; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${colors.icon}</span>
                            写入 wrangler.toml
                        </h3>
                        <button class="modal-close" onclick="closeWriteWranglerModal()">✕</button>
                    </div>
                    <div class="modal-body">
                        <div style="
                            background: ${colors.bg};
                            border: 2px solid ${colors.border};
                            color: ${colors.text};
                            padding: 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            line-height: 1.6;
                            white-space: pre-line;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        ">
                            ${message}
                        </div>
                        ${type === 'success' || type === 'error' || type === 'warning' ? `
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="closeWriteWranglerModal()">确定</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeWriteWranglerModal();
                }
            });

            // ESC 键关闭
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeWriteWranglerModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // 关闭写入 Wrangler 消息框
        function closeWriteWranglerModal() {
            const modal = document.getElementById('writeWranglerModal');
            if (modal) {
                modal.remove();
            }
        }

        async function wranglerSnippetAction() {
            const namespaceId = document.getElementById('cfKvNamespaceId').value;
            if (!namespaceId) {
                showWranglerSnippetModal('⚠️ 请先填写或创建 KV Namespace ID\n\n请确保您已完成步骤 2 并填入了有效的 Namespace ID。', 'warning');
                return;
            }

            // 顯示載入狀態
            showWranglerSnippetModal('🔄 正在生成 Wrangler 配置片段...', 'info');

            try {
                const token = localStorage.getItem('admin_token');
                const resp = await fetch(`/admin/cloudflare/wrangler-snippet?binding=EMAIL_STORAGE&namespace_id=${encodeURIComponent(namespaceId)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    const message = `✅ Wrangler 配置片段已生成\n\n请将以下片段复制到 workers/wrangler.toml 文件中：\n\n${data.snippet}\n使用方法：\n1. 复制上面的配置片段\n2. 打开 workers/wrangler.toml 文件\n3. 将片段粘贴到文件中\n4. 保存文件\n5. 在 workers 目录执行: wrangler deploy`;
                    showWranglerSnippetModal(message, 'success', data.snippet);
                } else {
                    showWranglerSnippetModal('❌ 生成失败\n\n' + (data.detail || '未知错误'), 'error');
                }
            } catch (e) {
                showWranglerSnippetModal('❌ 网络错误\n\n' + e.message, 'error');
            }
        }

        async function writeWranglerAction() {
            const namespaceId = document.getElementById('cfKvNamespaceId').value;
            if (!namespaceId) {
                showWriteWranglerModal('⚠️ 请先填写或创建 KV Namespace ID\n\n请确保您已完成步骤 2 并填入了有效的 Namespace ID。', 'warning');
                return;
            }

            // 获取文件路径
            const filePath = prompt('wrangler.toml 路径', 'workers/wrangler.toml');
            if (!filePath) return;

            // 显示载入状态
            showWriteWranglerModal('🔄 正在写入 wrangler.toml 文件...\n\n正在将 KV Namespace 配置写入到指定的文件中...', 'info');

            try {
                const token = localStorage.getItem('admin_token');
                const resp = await fetch('/admin/cloudflare/write-wrangler', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: filePath, binding: 'EMAIL_STORAGE', namespace_id: namespaceId, confirm: true })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    const message = `✅ wrangler.toml 已成功更新\n\n文件路径: ${data.file}\n\n接下来的步骤:\n1. 确认 workers/wrangler.toml 文件已正确更新\n2. 在 workers 目录执行: wrangler deploy\n3. 完成 Worker 部署到 Cloudflare`;
                    showWriteWranglerModal(message, 'success');
                } else {
                    const message = `❌ 写入失败\n\n错误详情: ${data.detail || '未知错误'}\n\n💡 建议解决方案:\n• 检查文件路径是否正确\n• 确保有写入权限\n• 或使用「🧩 Wrangler 片段」功能手动复制配置`;
                    showWriteWranglerModal(message, 'error');
                }
            } catch (e) {
                showWriteWranglerModal('❌ 网络错误\n\n' + e.message, 'error');
            }
        }

        // 已移除 Cloudflare 面板内的「创建/片段/写入」按钮（保留在配置向导内）

        // 显示配置向导模态框
        function showWizardModal(steps) {
            const wizardSteps = document.getElementById('wizardSteps');
            wizardSteps.innerHTML = '';

            // 向导内消息框（用于显示 Wrangler 片段等）
            const wizardMsgBox = document.createElement('div');
            wizardMsgBox.id = 'wizardMsgBox';
            wizardMsgBox.className = 'alert';
            wizardMsgBox.style.display = 'none';
            wizardSteps.appendChild(wizardMsgBox);

            steps.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'wizard-step';
                
                // 构建命令展示区域（如果存在命令）
                let commandHtml = '';
                if (step.command) {
                    commandHtml = `
                        <div style="background: var(--gray-900); color: #00ff00; padding: 12px; border-radius: 6px; margin: 12px 0; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; position: relative;">
                            <code style="display: block; white-space: pre-wrap;">${step.command}</code>
                        </div>
                        <button class="btn btn-ghost" onclick="copyCommand('${step.command.replace(/'/g, "\\'")}'); event.stopPropagation();" style="margin-bottom: 8px;">
                            📋 复制命令
                        </button>
                    `;
                }
                
                // 构建按钮区域
                let actionsHtml = '<div class="wizard-step-actions">';

                // 添加 Cloudflare 服务链接按钮（如果有 URL，但排除 step 4）
                if (step.url && String(step.id) !== '4') {
                    // 根据步骤 ID 自定义按钮文本
                    let buttonText = '🔗 打开链接';
                    if (String(step.id) === '1') {
                        buttonText = '🔗 打开 Cloudflare Dashboard';
                    } else if (String(step.id) === '2') {
                        buttonText = '🔗 打开 API Token 管理';
                    } else if (String(step.id) === '3') {
                        buttonText = '🔗 打开 Workers KV 管理';
                    } else if (String(step.id) === '5') {
                        buttonText = '🔗 打开 Email Routing 配置';
                    }

                    actionsHtml += `
                        <a href="${step.url}" target="_blank" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                            ${buttonText}
                        </a>
                    `;
                }

                if (step.field_id) {
                    actionsHtml += `
                        <button class="btn btn-secondary" onclick="focusField('${step.field_id}')">
                            📝 前往填写
                        </button>
                    `;
                }
                // 在步骤 1 添加自动检测按钮
                if (String(step.id) === '1') {
                    actionsHtml += `
                        <button class="btn btn-ghost" onclick="triggerAutoDetectFromWizard(event)" style="font-size: 13px;">
                            🛠️ 可选功能: 自动检测
                        </button>
                    `;
                }
                // 将「创建 KV Namespace」按钮添加到步骤 3
                if (String(step.id) === '3') {
                    actionsHtml += `
                        <button class="btn btn-primary" onclick="ensureNamespaceAction()">
                            🛠️ 可选功能: 快速填写 KV Namespace
                        </button>
                    `;
                }
                // 将一键部署按钮和手动配置选项添加到步骤 4
                if (String(step.id) === '4') {
                    // 获取手动配置说明（如果有）
                    const manualConfigDesc = step.manual_config_description || '';

                    actionsHtml += `
                        <div style="margin-top: 8px; display: flex; justify-content: center;">
                            <a href="https://deploy.workers.cloudflare.com/?url=https://github.com/TonnyWong1052/temp-email/tree/main/workers" target="_blank">
                                <img src="https://deploy.workers.cloudflare.com/button" alt="Deploy to Cloudflare Workers" style="border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';" />
                            </a>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-ghost" onclick="showManualConfigMessage(\`${manualConfigDesc}\`)" style="flex: 1; height: 40px; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1.2; padding: 8px;">
                                <span style="font-size: 14px;">🔧 手动配置选项</span>
                            </button>
                        </div>
                    `;
                }
                actionsHtml += '</div>';
                
                stepDiv.innerHTML = `
                    <div class="wizard-step-header">
                        <div class="wizard-step-icon">${step.icon}</div>
                        <div class="wizard-step-title">步骤 ${step.id}: ${step.title}</div>
                    </div>
                    <div class="wizard-step-desc">${step.description}</div>
                    <div class="wizard-step-hint">💡 ${step.hint}</div>
                    ${commandHtml}
                    ${actionsHtml}
                `;
                wizardSteps.appendChild(stepDiv);
            });


            document.getElementById('wizardModal').classList.add('show');
        }

        // 在向导内显示消息
        function showWizardMessage(message, type, autoHide = false) {
            const box = document.getElementById('wizardMsgBox');
            if (!box) {
                showCfHelperResult(message, type || 'info');
                return;
            }
            box.innerHTML = message.replace(/\n/g, '<br>');
            box.className = `alert alert-${type || 'info'} show`;
            box.style.display = 'block';
            box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // 如果启用自动隐藏，根据消息长度动态调整显示时间
            if (autoHide) {
                const messageLength = message.length;
                const displayTime = Math.min(30000, Math.max(5000, messageLength * 5));
                setTimeout(() => {
                    box.style.display = 'none';
                }, displayTime);
            }
        }
        
        // 复制命令到剪贴板
        function copyCommand(command) {
            navigator.clipboard.writeText(command).then(() => {
                showCfHelperResult('✅ 命令已复制到剪贴板', 'success');
                setTimeout(() => {
                    document.getElementById('cfHelperResult').style.display = 'none';
                }, 2000);
            }).catch(err => {
                showCfHelperResult('❌ 复制失败: ' + err.message, 'error');
            });
        }

        // 关闭配置向导
        function closeWizardModal() {
            document.getElementById('wizardModal').classList.remove('show');
        }

        // 从配置向导触发自动检测
        async function triggerAutoDetectFromWizard(event) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const resultDiv = document.getElementById('cfHelperResult');

            // 显示按钮载入动画
            btn.innerHTML = '<span class="loading"></span> 检测中...';
            btn.disabled = true;

            // 在结果区域显示载入动画（与测试连接相同的位置）
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info show';
            resultDiv.innerHTML = '<div style="padding: 16px;"><span class="loading"></span> 正在自动检测 Cloudflare 配置...</div>';

            try {
                // 关闭向导模态框
                closeWizardModal();

                // 调用自动检测功能
                await autoDetectAction();
            } finally {
                // 恢复按钮状态
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // 显示手动配置说明的独立模态框
        function showManualConfigMessage(manualConfigDesc) {
            if (!manualConfigDesc) {
                alert('暂无手动配置说明');
                return;
            }

            // 构建完整的消息内容
            const content = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 20px; white-space: pre-line; line-height: 1.8; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                    <div style="font-weight: 600; font-size: 18px; margin-bottom: 16px; text-align: center;">📝 手动部署步骤说明</div>
                    <div style="font-size: 14px;">${manualConfigDesc}</div>
                </div>
                <div style="background: var(--gray-50); padding: 20px; border-radius: 12px; border: 1px solid var(--gray-200);">
                    <div style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 16px; text-align: center;">
                        🛠️ Wrangler 配置工具
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center;">
                        <button class="btn btn-secondary" onclick="wranglerSnippetAction(); closeManualConfigModal();" style="font-size: 14px; padding: 10px 20px;">
                            🧩 Wrangler 片段
                        </button>
                        <span style="color: var(--gray-500); font-size: 14px;">或</span>
                        <button class="btn btn-ghost" onclick="writeWranglerAction(); closeManualConfigModal();" style="font-size: 14px; padding: 10px 20px;">
                            ✍️ 写入 wrangler.toml
                        </button>
                    </div>
                    <div style="font-size: 13px; color: var(--gray-600); margin-top: 16px; text-align: center; background: white; padding: 12px; border-radius: 8px;">
                        💡 优先使用一键部署按钮。手动配置仅作为备选方案。
                    </div>
                </div>
            `;

            // 设置内容并显示模态框
            document.getElementById('manualConfigContent').innerHTML = content;
            document.getElementById('manualConfigModal').classList.add('show');
        }

        // 关闭手动配置模态框
        function closeManualConfigModal() {
            document.getElementById('manualConfigModal').classList.remove('show');
        }

        // 显示工作原理流程图
        document.getElementById('showFlowBtn')?.addEventListener('click', function() {
            document.getElementById('flowDiagramModal').classList.add('show');
        });

        // 关闭流程图模态框
        function closeFlowDiagramModal() {
            document.getElementById('flowDiagramModal').classList.remove('show');
        }

        // 点击模态框外部关闭流程图
        document.getElementById('flowDiagramModal')?.addEventListener('click', function(e) {
            if (e.target.id === 'flowDiagramModal') {
                closeFlowDiagramModal();
            }
        });

        // 聚焦到指定字段
        function focusField(fieldId) {
            closeWizardModal();
            // 切换到 Cloudflare 配置页面
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector('.nav-link[data-section="cloudflare"]').classList.add('active');
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById('section-cloudflare').classList.add('active');

            // 聚焦并高亮
            const field = document.getElementById(fieldId);
            if (field) {
                field.focus();
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                field.style.borderColor = 'var(--primary)';
                field.style.boxShadow = '0 0 0 3px var(--primary-light)';
                setTimeout(() => {
                    field.style.borderColor = '';
                    field.style.boxShadow = '';
                }, 2000);
            }
        }

        // 显示测试结果
        function showTestResult(data) {
            const resultDiv = document.getElementById('cfHelperResult');
            let html = '';

            if (data.checks && data.checks.length > 0) {
                data.checks.forEach(check => {
                    const isPassed = check.status === 'passed';
                    html += `
                        <div class="check-item ${isPassed ? 'passed' : 'failed'}">
                            <div class="check-icon">${check.icon}</div>
                            <div style="flex: 1;">
                                <div class="check-name">${check.name}</div>
                                <div class="check-message">${check.message}</div>
                            </div>
                        </div>
                    `;
                });
            }

            html += `<div style="margin-top: 12px; font-weight: 600;">${data.message}</div>`;

            resultDiv.innerHTML = html;
            resultDiv.style.display = 'flex';
            resultDiv.style.flexDirection = 'column';
            resultDiv.className = `alert alert-${data.overall_status === 'success' ? 'success' : 'error'} show`;

            // 自动滚动到结果区域
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // 显示辅助功能结果
        function showCfHelperResult(message, type) {
            const resultDiv = document.getElementById('cfHelperResult');
            resultDiv.innerHTML = message.replace(/\n/g, '<br>');
            resultDiv.className = `alert alert-${type} show`;
            // 根据消息长度动态调整显示时间（最少 15 秒，最多 60 秒）
            const messageLength = message.length;
            const displayTime = Math.min(60000, Math.max(15000, messageLength * 10));
            setTimeout(() => {
                resultDiv.className = 'alert';
            }, displayTime);
        }

        // 点击模态框外部关闭
        document.getElementById('wizardModal').addEventListener('click', (e) => {
            if (e.target.id === 'wizardModal') {
                closeWizardModal();
            }
        });

        document.getElementById('manualConfigModal').addEventListener('click', (e) => {
            if (e.target.id === 'manualConfigModal') {
                closeManualConfigModal();
            }
        });

        // 监听ESC键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.keyCode === 27) {
                // 关闭手动配置模态框
                const manualConfigModal = document.getElementById('manualConfigModal');
                if (manualConfigModal && manualConfigModal.classList.contains('show')) {
                    closeManualConfigModal();
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                // 关闭流程图模态框
                const flowDiagramModal = document.getElementById('flowDiagramModal');
                if (flowDiagramModal && flowDiagramModal.classList.contains('show')) {
                    closeFlowDiagramModal();
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                // 关闭配置向导模态框
                const wizardModal = document.getElementById('wizardModal');
                if (wizardModal && wizardModal.classList.contains('show')) {
                    closeWizardModal();
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        });

        // ==================== Pattern Training Functions ====================

        // 监听文本选中事件
        document.getElementById('emailSample').addEventListener('mouseup', function() {
            const textarea = this;
            const selectedText = textarea.value.substring(
                textarea.selectionStart,
                textarea.selectionEnd
            ).trim();

            const learnBtn = document.getElementById('learnPatternBtn');

            // 判断是否可能是验证码 (4-10位字母数字)
            if (selectedText.length >= 4 && selectedText.length <= 10) {
                if (/^[A-Z0-9]+$/i.test(selectedText)) {
                    learnBtn.disabled = false;
                    learnBtn.innerHTML = `📌 学习「${selectedText}」`;
                    learnBtn.dataset.selectedText = selectedText;
                    learnBtn.dataset.selectionStart = textarea.selectionStart;
                } else {
                    learnBtn.disabled = true;
                    learnBtn.innerHTML = '📌 学习选中的验证码模式';
                }
            } else {
                learnBtn.disabled = true;
                learnBtn.innerHTML = '📌 学习选中的验证码模式';
            }
        });

        // 学习模式按钮
        document.getElementById('learnPatternBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            const selectedText = btn.dataset.selectedText;
            const selectionStart = parseInt(btn.dataset.selectionStart);
            const emailContent = document.getElementById('emailSample').value;

            if (!selectedText || !emailContent) {
                showMessage(message, '❌ 请先粘贴邮件并选中验证码', 'error');
                return;
            }

            btn.innerHTML = '<span class="loading"></span> 学习中...';
            btn.disabled = true;

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/patterns/learn', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email_content: emailContent,
                        highlighted_code: selectedText,
                        highlight_position: selectionStart
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const keywords = data.preview.keywords_before.join('、');
                    showMessage(message, `✅ 模式学习成功！关键词：${keywords}`, 'success');
                    loadPatterns(); // 重新加载模式列表
                } else {
                    showMessage(message, `❌ ${data.message || '学习失败'}`, 'error');
                }
            } catch (error) {
                showMessage(message, `❌ 网络错误: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // 清空按钮
        document.getElementById('clearSampleBtn').addEventListener('click', function() {
            document.getElementById('emailSample').value = '';
            const learnBtn = document.getElementById('learnPatternBtn');
            learnBtn.disabled = true;
            learnBtn.innerHTML = '📌 学习选中的验证码模式';
        });

        // 加载已学习模式列表
        async function loadPatterns() {
            const patternsList = document.getElementById('patternsList');

            patternsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">加载中...</div>';

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/patterns', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (data.patterns.length === 0) {
                        patternsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">暂无已学习模式，请先训练</div>';
                        return;
                    }

                    let html = '';
                    data.patterns.forEach(pattern => {
                        const successRate = pattern.usage_count > 0 
                            ? Math.round(pattern.success_rate * 100) 
                            : 0;
                        
                        // 截取邮件内容预览（最多150个字符）
                        const emailPreview = pattern.email_content.length > 150 
                            ? pattern.email_content.substring(0, 150) + '...' 
                            : pattern.email_content;
                        
                        html += `
                            <div class="pattern-item" style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 8px;">
                                            <span class="badge badge-info">${pattern.code_type}</span>
                                            <span style="margin-left: 8px;">关键词：「${pattern.keywords_before.join('、')}」→ ${pattern.code_length}位${pattern.code_type === 'numeric' ? '数字' : '字母数字'}</span>
                                        </div>
                                        
                                        <!-- 邮件内容预览 -->
                                        <div style="background: var(--gray-50); border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                                            <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px; font-weight: 600;">邮件内容：</div>
                                            <div style="font-size: 12px; color: var(--gray-700); line-height: 1.5; font-family: monospace; white-space: pre-wrap;">${emailPreview}</div>
                                        </div>
                                        
                                        <!-- 高亮验证码 -->
                                        <div style="font-size: 13px; color: var(--gray-700); margin-top: 8px;">
                                            <span style="color: var(--gray-500);">高亮验证码：</span>
                                            <span style="background: #FEF3C7; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-family: monospace;">${pattern.example_code}</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right; margin-left: 16px;">
                                        <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">
                                            使用 ${pattern.usage_count} 次
                                        </div>
                                        ${pattern.usage_count > 0 ? `
                                        <div style="font-size: 12px; color: ${successRate >= 80 ? 'var(--success)' : 'var(--warning)'};">
                                            成功率 ${successRate}%
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; border-top: 1px solid var(--gray-200); padding-top: 12px;">
                                    <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 12px;" onclick="deletePattern('${pattern.id}')">
                                        🗑️ 删除
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    patternsList.innerHTML = html;
                } else {
                    patternsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">加载失败</div>';
                }
            } catch (error) {
                patternsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">网络错误</div>';
            }
        }

        // 删除模式
        async function deletePattern(patternId) {
            if (!confirm('确定要删除这个模式吗？')) {
                return;
            }

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`/api/patterns/${patternId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showMessage(message, '✅ 模式已删除', 'success');
                    loadPatterns();
                } else {
                    showMessage(message, `❌ 删除失败: ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage(message, `❌ 网络错误: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动加载模式列表
        window.addEventListener('load', function() {
            // 延迟加载，等待登录完成
            setTimeout(() => {
                if (localStorage.getItem('admin_token')) {
                    loadPatterns();
                }
            }, 1000);
        });
    </script>
</body>
</html>
                                <div class="form-hint" style="margin-left: 28px;">使用 Cloudflare Workers 
