
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç†ä¸­å¿ƒ</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #EEF2FF;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 24px 0;
            overflow-y: auto;
            z-index: 100;
        }

        .logo {
            padding: 0 24px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 0 16px;
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .nav-link.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }

        .topbar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .topbar-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-ghost {
            background: transparent;
            color: var(--gray-600);
            border: 1px solid var(--gray-300);
        }

        .btn-ghost:hover {
            background: var(--gray-100);
        }

        .content {
            padding: 32px;
        }

        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .form-input:disabled {
            background: var(--gray-100);
            cursor: not-allowed;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .form-hint {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 6px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            flex-direction: column;
        }

        .alert.show {
            display: flex !important;
            align-items: stretch;
            gap: 10px;
        }

        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #10B981;
        }

        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #EF4444;
        }

        .alert-warning {
            background: #FEF3C7;
            color: #92400E;
            border: 1px solid #F59E0B;
        }

        .alert-info {
            background: var(--primary-light);
            color: var(--primary-dark);
            border: 1px solid var(--primary);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-info {
            background: var(--primary-light);
            color: var(--primary);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loginContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f8fafc;
            position: relative;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 48px;
            width: 100%;
            max-width: 420px;
            border: 1px solid #e2e8f0;
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo {
            width: 56px;
            height: 56px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--gray-600);
        }

        #configContainer {
            display: none;
        }

        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



        /* === Mobile Menu Toggle Button === */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            width: 44px;
            height: 44px;
            border: none;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            box-shadow: var(--shadow-lg);
            transform: scale(1.05);
        }

        .mobile-menu-toggle svg {
            width: 24px;
            height: 24px;
            color: var(--gray-700);
        }

        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
        }

        /* === Tablet & Mobile Responsive === */
        @media (max-width: 1024px) {
            .topbar-title {
                font-size: 18px;
            }

            .topbar-actions {
                gap: 8px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            /* Show mobile menu toggle */
            .mobile-menu-toggle {
                display: flex;
            }

            /* Sidebar transformations */
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: var(--shadow-xl);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            /* Main content adjustments */
            .main-content {
                margin-left: 0;
                width: 100%;
            }

            /* Topbar mobile layout */
            .topbar {
                padding: 16px 20px;
                padding-left: 76px; /* Space for hamburger menu */
            }

            .topbar-title {
                font-size: 16px;
            }

            .topbar-actions {
                flex-wrap: wrap;
                gap: 6px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .btn svg {
                width: 14px;
                height: 14px;
            }

            /* Content padding */
            .content {
                padding: 20px 16px;
            }

            /* Card adjustments */
            .card {
                margin-bottom: 20px;
            }

            .card-header {
                padding: 16px;
            }

            .card-title {
                font-size: 16px;
            }

            .card-body {
                padding: 16px;
            }

            /* Form grid to single column */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* Form elements */
            .form-label {
                font-size: 13px;
            }

            .form-input,
            .form-textarea,
            .form-select {
                font-size: 14px;
                padding: 10px 12px;
            }

            /* Badges */
            .badge {
                font-size: 10px;
                padding: 2px 6px;
            }

            /* Login page */
            .login-card {
                padding: 32px 24px;
                margin: 16px;
            }

            .login-logo {
                width: 64px;
                height: 64px;
                font-size: 32px;
            }

            .login-title {
                font-size: 24px;
            }

            /* Stats grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 11px;
            }

            /* Nav menu adjustments */
            .nav-link {
                padding: 12px 16px;
                font-size: 14px;
            }

            .nav-icon {
                width: 20px;
                height: 20px;
            }
        }

        /* === Small Mobile Devices === */
        @media (max-width: 480px) {
            /* Mobile menu button */
            .mobile-menu-toggle {
                top: 16px;
                left: 16px;
                width: 40px;
                height: 40px;
            }

            .mobile-menu-toggle svg {
                width: 20px;
                height: 20px;
            }

            /* Topbar compact layout */
            .topbar {
                padding: 12px 16px;
                padding-left: 64px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .topbar-title {
                font-size: 14px;
                width: 100%;
            }

            .topbar-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .btn {
                padding: 8px 10px;
                font-size: 11px;
            }

            .btn span {
                display: none; /* Hide button text on very small screens */
            }

            .btn svg {
                width: 16px;
                height: 16px;
                margin: 0;
            }

            /* Content adjustments */
            .content {
                padding: 16px 12px;
            }

            /* Cards */
            .card {
                border-radius: 12px;
                margin-bottom: 16px;
            }

            .card-header {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .card-title {
                font-size: 14px;
            }

            .card-body {
                padding: 12px;
            }

            /* Form elements */
            .form-group {
                margin-bottom: 14px;
            }

            .form-label {
                font-size: 12px;
                margin-bottom: 6px;
            }

            .form-input,
            .form-textarea,
            .form-select {
                font-size: 14px;
                padding: 10px;
            }

            .form-hint {
                font-size: 11px;
            }

            /* Stats - full width on very small screens */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
            }

            .stat-icon svg {
                width: 20px;
                height: 20px;
            }

            .stat-value {
                font-size: 18px;
            }

            .stat-label {
                font-size: 11px;
            }

            /* Alerts */
            .alert {
                padding: 10px 12px;
                font-size: 12px;
            }

            /* Sidebar adjustments */
            .logo {
                padding: 0 16px 16px;
            }

            .logo-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .logo-text {
                font-size: 16px;
            }

            .nav-link {
                padding: 10px 14px;
                font-size: 13px;
            }

            .nav-icon {
                width: 18px;
                height: 18px;
            }

            /* Login page */
            .login-card {
                padding: 24px 16px;
                margin: 12px;
            }

            .login-logo {
                width: 56px;
                height: 56px;
                font-size: 28px;
            }

            .login-title {
                font-size: 20px;
            }

            /* Modal responsive */
            .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-title {
                font-size: 16px;
            }

            .modal-body {
                padding: 16px;
            }

            .wizard-step {
                padding: 14px;
                margin-bottom: 16px;
            }

            .wizard-step-icon {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .wizard-step-title {
                font-size: 14px;
            }

            .wizard-step-desc {
                font-size: 12px;
            }

            /* Checkbox and form controls */
            .checkbox-group {
                flex-direction: row;
                align-items: center;
                gap: 8px;
            }

            .checkbox {
                width: 18px;
                height: 18px;
            }
        }

        /* === Landscape Orientation on Mobile === */
        @media (max-width: 768px) and (orientation: landscape) {
            .sidebar {
                width: 200px;
            }

            .topbar {
                padding: 10px 16px;
                padding-left: 56px;
            }

            .content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* é…ç½®å‘å¯¼æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-body {
            padding: 24px;
        }

        .wizard-step {
            margin-bottom: 24px;
            padding: 20px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .wizard-step:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .wizard-step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .wizard-step-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-light);
            border-radius: 10px;
        }

        .wizard-step-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .wizard-step-desc {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 12px;
            line-height: 1.6;
            white-space: pre-line;
        }

        .wizard-step-hint {
            font-size: 13px;
            color: var(--primary);
            background: var(--primary-light);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .wizard-step-actions {
            display: flex;
            gap: 8px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: var(--gray-50);
            margin-bottom: 8px;
        }

        .check-item.passed {
            background: #D1FAE5;
            border: 1px solid #10B981;
        }

        .check-item.failed {
            background: #FEE2E2;
            border: 1px solid #EF4444;
        }

        .check-icon {
            font-size: 20px;
        }

        .check-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .check-message {
            font-size: 13px;
            color: var(--gray-600);
            margin-top: 4px;
        }

        /* æµç¨‹å›¾æ ·å¼ */
        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 24px;
        }

        .flow-step {
            border-radius: 12px;
            padding: 20px;
            color: white;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .flow-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .flow-step::after {
            content: 'â†“';
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .flow-step:last-child::after {
            display: none;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .step-number {
            background: rgba(255,255,255,0.25);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .step-icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            flex: 1;
        }

        .step-description {
            font-size: 14px;
            line-height: 1.8;
            opacity: 0.95;
            margin-left: 48px;
        }

        .step-detail {
            margin-left: 48px;
            margin-top: 12px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 13px;
            backdrop-filter: blur(10px);
        }

        .step-detail code {
            background: rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .step-detail strong {
            font-weight: 600;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .flow-diagram {
                padding: 16px;
                gap: 20px;
            }

            .flow-step {
                padding: 16px;
            }

            .step-title {
                font-size: 18px;
            }

            .step-description {
                font-size: 13px;
                margin-left: 44px;
            }

            .step-detail {
                margin-left: 44px;
                font-size: 12px;
            }

            .flow-step::after {
                font-size: 24px;
                bottom: -22px;
            }
        }
    </style>
</head>
<body>
    <div id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">âš™ï¸</div>
                <h1 class="login-title">ç³»ç»Ÿç®¡ç†ä¸­å¿ƒ</h1>
                <p class="login-subtitle">è¯·ç™»å½•ä»¥ç®¡ç†ç³»ç»Ÿé…ç½®</p>
            </div>

            <div id="loginMessage" class="alert"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">å¯†ç </label>
                    <input type="password" id="password" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç " required autocomplete="current-password">
                </div>

                <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 10px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <svg width="18" height="18" fill="none" stroke="#0284c7" viewBox="0 0 24 24" style="flex-shrink: 0;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span style="font-weight: 600; color: #0c4a6e; font-size: 14px;">é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·</span>
                    </div>
                    <div style="font-size: 13px; color: #0c4a6e; line-height: 1.6; margin-left: 26px;">
                        <div style="margin-bottom: 4px;">
                            ç”¨æˆ·åï¼š<code style="background: white; padding: 2px 8px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; color: #0284c7; font-weight: 600;">admin</code>
                        </div>
                        <div>
                            å¯†ç ï¼š<code style="background: white; padding: 2px 8px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; color: #0284c7; font-weight: 600;">admin123</code>
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #bae6fd;">
                        <div style="display: flex; align-items: start; gap: 6px; font-size: 12px; color: #f59e0b;">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; margin-top: 1px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span>ç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…ä¿®æ”¹é»˜è®¤å¯†ç </span>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%; justify-content: center;">
                    ç™»å½•
                </button>
            </form>
        </div>
    </div>

    <div id="configContainer">
        <!-- Mobile Menu Toggle Button -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="é–‹å•Ÿé¸å–®">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">âš™ï¸</div>
                <span class="logo-text">ç³»ç»Ÿç®¡ç†</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="server">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                        </svg>
                        æœåŠ¡å™¨é…ç½®
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="cloudflare">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                        </svg>
                        cloudflareåŸŸåé…ç½®
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="llm">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        éªŒè¯ç æ™ºèƒ½æå–
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/logs.html" target="_blank" style="color: #6b7280;">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        å®æ—¶æ—¥å¿— ğŸ”—
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="topbar">
                <h1 class="topbar-title">ç³»ç»Ÿé…ç½®ç®¡ç†</h1>
                <div class="topbar-actions">
                    <button class="btn btn-primary" id="saveBtn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        ä¿å­˜é…ç½®
                    </button>
                    <button class="btn btn-secondary" id="reloadBtn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        é‡è½½é…ç½®
                    </button>
                    <button class="btn btn-ghost" id="logoutBtn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        ç™»å‡º
                    </button>
                </div>
            </div>

            <div class="content">
                <div id="message" class="alert"></div>

                <div class="section-content active" id="section-server">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                                </svg>
                                æœåŠ¡å™¨é…ç½®
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="port">
                                        ç«¯å£ <span class="badge badge-warning">éœ€é‡å¯</span>
                                    </label>
                                    <input type="number" id="port" class="form-input" placeholder="1234">
                                    <div class="form-hint">æœåŠ¡å™¨ç›‘å¬ç«¯å£</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="host">
                                        ä¸»æœºåœ°å€ <span class="badge badge-warning">éœ€é‡å¯</span>
                                    </label>
                                    <input type="text" id="host" class="form-input" placeholder="0.0.0.0">
                                    <div class="form-hint">æœåŠ¡å™¨ç»‘å®šåœ°å€</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="reload" class="checkbox">
                                    <label class="form-label" for="reload" style="margin: 0;">
                                        å¼€å‘æ¨¡å¼è‡ªåŠ¨é‡è½½ <span class="badge badge-warning">éœ€é‡å¯</span>
                                    </label>
                                </div>
                            </div>

                            <!-- ç®¡ç†å‘˜è´¦æˆ·é…ç½® -->
                            <div style="border-top: 1px solid var(--gray-200); margin-top: 24px; padding-top: 24px;">
                                <h3 style="font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 16px;">
                                    ç®¡ç†å‘˜è´¦æˆ· <span class="badge badge-warning">éœ€é‡å¯</span>
                                </h3>
                                <div class="alert alert-warning show">
                                    âš ï¸ ä¿®æ”¹ç®¡ç†å‘˜è´¦æˆ·åéœ€è¦é‡æ–°ç™»å½•
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label" for="adminUsername">ç®¡ç†å‘˜ç”¨æˆ·å</label>
                                        <input type="text" id="adminUsername" class="form-input" placeholder="admin">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="adminPassword">ç®¡ç†å‘˜å¯†ç </label>
                                        <input type="password" id="adminPassword" class="form-input" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                                        <div class="form-hint">ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å¯†ç </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="section-content" id="section-cloudflare">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                </svg>
                                Cloudflare é…ç½® <span class="badge badge-info">å³æ—¶ç”Ÿæ•ˆ</span>
                            </h2>
                            <button class="btn btn-ghost" id="showFlowBtn"
                                    style="padding: 6px 12px; font-size: 13px; text-decoration: none;"
                                    title="æŸ¥çœ‹é‚®ä»¶è½¬å‘å·¥ä½œåŸç†">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                å·¥ä½œåŸç†
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- æŒ‰é’®ç»„ -->
                            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" id="wizardBtn" style="flex: 1; min-width: 150px;">
                                    ğŸ“– é…ç½®å‘å¯¼
                                </button>
                                <button class="btn btn-primary" id="testConnectionBtn" style="flex: 1; min-width: 200px;">
                                    ğŸ” æµ‹è¯•è¿æ¥å¹¶æ£€æŸ¥çŠ¶æ€
                                </button>
                            </div>

                            <!-- ç»“æœæ˜¾ç¤ºåŒº -->
                            <div id="cfHelperResult" class="alert" style="display: none;"></div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="cfAccountId">Cloudflare è´¦æˆ· ID</label>
                                    <input type="text" id="cfAccountId" class="form-input" placeholder="your-account-id">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="cfKvNamespaceId">KV Namespace ID</label>
                                    <input type="text" id="cfKvNamespaceId" class="form-input" placeholder="your-namespace-id">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="cfApiToken">Cloudflare API Token</label>
                                <input type="password" id="cfApiToken" class="form-input" placeholder="your-api-token">
                                <div class="form-hint">
                                    <strong>ğŸ”‘ æ‰€éœ€æƒé™ï¼š</strong><br>
                                    â€¢ <strong>Account Settings: Read</strong> - è¯»å–è´¦æˆ·ä¿¡æ¯<br>
                                    â€¢ <strong>Workers KV Storage: Read</strong> - è¯»å– KV æ•°æ®<br>
                                    â€¢ <strong>Zone: Read</strong> - è¯»å–åŸŸååˆ—è¡¨ï¼ˆåŸŸåæ£€æŸ¥åŠŸèƒ½ï¼‰<br>
                                    â€¢ <strong>Email Routing Rules: Read</strong> - è¯»å– Email Routing é…ç½®ï¼ˆåŸŸåæ£€æŸ¥åŠŸèƒ½ï¼‰<br>
                                    <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" style="color: #3498db; text-decoration: none;">ğŸ“– åˆ›å»º API Token â†’</a>
                                </div>
                            </div>

                            <!-- é…ç½®æ£€æŸ¥å™¨æç¤ºä¿¡æ¯ -->
                            <div class="alert alert-info show" style="margin-top: 16px;">
                                <div style="font-weight: 600; margin-bottom: 6px;">ğŸ’¡ å…³äºé…ç½®æ£€æŸ¥å™¨</div>
                                <div style="font-size: 13px; line-height: 1.6;">
                                    â€¢ å³ä½¿æ£€æŸ¥å™¨æ˜¾ç¤ºé”™è¯¯ï¼Œå¦‚æœæ‚¨çš„é…ç½®æ­£ç¡®ï¼Œ<strong>åŠŸèƒ½å¯èƒ½ä»ç„¶æ­£å¸¸å·¥ä½œ</strong><br>
                                    â€¢ è¿™é€šå¸¸æ˜¯å› ä¸º Docker ç¯å¢ƒå˜é‡æœªæ­£ç¡®æŒ‚è½½æˆ–æƒé™é—®é¢˜å¯¼è‡´æ£€æŸ¥å™¨æ— æ³•è¯»å–é…ç½®<br>
                                    â€¢ <strong>å»ºè®®</strong>ï¼šå…ˆå®é™…æµ‹è¯•åŠŸèƒ½ï¼ˆç”Ÿæˆé‚®ç®±å¹¶å°è¯•æ¥æ”¶é‚®ä»¶ï¼‰ï¼Œå¦‚æœåŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥å¿½ç•¥æ£€æŸ¥å™¨è­¦å‘Š
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                                </svg>
                                åŸŸåç®¡ç† <span class="badge badge-info">å³æ—¶ç”Ÿæ•ˆ</span>
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group" style="display: none;">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="enableCustomDomains" class="checkbox" checked>
                                    <label class="form-label" for="enableCustomDomains" style="margin: 0;">å¯ç”¨è‡ªå®šä¹‰åŸŸå</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="customDomains">è‡ªå®šä¹‰åŸŸååˆ—è¡¨</label>
                                <textarea id="customDomains" class="form-input" placeholder="example.com
your-domain.com
test.com" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;"></textarea>
                                <div class="form-hint">æ¯è¡Œè¾“å…¥ä¸€ä¸ªåŸŸåï¼ˆè‡ªåŠ¨ä½¿ç”¨ Cloudflare KVï¼‰<br>âš ï¸ æ³¨æ„ï¼šåŸŸåå¿…é¡»å·²æ·»åŠ åˆ°æ‚¨çš„ Cloudflare è´¦æˆ·ä¸­å¹¶å®Œæˆ Email Routing é…ç½®</div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="enableBuiltinDomains" class="checkbox">
                                    <label class="form-label" for="enableBuiltinDomains" style="margin: 0;">å¯ç”¨å†…ç½®åŸŸå</label>
                                </div>
                                <div class="form-hint" style="margin-left: 28px;">20 ä¸ªé¢„è®¾çš„ä¸´æ—¶é‚®ç®±åŸŸåï¼ˆè‡ªåŠ¨ä½¿ç”¨å¤–éƒ¨ APIï¼‰</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-content" id="section-llm">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                éªŒè¯ç æ™ºèƒ½æå– <span class="badge badge-info">å³æ—¶ç”Ÿæ•ˆ</span>
                            </h2>
                            <a href="/docs#/email/get_codes_api_email__token__codes_get" target="_blank" class="btn btn-ghost" style="padding: 6px 12px; font-size: 13px; text-decoration: none;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                API æ–‡æ¡£
                            </a>
                        </div>
                        <div class="card-body">
                            <!-- LLM éªŒè¯ç æå–é»˜è®¤å·²å¯ç”¨ï¼Œæ— éœ€æ˜¾ç¤ºå¼€å…³ -->
                            <div class="form-group" style="display: none;">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="useLlmExtraction" class="checkbox" checked>
                                    <label class="form-label" for="useLlmExtraction" style="margin: 0;">å¯ç”¨ LLM éªŒè¯ç æå–</label>
                                </div>
                                <div class="form-hint" style="margin-left: 28px;">ä½¿ç”¨ AI æ¨¡å‹æ™ºèƒ½è¯†åˆ«éªŒè¯ç </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="openaiApiKey">OpenAI API Key</label>
                                <input type="password" id="openaiApiKey" class="form-input" placeholder="sk-xxx æˆ– ak-xxx">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="openaiApiBase">API Base URL</label>
                                <input type="text" id="openaiApiBase" class="form-input" placeholder="https://api.openai.com/v1">
                                <div class="form-hint">è‡ªå®šä¹‰ API ç«¯ç‚¹ï¼ˆæ”¯æŒå…¼å®¹æœåŠ¡ï¼‰</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="openaiModel">
                                    æ¨¡å‹åç§°
                                    <button type="button" class="btn btn-ghost" id="detectModelsBtn"
                                            style="margin-left: 8px; padding: 4px 10px; font-size: 12px;"
                                            title="ä» API ç«¯ç‚¹è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨">
                                        ğŸ” è‡ªåŠ¨æ£€æµ‹
                                    </button>
                                </label>
                                <div style="position: relative;">
                                    <select id="openaiModelSelect" class="form-input" style="display: none;">
                                        <option value="">-- ä»ä¸‹æ‹‰é€‰æ‹©æˆ–åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥ --</option>
                                    </select>
                                    <input type="text" id="openaiModel" class="form-input"
                                           placeholder="gpt-3.5-turboï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰">
                                    <button type="button" id="toggleModelInput" class="btn btn-ghost"
                                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 4px 8px; font-size: 12px;"
                                            title="åˆ‡æ¢è¾“å…¥æ–¹å¼">
                                        ğŸ“‹ åˆ‡æ¢
                                    </button>
                                </div>
                                <div class="form-hint" id="modelHint">
                                    æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªåŠ¨æ£€æµ‹ã€åŠ è½½æ¨¡å‹åˆ—è¡¨ååˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="defaultCodeExtractionMethod">
                                    å‰ç«¯é»˜è®¤æå–æ–¹æ³•
                                    <span class="badge badge-info">å‰ç«¯é»˜è®¤</span>
                                </label>
                                <select id="defaultCodeExtractionMethod" class="form-input" style="cursor: pointer;">
                                    <option value="llm">ğŸ¤– LLM æ™ºèƒ½æå–ï¼ˆAI åˆ†æï¼‰</option>
                                    <option value="pattern">ğŸ“Œ æ¨¡å¼è®­ç»ƒæå–ï¼ˆåŸºäºå­¦ä¹ ï¼‰</option>
                                </select>
                                <div class="form-hint">
                                    è®¾ç½®å‰ç«¯è°ƒç”¨ API æ—¶çš„é»˜è®¤æå–æ–¹æ³•ã€‚LLM æ¨¡å¼æ›´æ™ºèƒ½ä½†éœ€è¦ API Keyï¼Œæ¨¡å¼è®­ç»ƒåŸºäºç®¡ç†å‘˜å­¦ä¹ çš„è§„åˆ™ï¼Œæˆæœ¬æ›´ä½ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                æ¨¡å¼è®­ç»ƒ <span class="badge badge-info">å³æ—¶ç”Ÿæ•ˆ</span>
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info show">
                                â„¹ï¸ ç²˜è´´é‚®ä»¶æ ·æœ¬ï¼Œé€‰ä¸­éªŒè¯ç æ–‡æœ¬åç‚¹å‡»ã€Œå­¦ä¹ æ¨¡å¼ã€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å…³é”®è¯å¹¶ä¿å­˜æå–è§„åˆ™
                            </div>
                            
                            <!-- é‚®ä»¶æ ·æœ¬è¾“å…¥ -->
                            <div class="form-group">
                                <label class="form-label" for="emailSample">é‚®ä»¶æ ·æœ¬</label>
                                <textarea id="emailSample" class="form-input"
                                          placeholder="ç²˜è´´é‚®ä»¶å†…å®¹ï¼Œç„¶åé€‰ä¸­éªŒè¯ç è¿›è¡Œè®­ç»ƒ...&#10;&#10;ä¾‹å¦‚ï¼š&#10;æ‚¨çš„éªŒè¯ç æ˜¯ï¼š123456&#10;æœ‰æ•ˆæœŸä¸º5åˆ†é’Ÿ"
                                          style="min-height: 200px; font-family: monospace; font-size: 13px;"></textarea>
                                <div class="form-hint">
                                    ğŸ’¡ <strong>æ“ä½œæ­¥éª¤ï¼š</strong>
                                    â‘  ç²˜è´´é‚®ä»¶å†…å®¹åˆ°ä¸Šæ–¹æ–‡æœ¬æ¡† â†’
                                    â‘¡ ä½¿ç”¨é¼ æ ‡æ‹–åŠ¨é€‰ä¸­éªŒè¯ç æ–‡æœ¬ï¼ˆä¾‹å¦‚ <code>123456</code>ï¼‰â†’
                                    â‘¢ ã€ŒğŸ“Œ å­¦ä¹ é€‰ä¸­çš„éªŒè¯ç æ¨¡å¼ã€æŒ‰é’®ä¼šè‡ªåŠ¨æ¿€æ´» â†’
                                    â‘£ ç‚¹å‡»æŒ‰é’®å®Œæˆè®­ç»ƒ
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="form-group" style="display: flex; gap: 12px;">
                                <button id="learnPatternBtn" class="btn btn-primary" disabled>
                                    ğŸ“Œ å­¦ä¹ é€‰ä¸­çš„éªŒè¯ç æ¨¡å¼
                                </button>
                                <button id="clearSampleBtn" class="btn btn-secondary">
                                    ğŸ—‘ï¸ æ¸…ç©º
                                </button>
                            </div>
                            
                            <!-- å·²å­¦ä¹ æ¨¡å¼åˆ—è¡¨ -->
                            <div class="form-group">
                                <label class="form-label">
                                    å·²å­¦ä¹ çš„æ¨¡å¼
                                    <button class="btn btn-ghost" style="margin-left: 12px; padding: 4px 12px; font-size: 12px;" onclick="loadPatterns()">
                                        ğŸ”„ é‡æ–°åŠ è½½
                                    </button>
                                </label>
                                <div id="patternsList" style="margin-top: 12px;">
                                    <div style="text-align: center; padding: 20px; color: var(--gray-500);">
                                        åŠ è½½ä¸­...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- é…ç½®å‘å¯¼æ¨¡æ€æ¡† -->
    <div id="wizardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“– Cloudflare é…ç½®å‘å¯¼</h3>
                <button class="modal-close" onclick="closeWizardModal()">âœ•</button>
            </div>
            <div class="modal-body" id="wizardSteps">
                <!-- åŠ¨æ€åŠ è½½å‘å¯¼æ­¥éª¤ -->
            </div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨é…ç½®è¯´æ˜æ¨¡æ€æ¡† -->
    <div id="manualConfigModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“ æ‰‹åŠ¨éƒ¨ç½²é…ç½®è¯´æ˜</h3>
                <button class="modal-close" onclick="closeManualConfigModal()">âœ•</button>
            </div>
            <div class="modal-body" id="manualConfigContent">
                <!-- åŠ¨æ€åŠ è½½æ‰‹åŠ¨é…ç½®å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- å·¥ä½œåŸç†æµç¨‹å›¾æ¨¡æ€æ¡† -->
    <div id="flowDiagramModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“§ é‚®ä»¶è½¬å‘å·¥ä½œåŸç†</h3>
                <button class="modal-close" onclick="closeFlowDiagramModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <!-- å›¾å½¢åŒ–æµç¨‹å›¾ -->
                <div class="flow-diagram">
                    <!-- æ­¥éª¤ 1: ç”¨æˆ·å‘é€é‚®ä»¶ -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="step-header">
                            <div class="step-number">â‘ </div>
                            <div class="step-icon">ğŸ“§</div>
                            <div class="step-title">ç”¨æˆ·å‘é€é‚®ä»¶</div>
                        </div>
                        <div class="step-description">
                            ç”¨æˆ·å‘ä¸´æ—¶é‚®ç®±åœ°å€å‘é€é‚®ä»¶ï¼ˆä¾‹å¦‚ï¼štest@yourdomain.comï¼‰<br>
                            é‚®ä»¶æœåŠ¡å™¨æŸ¥è¯¢ DNS MX è®°å½•ï¼Œç¡®å®šé‚®ä»¶æ¥æ”¶æœåŠ¡å™¨
                        </div>
                        <div class="step-detail">
                            <strong>ç¤ºä¾‹ï¼š</strong> gmail.com â†’ DNS æŸ¥è¯¢ â†’ yourdomain.com MX è®°å½•
                        </div>
                    </div>

                    <!-- æ­¥éª¤ 2: Cloudflare DNS -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="step-header">
                            <div class="step-number">â‘¡</div>
                            <div class="step-icon">â˜ï¸</div>
                            <div class="step-title">Cloudflare DNS è§£æ</div>
                        </div>
                        <div class="step-description">
                            DNS MX è®°å½•æŒ‡å‘ Cloudflare Email Routing<br>
                            é‚®ä»¶è¢«è·¯ç”±åˆ° Cloudflare åŸºç¡€è®¾æ–½è¿›è¡Œå¤„ç†
                        </div>
                        <div class="step-detail">
                            <strong>MX è®°å½•ï¼š</strong> yourdomain.com â†’ isaac.mx.cloudflare.net (ä¼˜å…ˆçº§ 10)
                        </div>
                    </div>

                    <!-- æ­¥éª¤ 3: Email Routing -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="step-header">
                            <div class="step-number">â‘¢</div>
                            <div class="step-icon">ğŸ“¨</div>
                            <div class="step-title">Cloudflare Email Routing</div>
                        </div>
                        <div class="step-description">
                            Cloudflare æ¥æ”¶é‚®ä»¶å¹¶éªŒè¯å‘ä»¶äºº<br>
                            è§¦å‘é…ç½®çš„ Email Worker è¿›è¡Œè‡ªå®šä¹‰å¤„ç†
                        </div>
                        <div class="step-detail">
                            <strong>é…ç½®ä½ç½®ï¼š</strong> Cloudflare Dashboard â†’ Email â†’ Email Routing â†’ Routes
                        </div>
                    </div>

                    <!-- æ­¥éª¤ 4: Email Worker -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="step-header">
                            <div class="step-number">â‘£</div>
                            <div class="step-icon">âš™ï¸</div>
                            <div class="step-title">Email Worker å¤„ç†</div>
                        </div>
                        <div class="step-description">
                            JavaScript Worker æ‹¦æˆªé‚®ä»¶å¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š<br>
                            â€¢ è§£æé‚®ä»¶å†…å®¹ï¼ˆçº¯æ–‡æœ¬ + HTMLï¼‰<br>
                            â€¢ æå–å‘ä»¶äººã€æ”¶ä»¶äººã€ä¸»é¢˜ã€æ—¶é—´æˆ³<br>
                            â€¢ ç”Ÿæˆå”¯ä¸€çš„é‚®ä»¶ IDï¼ˆåŸºäºå†…å®¹å“ˆå¸Œï¼‰
                        </div>
                        <div class="step-detail">
                            <strong>Worker æ–‡ä»¶ï¼š</strong> workers/email-handler.js
                        </div>
                    </div>

                    <!-- æ­¥éª¤ 5: Workers KV Storage -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="step-header">
                            <div class="step-number">â‘¤</div>
                            <div class="step-icon">ğŸ’¾</div>
                            <div class="step-title">å­˜å‚¨åˆ° Workers KV</div>
                        </div>
                        <div class="step-description">
                            å°†é‚®ä»¶æ•°æ®å­˜å‚¨åˆ° Cloudflare Workers KVï¼ˆé”®å€¼æ•°æ®åº“ï¼‰<br>
                            â€¢ Key æ ¼å¼ï¼š<code>mail:{é‚®ç®±åœ°å€}:{æ—¶é—´æˆ³}</code><br>
                            â€¢ è‡ªåŠ¨è®¾ç½® 1 å°æ—¶è¿‡æœŸæ—¶é—´ï¼ˆTTL=3600 ç§’ï¼‰<br>
                            â€¢ ç»´æŠ¤æ¯ä¸ªé‚®ç®±çš„é‚®ä»¶ç´¢å¼•åˆ—è¡¨ï¼ˆæœ€å¤š 50 å°ï¼‰
                        </div>
                        <div class="step-detail">
                            <strong>ç¤ºä¾‹ Keyï¼š</strong> mail:test@example.com:1704096000000
                        </div>
                    </div>

                    <!-- æ­¥éª¤ 6: FastAPI åç«¯ -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <div class="step-header">
                            <div class="step-number">â‘¥</div>
                            <div class="step-icon">ğŸ</div>
                            <div class="step-title">FastAPI åç«¯è¯»å–</div>
                        </div>
                        <div class="step-description">
                            Python åç«¯é€šè¿‡ Cloudflare KV API è¯»å–æ•°æ®ï¼š<br>
                            â€¢ ä½¿ç”¨ Account ID + Namespace ID + API Token è®¤è¯<br>
                            â€¢ è°ƒç”¨ Cloudflare REST API è·å–é‚®ä»¶<br>
                            â€¢ è¿”å› JSON æ ¼å¼çš„é‚®ä»¶æ•°æ®ç»™å‰ç«¯
                        </div>
                        <div class="step-detail">
                            <strong>API ç«¯ç‚¹ï¼š</strong> GET /api/email/{token}/mails
                        </div>
                    </div>

                    <!-- æ­¥éª¤ 7: ç”¨æˆ·æŸ¥çœ‹ -->
                    <div class="flow-step" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <div class="step-header">
                            <div class="step-number">â‘¦</div>
                            <div class="step-icon">ğŸŒ</div>
                            <div class="step-title">ç”¨æˆ·æŸ¥çœ‹é‚®ä»¶</div>
                        </div>
                        <div class="step-description">
                            Web å‰ç«¯æ˜¾ç¤ºé‚®ä»¶å†…å®¹ï¼š<br>
                            â€¢ æ˜¾ç¤ºé‚®ä»¶åˆ—è¡¨ï¼ˆå‘ä»¶äººã€ä¸»é¢˜ã€æ—¶é—´ï¼‰<br>
                            â€¢ æ˜¾ç¤ºé‚®ä»¶è¯¦ç»†å†…å®¹ï¼ˆçº¯æ–‡æœ¬ + HTMLï¼‰<br>
                            â€¢ è‡ªåŠ¨æå–éªŒè¯ç ï¼ˆä½¿ç”¨ LLM æˆ–æ­£åˆ™è¡¨è¾¾å¼ï¼‰
                        </div>
                        <div class="step-detail">
                            <strong>å‰ç«¯é¡µé¢ï¼š</strong> http://localhost:1234/
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨è¯´æ˜ -->
                <div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">ğŸ’¡ æŠ€æœ¯ä¼˜åŠ¿</div>
                    <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; font-size: 14px; line-height: 1.8;">
                        <li><strong>é›¶æˆæœ¬</strong>ï¼šCloudflare Workers KV å…è´¹é¢åº¦å……è¶³ï¼ˆæ¯å¤© 10 ä¸‡æ¬¡è¯»å–ï¼‰</li>
                        <li><strong>é«˜æ€§èƒ½</strong>ï¼šå…¨çƒ CDN èŠ‚ç‚¹ï¼Œæ¯«ç§’çº§å“åº”é€Ÿåº¦</li>
                        <li><strong>å®‰å…¨å¯é </strong>ï¼šé‚®ä»¶è‡ªåŠ¨è¿‡æœŸï¼Œæ— éœ€æ‹…å¿ƒæ•°æ®æ³„éœ²</li>
                        <li><strong>æ˜“äºæ‰©å±•</strong>ï¼šæ”¯æŒå¤šä¸ªè‡ªå®šä¹‰åŸŸåï¼Œè½»æ¾æ‰©å±•ä¸´æ—¶é‚®ç®±æœåŠ¡</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const loginContainer = document.getElementById('loginContainer');
        const configContainer = document.getElementById('configContainer');
        const loginMessage = document.getElementById('loginMessage');
        const message = document.getElementById('message');

        // å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const section = link.dataset.section;

                // è·³è¿‡å¤–éƒ¨é“¾æ¥ï¼ˆå¦‚å®æ—¶æ—¥å¿—ï¼‰
                if (!section) {
                    return; // å…è®¸é»˜è®¤è¡Œä¸ºï¼ˆæ‰“å¼€é“¾æ¥ï¼‰
                }

                e.preventDefault();

                // æ›´æ–°å¯¼èˆªçŠ¶æ€
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // æ˜¾ç¤ºå¯¹åº”åŒºå—
                document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
                document.getElementById('section-' + section).classList.add('active');

                // åœ¨ç§»å‹•ç«¯é»æ“Šå°èˆªå¾Œè‡ªå‹•é—œé–‰å´é‚Šæ¬„
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            });
        });

        // ç§»å‹•ç«¯é¸å–®æ§åˆ¶
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function openSidebar() {
            sidebar.classList.add('show');
            sidebarOverlay.style.display = 'block';
            setTimeout(() => {
                sidebarOverlay.classList.add('show');
            }, 10);
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        }

        function closeSidebar() {
            sidebar.classList.remove('show');
            sidebarOverlay.classList.remove('show');
            setTimeout(() => {
                sidebarOverlay.style.display = 'none';
            }, 300);
            document.body.style.overflow = ''; // æ¢å¾©æ»¾å‹•
        }

        // æ¼¢å ¡é¸å–®æŒ‰éˆ•é»æ“Š
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                if (sidebar.classList.contains('show')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
        }

        // é»æ“Šé®ç½©å±¤é—œé–‰å´é‚Šæ¬„
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeSidebar);
        }

        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–,åœ¨æ¡Œé¢æ¨¡å¼ä¸‹ç§»é™¤ç§»å‹•ç«¯é¡åˆ¥
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('show');
                sidebarOverlay.style.display = 'none';
                sidebarOverlay.classList.remove('show');
                document.body.style.overflow = '';
            }
        });

        function showMessage(element, text, type) {
            // æ”¯æŒç”¨ | åˆ†éš”å¤šè¡Œæ¶ˆæ¯ï¼ˆç”¨äºåç«¯è¿”å›çš„è¯¦ç»†é…ç½®ä¿¡æ¯ï¼‰
            if (text.includes('|')) {
                element.innerHTML = text.split('|').map(line => line.trim()).join('<br>');
            } else {
                element.textContent = text;
            }
            element.className = `alert alert-${type} show`;
            // æ ¹æ®æ¶ˆæ¯é•¿åº¦åŠ¨æ€è°ƒæ•´æ˜¾ç¤ºæ—¶é—´ï¼ˆæœ€å°‘ 5 ç§’ï¼Œæœ€å¤š 30 ç§’ï¼‰
            const messageLength = text.length;
            const displayTime = Math.min(30000, Math.max(5000, messageLength * 5));
            setTimeout(() => {
                element.className = 'alert';
            }, displayTime);
        }

        // æ£€æŸ¥ JWT
        async function checkSession() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                return false;
            }

            try {
                const response = await fetch('/admin/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.authenticated) {
                    await loadConfig();
                    loginContainer.style.display = 'none';
                    configContainer.style.display = 'block';
                    return true;
                } else {
                    // Token æ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                    localStorage.removeItem('admin_token');
                    return false;
                }
            } catch (error) {
                // è¯·æ±‚å¤±è´¥ï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('admin_token');
                return false;
            }
        }

        // ç™»å…¥
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('loginBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> ç™»å½•ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // ä¿å­˜ JWT åˆ° localStorage
                    localStorage.setItem('admin_token', data.token);
                    showMessage(loginMessage, 'ç™»å½•æˆåŠŸï¼', 'success');
                    await loadConfig();
                    loginContainer.style.display = 'none';
                    configContainer.style.display = 'block';
                } else {
                    showMessage(loginMessage, data.detail || 'ç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage(loginMessage, 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // è½½å…¥é…ç½®
        async function loadConfig() {
            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    throw new Error('æœªç™»å½•');
                }

                const response = await fetch('/admin/config/env', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('æœªæˆæƒ');
                }

                const data = await response.json();
                const config = data.config;

                // Server
                document.getElementById('port').value = config.server?.port || '';
                document.getElementById('host').value = config.server?.host || '';
                document.getElementById('reload').checked = (config.server?.reload === 'true');

                // Domains - å¤„ç†è‡ªå®šä¹‰åŸŸååˆ—è¡¨
                const customDomains = config.domains?.custom_domains || '';

                // è°ƒè¯•è¾“å‡ºï¼šæ˜¾ç¤ºåŸå§‹æ•°æ®
                console.log('åŸå§‹è‡ªå®šä¹‰åŸŸåæ•°æ®:', customDomains, 'ç±»å‹:', typeof customDomains);

                // æ™ºèƒ½å¤„ç†å„ç§å¯èƒ½çš„åŸŸåæ ¼å¼å¹¶è½¬æ¢ä¸ºæ¯è¡Œä¸€ä¸ªåŸŸåçš„æ ¼å¼
                let displayValue = '';
                if (customDomains && customDomains.trim() !== '') {
                    try {
                        // é¦–å…ˆå°è¯•ä½œä¸º JSON è§£æ
                        let parsed;

                        // å¤„ç†å¯èƒ½çš„è½¬ä¹‰å­—ç¬¦
                        let cleanInput = customDomains;
                        if (customDomains.includes('\\"')) {
                            cleanInput = customDomains.replace(/\\"/g, '"');
                        }

                        // å°è¯•è§£æä¸º JSON
                        parsed = JSON.parse(cleanInput);

                        if (Array.isArray(parsed)) {
                            // æ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºå¤šè¡Œæ ¼å¼
                            displayValue = parsed.filter(domain => domain && domain.trim()).join('\n');
                        } else if (typeof parsed === 'string') {
                            // æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
                            displayValue = parsed.trim();
                        } else {
                            throw new Error('éé¢„æœŸçš„æ•°æ®ç±»å‹');
                        }
                    } catch (jsonError) {
                        // JSON è§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                        console.log('JSON è§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼:', jsonError);

                        // ç§»é™¤å¯èƒ½çš„å¼•å·
                        let cleanValue = customDomains.replace(/^["']|["']$/g, '');

                        // æ£€æŸ¥æ˜¯å¦åŒ…å«é€—å·ï¼ˆå¯èƒ½æ˜¯é€—å·åˆ†éš”ï¼‰
                        if (cleanValue.includes(',')) {
                            displayValue = cleanValue
                                .split(',')
                                .map(domain => domain.trim())
                                .filter(domain => domain.length > 0)
                                .join('\n');
                        } else if (cleanValue.includes('\n')) {
                            // å·²ç»æ˜¯å¤šè¡Œæ ¼å¼
                            displayValue = cleanValue;
                        } else if (cleanValue.trim().length > 0) {
                            // å•ä¸€åŸŸå
                            displayValue = cleanValue.trim();
                        }
                        // å¦‚æœå…¨éƒ¨éƒ½å¤±è´¥ï¼ŒdisplayValue ä¿æŒä¸ºç©ºå­—ç¬¦ä¸²
                    }
                }

                // è°ƒè¯•è¾“å‡ºï¼šæ˜¾ç¤ºå¤„ç†åçš„ç»“æœ
                console.log('å¤„ç†åçš„åŸŸåæ˜¾ç¤ºå€¼:', displayValue);

                document.getElementById('customDomains').value = displayValue;

                document.getElementById('enableCustomDomains').checked = true; // å§‹ç»ˆä¸º trueï¼ˆå·²éšè— UIï¼‰
                document.getElementById('enableBuiltinDomains').checked = (config.domains?.enable_builtin_domains === 'true');

                // Cloudflare (KV checkbox removed - always enabled)
                document.getElementById('cfAccountId').value = config.cloudflare?.cf_account_id || '';
                document.getElementById('cfKvNamespaceId').value = config.cloudflare?.cf_kv_namespace_id || '';
                document.getElementById('cfApiToken').value = config.cloudflare?.cf_api_token || '';

                // LLM
                document.getElementById('useLlmExtraction').checked = (config.llm?.use_llm_extraction === 'true');
                document.getElementById('openaiApiKey').value = config.llm?.openai_api_key || '';
                document.getElementById('openaiApiBase').value = config.llm?.openai_api_base || '';
                document.getElementById('openaiModel').value = config.llm?.openai_model || '';
                document.getElementById('defaultCodeExtractionMethod').value = config.llm?.default_code_extraction_method || 'llm';

                // Admin
                document.getElementById('adminUsername').value = config.admin?.admin_username || '';

            } catch (error) {
                console.error('åŠ è½½é…ç½®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage(message, 'åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');

                // å¦‚æœæ˜¯åŸŸåé…ç½®é—®é¢˜ï¼Œè®¾ç½®ä¸ºç©ºå€¼ä»¥é¿å…æ˜¾ç¤ºé”™è¯¯æ•°æ®
                if (error.message.includes('domain') || error.message.includes('JSON')) {
                    document.getElementById('customDomains').value = '';
                }
            }
        }

        // æ¨¡å‹è¾“å…¥æ¨¡å¼åˆ‡æ¢
        let isSelectMode = false;  // å½“å‰æ˜¯å¦ä¸ºä¸‹æ‹‰é€‰æ‹©æ¨¡å¼
        let availableModels = [];  // å­˜å‚¨å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨

        // åˆ‡æ¢è¾“å…¥æ–¹å¼æŒ‰é’®
        document.getElementById('toggleModelInput')?.addEventListener('click', function() {
            const modelInput = document.getElementById('openaiModel');
            const modelSelect = document.getElementById('openaiModelSelect');
            const modelHint = document.getElementById('modelHint');

            // å¦‚æœå½“å‰æ˜¯æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼Œæƒ³åˆ‡æ¢åˆ°ä¸‹æ‹‰æ¨¡å¼ï¼Œéœ€è¦å…ˆæœ‰æ¨¡å‹åˆ—è¡¨
            if (!isSelectMode && availableModels.length === 0) {
                modelHint.style.color = '#e74c3c';
                modelHint.textContent = 'âš ï¸ è¯·å…ˆç‚¹å‡»ã€Œè‡ªåŠ¨æ£€æµ‹ã€åŠ è½½æ¨¡å‹åˆ—è¡¨';
                setTimeout(() => {
                    modelHint.style.color = '';
                    modelHint.textContent = 'æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªåŠ¨æ£€æµ‹ã€åŠ è½½æ¨¡å‹åˆ—è¡¨ååˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©';
                }, 3000);
                return;
            }

            // åˆ‡æ¢æ¨¡å¼
            isSelectMode = !isSelectMode;

            if (isSelectMode) {
                // åˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©æ¨¡å¼
                modelInput.style.display = 'none';
                modelSelect.style.display = 'block';
                this.textContent = 'âŒ¨ï¸ æ‰‹åŠ¨è¾“å…¥';
                modelHint.textContent = `ä»ä¸‹æ‹‰é€‰æ‹©æ¨¡å‹ï¼ˆå…± ${availableModels.length} ä¸ªï¼‰`;

                // åŒæ­¥å½“å‰å€¼
                if (modelInput.value.trim()) {
                    modelSelect.value = modelInput.value.trim();
                }
            } else {
                // åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼ˆæ€»æ˜¯å…è®¸åˆ‡æ¢å›æ¥ï¼‰
                modelInput.style.display = 'block';
                modelSelect.style.display = 'none';
                this.textContent = 'ğŸ“‹ ä¸‹æ‹‰é€‰æ‹©';
                modelHint.textContent = 'æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªåŠ¨æ£€æµ‹ã€ä» API åŠ è½½å¯ç”¨æ¨¡å‹åˆ—è¡¨';

                // åŒæ­¥å½“å‰å€¼
                if (modelSelect.value) {
                    modelInput.value = modelSelect.value;
                }
            }
        });

        // ä¸‹æ‹‰é€‰æ‹©æ”¹å˜æ—¶åŒæ­¥åˆ°è¾“å…¥æ¡†
        document.getElementById('openaiModelSelect')?.addEventListener('change', function() {
            document.getElementById('openaiModel').value = this.value;
        });

        // è‡ªå‹•æª¢æ¸¬å¯ç”¨çš„ AI æ¨¡å‹
        document.getElementById('detectModelsBtn')?.addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            const modelInput = document.getElementById('openaiModel');
            const modelSelect = document.getElementById('openaiModelSelect');
            const modelHint = document.getElementById('modelHint');
            const toggleBtn = document.getElementById('toggleModelInput');

            // è·å–å½“å‰é…ç½®
            const apiBase = document.getElementById('openaiApiBase').value.trim();
            const apiKey = document.getElementById('openaiApiKey').value.trim();

            // éªŒè¯å¿…éœ€å‚æ•°
            if (!apiBase) {
                modelHint.style.color = '#e74c3c';
                modelHint.textContent = 'âš ï¸ è¯·å…ˆå¡«å†™ API Base URL';
                setTimeout(() => {
                    modelHint.style.color = '';
                    modelHint.textContent = 'æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªåŠ¨æ£€æµ‹ã€åŠ è½½æ¨¡å‹åˆ—è¡¨ååˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©';
                }, 3000);
                return;
            }

            if (!apiKey) {
                modelHint.style.color = '#e74c3c';
                modelHint.textContent = 'âš ï¸ è¯·å…ˆå¡«å†™ API Key';
                setTimeout(() => {
                    modelHint.style.color = '';
                    modelHint.textContent = 'æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªåŠ¨æ£€æµ‹ã€åŠ è½½æ¨¡å‹åˆ—è¡¨ååˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©';
                }, 3000);
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.innerHTML = 'â³ æ£€æµ‹ä¸­...';
            modelHint.style.color = '#3498db';
            modelHint.textContent = 'ğŸ” æ­£åœ¨ä» API è·å–æ¨¡å‹åˆ—è¡¨...';

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/admin/llm/models', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        openai_api_base: apiBase,
                        openai_api_key: apiKey
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.models && result.models.length > 0) {
                    // å­˜å‚¨æ¨¡å‹åˆ—è¡¨
                    availableModels = result.models;

                    // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
                    modelSelect.innerHTML = '<option value="">-- é€‰æ‹©ä¸€ä¸ªæ¨¡å‹ --</option>';
                    result.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });

                    // å¦‚æœå½“å‰è¾“å…¥æ¡†ä¸ºç©ºï¼Œè‡ªåŠ¨å¡«å…¥ç¬¬ä¸€ä¸ªæ¨¡å‹
                    if (!modelInput.value.trim() && result.models.length > 0) {
                        modelInput.value = result.models[0];
                        modelSelect.value = result.models[0];
                    } else if (modelInput.value.trim()) {
                        // åŒæ­¥ç°æœ‰å€¼åˆ°ä¸‹æ‹‰æ¡†
                        modelSelect.value = modelInput.value.trim();
                    }

                    // è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©æ¨¡å¼
                    isSelectMode = true;
                    modelInput.style.display = 'none';
                    modelSelect.style.display = 'block';
                    toggleBtn.textContent = 'âŒ¨ï¸ æ‰‹åŠ¨è¾“å…¥';

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    modelHint.style.color = '#27ae60';
                    modelHint.textContent = `âœ… æˆåŠŸæ£€æµ‹åˆ° ${result.models.length} ä¸ªå¯ç”¨æ¨¡å‹ï¼å·²è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©`;

                    // 3ç§’åæ¢å¤æç¤º
                    setTimeout(() => {
                        modelHint.style.color = '';
                        modelHint.textContent = `ä»ä¸‹æ‹‰é€‰æ‹©æ¨¡å‹ï¼ˆå…± ${result.models.length} ä¸ªï¼‰ï¼Œæˆ–ç‚¹å‡»ã€ŒâŒ¨ï¸ æ‰‹åŠ¨è¾“å…¥ã€åˆ‡æ¢`;
                    }, 3000);
                } else {
                    // API è¿”å›å¤±è´¥
                    availableModels = [];
                    modelHint.style.color = '#e74c3c';
                    modelHint.textContent = `âŒ ${result.message || 'æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨'}`;

                    setTimeout(() => {
                        modelHint.style.color = '';
                        modelHint.textContent = 'æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªåŠ¨æ£€æµ‹ã€åŠ è½½æ¨¡å‹åˆ—è¡¨ååˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©';
                    }, 5000);
                }
            } catch (error) {
                console.error('æ£€æµ‹æ¨¡å‹å¤±è´¥:', error);
                availableModels = [];
                modelHint.style.color = '#e74c3c';
                modelHint.textContent = `âŒ æ£€æµ‹å¤±è´¥: ${error.message}`;

                setTimeout(() => {
                    modelHint.style.color = '';
                    modelHint.textContent = 'æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªåŠ¨æ£€æµ‹ã€åŠ è½½æ¨¡å‹åˆ—è¡¨ååˆ‡æ¢åˆ°ä¸‹æ‹‰é€‰æ‹©';
                }, 5000);
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // ä¿å­˜é…ç½®
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> ä¿å­˜ä¸­...';
            btn.disabled = true;

            try {
                const configData = {};

                // Server
                if (document.getElementById('port').value) {
                    configData.port = parseInt(document.getElementById('port').value);
                }
                if (document.getElementById('host').value) {
                    configData.host = document.getElementById('host').value;
                }
                configData.reload = document.getElementById('reload').checked;

                // Domains - å°†å¤šè¡ŒåŸŸåè½¬æ¢ä¸º JSON æ•°ç»„æ ¼å¼
                const domainsInput = document.getElementById('customDomains').value.trim();
                if (domainsInput) {
                    // æŒ‰è¡Œåˆ†å‰²å¹¶è¿‡æ»¤ç©ºè¡Œ
                    const domainsArray = domainsInput
                        .split('\n')
                        .map(domain => domain.trim())
                        .filter(domain => domain.length > 0);

                    // è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
                    configData.custom_domains = JSON.stringify(domainsArray);
                }
                configData.enable_custom_domains = true; // å§‹ç»ˆå¯ç”¨è‡ªå®šä¹‰åŸŸåï¼ˆå·²éšè— UI å¹¶é»˜è®¤é€‰ä¸­ï¼‰
                configData.enable_builtin_domains = document.getElementById('enableBuiltinDomains').checked;

                // Cloudflare (KV always enabled)
                configData.use_cloudflare_kv = true;
                if (document.getElementById('cfAccountId').value) {
                    configData.cf_account_id = document.getElementById('cfAccountId').value;
                }
                if (document.getElementById('cfKvNamespaceId').value) {
                    configData.cf_kv_namespace_id = document.getElementById('cfKvNamespaceId').value;
                }
                if (document.getElementById('cfApiToken').value) {
                    configData.cf_api_token = document.getElementById('cfApiToken').value;
                }

                // LLM
                configData.use_llm_extraction = document.getElementById('useLlmExtraction').checked;
                if (document.getElementById('openaiApiKey').value) {
                    configData.openai_api_key = document.getElementById('openaiApiKey').value;
                }
                if (document.getElementById('openaiApiBase').value) {
                    configData.openai_api_base = document.getElementById('openaiApiBase').value;
                }
                if (document.getElementById('openaiModel').value) {
                    configData.openai_model = document.getElementById('openaiModel').value;
                }
                if (document.getElementById('defaultCodeExtractionMethod').value) {
                    configData.default_code_extraction_method = document.getElementById('defaultCodeExtractionMethod').value;
                }

                // Admin
                if (document.getElementById('adminUsername').value) {
                    configData.admin_username = document.getElementById('adminUsername').value;
                }
                if (document.getElementById('adminPassword').value) {
                    configData.admin_password = document.getElementById('adminPassword').value;
                }
                // JWT å¯†é’¥ä¸å…è®¸ä»ç®¡ç†ç•Œé¢ä¿®æ”¹ï¼Œåªèƒ½é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
                // if (document.getElementById('adminSecretKey').value) {
                //     configData.admin_secret_key = document.getElementById('adminSecretKey').value;
                // }

                const token = localStorage.getItem('admin_token');
                if (!token) {
                    showMessage(message, 'âŒ è¯·å…ˆç™»å½•', 'error');
                    return;
                }

                const response = await fetch('/admin/config/env', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(configData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showMessage(message, data.message || 'âœ… é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                } else {
                    showMessage(message, 'âŒ ' + (data.detail || 'ä¿å­˜å¤±è´¥'), 'error');
                }
            } catch (error) {
                showMessage(message, 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // é‡è½½é…ç½®
        document.getElementById('reloadBtn').addEventListener('click', async () => {
            const btn = document.getElementById('reloadBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> é‡è½½ä¸­...';
            btn.disabled = true;

            try {
                await loadConfig();
                showMessage(message, 'âœ… é…ç½®é‡è½½æˆåŠŸï¼', 'success');
            } catch (error) {
                showMessage(message, 'âŒ é‡è½½å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ç™»å‡º
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    await fetch('/admin/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                }

                // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ JWT
                localStorage.removeItem('admin_token');
                loginContainer.style.display = 'flex';
                configContainer.style.display = 'none';
                loginForm.reset();
                showMessage(loginMessage, 'âœ… å·²ç™»å‡º', 'success');
            } catch (error) {
                // å³ä½¿è¯·æ±‚å¤±è´¥ï¼Œä¹Ÿæ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('admin_token');
                loginContainer.style.display = 'flex';
                configContainer.style.display = 'none';
                loginForm.reset();
                showMessage(loginMessage, 'âœ… å·²ç™»å‡º', 'success');
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ session
        checkSession();

        // ==================== Cloudflare è¾…åŠ©åŠŸèƒ½ ====================

        // é…ç½®å‘å¯¼
        document.getElementById('wizardBtn').addEventListener('click', async () => {
            const btn = document.getElementById('wizardBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> åŠ è½½ä¸­...';
            btn.disabled = true;

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/admin/cloudflare/wizard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showWizardModal(data.steps);
                } else {
                    showCfHelperResult('åŠ è½½å‘å¯¼å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showCfHelperResult('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // æµ‹è¯•è¿æ¥å¹¶æ£€æŸ¥çŠ¶æ€ï¼ˆæµå¼æ£€æŸ¥ - SSEï¼‰
        document.getElementById('testConnectionBtn').addEventListener('click', async () => {
            const btn = document.getElementById('testConnectionBtn');
            const resultDiv = document.getElementById('cfHelperResult');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<span class="loading"></span> æ£€æŸ¥ä¸­...';
            btn.disabled = true;
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info show';
            resultDiv.innerHTML = '<div id="streamProgress"></div>';

            try {
                const token = localStorage.getItem('admin_token');

                // æ”¶é›†å‰ç«¯è¾“å…¥æ¡†çš„å½“å‰å€¼
                const formData = {
                    cf_account_id: document.getElementById('cfAccountId').value.trim() || null,
                    cf_kv_namespace_id: document.getElementById('cfKvNamespaceId').value.trim() || null,
                    cf_api_token: document.getElementById('cfApiToken').value.trim() || null
                };

                // åˆ›å»ºè¿›åº¦æ¡
                let progressBar = document.createElement('div');
                progressBar.style.cssText = 'background: #e0e0e0; height: 24px; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);';
                progressBar.innerHTML = '<div id="progressFill" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600;"></div>';
                document.getElementById('streamProgress').appendChild(progressBar);

                // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
                let messageContainer = document.createElement('pre');
                messageContainer.style.cssText = 'max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 16px; border-radius: 8px; font-size: 13px; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; border: 1px solid #e0e0e0;';
                document.getElementById('streamProgress').appendChild(messageContainer);

                let messages = [];

                // ä½¿ç”¨ POST è¯·æ±‚ä¼ é€’å‚æ•° (SSE ä¸æ”¯æŒ request bodyï¼Œæ‰€ä»¥ç”¨ URL params)
                const params = new URLSearchParams({
                    ...formData,
                    token: token
                });

                // åˆ›å»º EventSource è¿›è¡Œæµå¼é€šä¿¡
                const url = `/admin/cloudflare/test-and-check-stream?${params}`;

                // ä½¿ç”¨ fetch + ReadableStream æ›¿ä»£ EventSource (å› ä¸ºéœ€è¦ POST å’Œ Auth header)
                const response = await fetch('/admin/cloudflare/test-and-check-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                // æ·»åŠ å–æ¶ˆæŒ‰é’®
                let cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'âœ• å–æ¶ˆ';
                cancelBtn.className = 'btn btn-ghost';
                cancelBtn.style.cssText = 'margin-top: 12px;';
                let cancelled = false;
                cancelBtn.onclick = () => {
                    cancelled = true;
                    reader.cancel();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    messages.push('\nâš ï¸ æ£€æŸ¥å·²å–æ¶ˆ');
                    messageContainer.textContent = messages.join('\n');
                };
                document.getElementById('streamProgress').appendChild(cancelBtn);

                // è¯»å–æµå¼æ•°æ®
                while (true) {
                    const { done, value } = await reader.read();
                    if (done || cancelled) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const data = JSON.parse(jsonStr);

                                // æ›´æ–°è¿›åº¦æ¡
                                if (data.progress !== undefined) {
                                    const progressFill = document.getElementById('progressFill');
                                    progressFill.style.width = data.progress + '%';
                                    progressFill.textContent = data.progress + '%';
                                }

                                // æ·»åŠ æ¶ˆæ¯
                                if (data.message) {
                                    messages.push(`[${data.stage || 'info'}] ${data.message}`);
                                    messageContainer.textContent = messages.join('\n');
                                    messageContainer.scrollTop = messageContainer.scrollHeight;
                                }

                                // æ£€æŸ¥æ˜¯å¦å®Œæˆæˆ–é”™è¯¯
                                if (data.stage === 'done') {
                                    btn.innerHTML = originalText;
                                    btn.disabled = false;
                                    resultDiv.className = 'alert alert-success show';
                                    cancelBtn.remove();

                                    // æ˜¾ç¤ºæœ€ç»ˆæ‘˜è¦
                                    setTimeout(() => {
                                        messages.push('\nâœ… æ£€æŸ¥å®Œæˆï¼æ‰€æœ‰é…ç½®æ­£å¸¸ã€‚');
                                        messageContainer.textContent = messages.join('\n');
                                    }, 300);
                                    break;
                                } else if (data.stage === 'error') {
                                    btn.innerHTML = originalText;
                                    btn.disabled = false;
                                    resultDiv.className = 'alert alert-warning show';  // æ”¹ä¸ºè­¦å‘Šæ ·å¼
                                    cancelBtn.remove();

                                    // æ·»åŠ å‹å¥½æç¤º
                                    messages.push(`\n\nâš ï¸ ${data.message}`);
                                    if (data.can_continue) {
                                        messages.push(`\nğŸ’¡ å‹å¥½æç¤ºï¼šè™½ç„¶æ£€æµ‹åˆ°é”™è¯¯ï¼Œä½†è¿™ä¸ä»£è¡¨æœåŠ¡æ— æ³•ä½¿ç”¨ï¼`);
                                        messages.push(`   å»ºè®®æ‚¨å…ˆå°è¯•æ­£å¸¸ä½¿ç”¨æœåŠ¡ï¼Œå¦‚æœé‡åˆ°å®é™…é—®é¢˜ï¼Œå†è¿”å›æ­¤å¤„è°ƒæ•´é…ç½®ã€‚`);
                                    }
                                    messageContainer.textContent = messages.join('\n');
                                    break;
                                } else if (data.stage === 'warning') {
                                    // è­¦å‘Šé˜¶æ®µä¸ä¸­æ–­æµç¨‹ï¼Œç»§ç»­æ˜¾ç¤ºæ¶ˆæ¯
                                    // ä¸éœ€è¦ breakï¼Œè®©æµç¨‹ç»§ç»­
                                }
                            } catch (e) {
                                // JSON è§£æå¤±è´¥ï¼Œå¿½ç•¥
                            }
                        }
                    }
                }

                // æµå¼è¯»å–å®Œæˆ
                if (!cancelled) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    cancelBtn.remove();
                }

            } catch (error) {
                resultDiv.className = 'alert alert-error show';
                resultDiv.innerHTML = `<div style="padding: 16px;">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ===== å¯å¤ç”¨æ“ä½œå‡½æ•°ï¼šä¾›é…ç½®é¡µæŒ‰é’®å’Œé…ç½®å‘å¯¼è°ƒç”¨ =====
        // è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½ï¼ˆä»é…ç½®å‘å¯¼è°ƒç”¨ï¼‰
        async function autoDetectAction() {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/admin/cloudflare/auto-detect', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success && data.detected) {
                    // è‡ªåŠ¨å¡«å……
                    if (data.data.cf_account_id) {
                        document.getElementById('cfAccountId').value = data.data.cf_account_id;
                    }
                    if (data.data.cf_kv_namespace_id) {
                        document.getElementById('cfKvNamespaceId').value = data.data.cf_kv_namespace_id;
                    }

                    let msg = `âœ… ${data.message}\n`;
                    if (data.data.logged_in_as) {
                        msg += `ç™»å½•è´¦æˆ·: ${data.data.logged_in_as}\n`;
                    }
                    if (data.data.wrangler_version) {
                        msg += `Wrangler ç‰ˆæœ¬: ${data.data.wrangler_version}\n`;
                    }
                    if (data.data.namespace_title) {
                        msg += `æ£€æµ‹åˆ° Namespace: ${data.data.namespace_title}\n`;
                    }
                    if (data.warning) {
                        msg += `âš ï¸ ${data.warning}\n`;
                    }
                    msg += '\n' + data.note;

                    showCfHelperResult(msg, 'success');
                } else {
                    // æ„å»ºé”™è¯¯æ¶ˆæ¯
                    let errorMsg = `âš ï¸ ${data.error || 'è‡ªåŠ¨æ£€æµ‹å¤±è´¥'}\n\n`;
                    errorMsg += `ğŸ’¡ ${data.suggestion || 'è¯·ä½¿ç”¨é…ç½®å‘å¯¼æˆ–æ‰‹åŠ¨å¡«å†™'}\n`;

                    // å¦‚æœæœ‰å¯ç”¨çš„ namespace åˆ—è¡¨ï¼Œæ˜¾ç¤ºå‡ºæ¥
                    if (data.available_namespaces && data.available_namespaces.length > 0) {
                        errorMsg += `\nğŸ“¦ å½“å‰å¯ç”¨çš„ KV Namespaces:\n`;
                        data.available_namespaces.forEach(name => {
                            errorMsg += `   â€¢ ${name}\n`;
                        });
                    }

                    // å¦‚æœæœ‰é¢å¤–è¯´æ˜
                    if (data.note) {
                        errorMsg += `\n${data.note}\n`;
                    }

                    // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ fallback_hintï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤æç¤º
                    if (data.fallback_hint) {
                        errorMsg += `\n${data.fallback_hint}`;
                    } else {
                        errorMsg += `\nâœ¨ å³ä½¿è‡ªåŠ¨æ£€æµ‹å¤±è´¥ï¼Œæ‚¨ä»å¯ç‚¹å‡»ã€ŒğŸ“– é…ç½®å‘å¯¼ã€æŒ‰é’®ï¼Œè·å–è¯¦ç»†çš„é…ç½®æ­¥éª¤æŒ‡å¼•`;
                    }

                    showCfHelperResult(errorMsg, 'warning');
                }
            } catch (error) {
                // æ„å»ºå‹å¥½çš„é”™è¯¯æç¤º
                let errorMsg = `âŒ è‡ªåŠ¨æ£€æµ‹å¤±è´¥\n\n`;
                errorMsg += `é”™è¯¯åŸå› : ${error.message}\n\n`;
                errorMsg += `ğŸ’¡ è¯·å…ˆå®‰è£… Wrangler CLI: npm install -g wrangler\n\n`;
                errorMsg += `âœ¨ å³ä½¿è‡ªåŠ¨æ£€æµ‹å¤±è´¥ï¼Œæ‚¨ä»å¯ç‚¹å‡»ã€ŒğŸ“– é…ç½®å‘å¯¼ã€æŒ‰é’®ï¼Œè·å–è¯¦ç»†çš„é…ç½®æ­¥éª¤æŒ‡å¼•`;

                showCfHelperResult(errorMsg, 'error');

                // é«˜äº®é…ç½®å‘å¯¼æŒ‰é’®ä»¥å¼•å¯¼ç”¨æˆ·æ³¨æ„
                const wizardBtn = document.getElementById('wizardBtn');
                if (wizardBtn) {
                    wizardBtn.style.animation = 'pulse 2s ease-in-out 3';
                    setTimeout(() => {
                        wizardBtn.style.animation = '';
                    }, 6000);
                }
            }
        }

        // ===== å…¶ä»–å¯å¤ç”¨æ“ä½œå‡½æ•° =====
        async function ensureNamespaceAction() {
            const accountId = document.getElementById('cfAccountId').value;
            const apiToken = document.getElementById('cfApiToken').value;

            if (!accountId || !apiToken) {
                showCreateNamespaceModal('è¯·å…ˆå¡«å†™ Cloudflare è´¦æˆ· ID ä¸ API Token', 'warning');
                return;
            }

            // æ˜¾ç¤ºè½½å…¥çŠ¶æ€
            showCreateNamespaceModal('ğŸ”„ æ­£åœ¨åˆ›å»º KV Namespace...', 'info');

            try {
                const token = localStorage.getItem('admin_token');
                const resp = await fetch('/admin/cloudflare/kv/ensure-namespace', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'EMAIL_STORAGE', cf_account_id: accountId, cf_api_token: apiToken })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    document.getElementById('cfKvNamespaceId').value = data.id;
                    const msg = data.created
                        ? `âœ… å·²åˆ›å»º Namespace EMAIL_STORAGE\n\nNamespace ID: ${data.id}\n\næ­¤ ID å·²è‡ªåŠ¨å¡«å…¥ä¸‹æ–¹å­—æ®µï¼Œæ‚¨å¯ä»¥ç»§ç»­é…ç½®å…¶ä»–é€‰é¡¹ã€‚`
                        : `âœ… å·²é€‰æ‹©ç°æœ‰ Namespace EMAIL_STORAGE\n\nNamespace ID: ${data.id}\n\næ­¤ ID å·²è‡ªåŠ¨å¡«å…¥ä¸‹æ–¹å­—æ®µï¼Œæ‚¨å¯ä»¥ç»§ç»­é…ç½®å…¶ä»–é€‰é¡¹ã€‚`;
                    showCreateNamespaceModal(msg, 'success');
                } else {
                    showCreateNamespaceModal('âŒ æ“ä½œå¤±è´¥\n\n' + (data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showCreateNamespaceModal('âŒ ç½‘ç»œé”™è¯¯\n\n' + e.message, 'error');
            }
        }

        // åˆ›å»ºç‹¬ç«‹çš„ KV Namespace ç»“æœæ¶ˆæ¯æ¡†
        function showCreateNamespaceModal(message, type) {
            // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingModal = document.getElementById('createNamespaceModal');
            if (existingModal) {
                existingModal.remove();
            }

            // åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
            const modal = document.createElement('div');
            modal.id = 'createNamespaceModal';
            modal.className = 'modal show';
            modal.style.zIndex = '1050'; // ç¡®ä¿åœ¨å…¶ä»–æ¨¡æ€æ¡†ä¹‹ä¸Š

            const typeColors = {
                success: { bg: '#D1FAE5', border: '#10B981', text: '#065F46', icon: 'âœ…' },
                error: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B', icon: 'âŒ' },
                warning: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E', icon: 'âš ï¸' },
                info: { bg: 'var(--primary-light)', border: 'var(--primary)', text: 'var(--primary-dark)', icon: 'â„¹ï¸' }
            };

            const colors = typeColors[type] || typeColors.info;

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; margin-top: 100px;">
                    <div class="modal-header" style="background: ${colors.bg}; border-color: ${colors.border};">
                        <h3 class="modal-title" style="color: ${colors.text}; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${colors.icon}</span>
                            KV Namespace æ“ä½œçµæœ
                        </h3>
                        <button class="modal-close" onclick="closeCreateNamespaceModal()">âœ•</button>
                    </div>
                    <div class="modal-body">
                        <div style="
                            background: ${colors.bg};
                            border: 2px solid ${colors.border};
                            color: ${colors.text};
                            padding: 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            line-height: 1.6;
                            white-space: pre-line;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        ">
                            ${message}
                        </div>
                        ${type === 'success' || type === 'error' || type === 'warning' ? `
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="closeCreateNamespaceModal()">ç¡®å®š</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCreateNamespaceModal();
                }
            });

            // ESC é”®å…³é—­
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeCreateNamespaceModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // å…³é—­ KV Namespace ç»“æœæ¶ˆæ¯æ¡†
        function closeCreateNamespaceModal() {
            const modal = document.getElementById('createNamespaceModal');
            if (modal) {
                modal.remove();
            }
        }

        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰ç‰‡æ®µå†…å®¹
        let currentSnippetContent = '';

        // åˆ›å»º Wrangler ç‰‡æ®µæ¶ˆæ¯æ¡†
        function showWranglerSnippetModal(message, type, snippet = null) {
            // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingModal = document.getElementById('wranglerSnippetModal');
            if (existingModal) {
                existingModal.remove();
            }

            // å­˜å‚¨ç‰‡æ®µå†…å®¹åˆ°å…¨å±€å˜é‡
            currentSnippetContent = snippet || '';

            // åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
            const modal = document.createElement('div');
            modal.id = 'wranglerSnippetModal';
            modal.className = 'modal show';
            modal.style.zIndex = '1050';

            const typeColors = {
                success: { bg: '#D1FAE5', border: '#10B981', text: '#065F46', icon: 'âœ…' },
                error: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B', icon: 'âŒ' },
                warning: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E', icon: 'âš ï¸' },
                info: { bg: 'var(--primary-light)', border: 'var(--primary)', text: 'var(--primary-dark)', icon: 'â„¹ï¸' }
            };

            const colors = typeColors[type] || typeColors.info;

            // ç”Ÿæˆä»£ç ç‰‡æ®µæ˜¾ç¤ºåŒºåŸŸ
            const snippetHtml = snippet ? `
                <div style="margin-top: 16px;">
                    <div id="snippetCodeDisplay" style="
                        background: #1f2937;
                        color: #10b981;
                        padding: 16px;
                        border-radius: 8px;
                        font-family: 'Monaco', 'Courier New', monospace;
                        font-size: 13px;
                        white-space: pre-line;
                        border: 2px solid #374151;
                        position: relative;
                        user-select: text;
                        cursor: text;
                    ">${snippet}</div>
                    <div style="margin-top: 12px; text-align: center;">
                        <button class="btn btn-secondary" onclick="copyCurrentSnippet()">
                            ğŸ“‹ å¤åˆ¶é…ç½®ç‰‡æ®µ
                        </button>
                        <button class="btn btn-secondary" onclick="selectSnippetText()" style="margin-left: 8px;">
                            ğŸ¯ é€‰å–æ–‡æœ¬
                        </button>
                    </div>
                </div>
            ` : '';

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; margin-top: 50px;">
                    <div class="modal-header" style="background: ${colors.bg}; border-color: ${colors.border};">
                        <h3 class="modal-title" style="color: ${colors.text}; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${colors.icon}</span>
                            Wrangler é…ç½®ç‰‡æ®µ
                        </h3>
                        <button class="modal-close" onclick="closeWranglerSnippetModal()">âœ•</button>
                    </div>
                    <div class="modal-body">
                        <div style="
                            background: ${colors.bg};
                            border: 2px solid ${colors.border};
                            color: ${colors.text};
                            padding: 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            line-height: 1.6;
                            white-space: pre-line;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        ">
                            ${message}
                        </div>
                        ${snippetHtml}
                        ${type === 'success' || type === 'error' || type === 'warning' ? `
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="closeWranglerSnippetModal()">ç¡®å®š</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeWranglerSnippetModal();
                }
            });

            // ESC é”®å…³é—­
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeWranglerSnippetModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // å…³é—­ Wrangler ç‰‡æ®µæ¶ˆæ¯æ¡†
        function closeWranglerSnippetModal() {
            const modal = document.getElementById('wranglerSnippetModal');
            if (modal) {
                modal.remove();
            }
        }

        // å¤åˆ¶å½“å‰ç‰‡æ®µåˆ°å‰ªè´´æ¿
        function copyCurrentSnippet() {
            if (!currentSnippetContent) {
                alert('æ²¡æœ‰å¯å¤åˆ¶çš„é…ç½®ç‰‡æ®µ');
                return;
            }

            // ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentSnippetContent).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    // Fallback to older method
                    fallbackCopySnippet();
                });
            } else {
                // Fallback for older browsers
                fallbackCopySnippet();
            }
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopySuccess() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const originalBg = btn.style.background;
            const originalColor = btn.style.color;

            btn.innerHTML = 'âœ… å·²å¤åˆ¶';
            btn.style.background = '#10B981';
            btn.style.color = 'white';

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = originalBg;
                btn.style.color = originalColor;
            }, 2000);
        }

        // æ—§ç‰ˆæµè§ˆå™¨çš„å¤åˆ¶æ–¹æ³•
        function fallbackCopySnippet() {
            // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
            const textArea = document.createElement('textarea');
            textArea.value = currentSnippetContent;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);

            try {
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    throw new Error('execCommand failed');
                }
            } catch (err) {
                // æœ€ç»ˆçš„é”™è¯¯å¤„ç†
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰å–å¹¶å¤åˆ¶ä»£ç ç‰‡æ®µ\n\næ‚¨å¯ä»¥ç‚¹å‡»ã€ŒğŸ¯ é€‰å–æ–‡æœ¬ã€æŒ‰é’®æ¥é€‰å–ä»£ç ');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // é€‰å–ç‰‡æ®µæ–‡æœ¬
        function selectSnippetText() {
            const codeDisplay = document.getElementById('snippetCodeDisplay');
            if (!codeDisplay) {
                alert('æ‰¾ä¸åˆ°ä»£ç ç‰‡æ®µ');
                return;
            }

            // é€‰å–æ–‡æœ¬
            if (window.getSelection && document.createRange) {
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(codeDisplay);
                selection.removeAllRanges();
                selection.addRange(range);

                // æç¤ºç”¨æˆ·
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… å·²é€‰å–';
                btn.style.background = '#3B82F6';
                btn.style.color = 'white';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);

                // æç¤ºç”¨æˆ·å¯ä»¥å¤åˆ¶
                setTimeout(() => {
                    alert('ä»£ç å·²é€‰å–ï¼Œè¯·æŒ‰ Ctrl+C (Windows) æˆ– Cmd+C (Mac) å¤åˆ¶');
                }, 100);
            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨é€‰å–ï¼Œè¯·æ‰‹åŠ¨é€‰å–ä»£ç ç‰‡æ®µ');
            }
        }

        // åˆ›å»ºå†™å…¥ Wrangler æ–‡ä»¶æ¶ˆæ¯æ¡†
        function showWriteWranglerModal(message, type) {
            // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingModal = document.getElementById('writeWranglerModal');
            if (existingModal) {
                existingModal.remove();
            }

            // åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
            const modal = document.createElement('div');
            modal.id = 'writeWranglerModal';
            modal.className = 'modal show';
            modal.style.zIndex = '1050';

            const typeColors = {
                success: { bg: '#D1FAE5', border: '#10B981', text: '#065F46', icon: 'âœ…' },
                error: { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B', icon: 'âŒ' },
                warning: { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E', icon: 'âš ï¸' },
                info: { bg: 'var(--primary-light)', border: 'var(--primary)', text: 'var(--primary-dark)', icon: 'â„¹ï¸' }
            };

            const colors = typeColors[type] || typeColors.info;

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; margin-top: 100px;">
                    <div class="modal-header" style="background: ${colors.bg}; border-color: ${colors.border};">
                        <h3 class="modal-title" style="color: ${colors.text}; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${colors.icon}</span>
                            å†™å…¥ wrangler.toml
                        </h3>
                        <button class="modal-close" onclick="closeWriteWranglerModal()">âœ•</button>
                    </div>
                    <div class="modal-body">
                        <div style="
                            background: ${colors.bg};
                            border: 2px solid ${colors.border};
                            color: ${colors.text};
                            padding: 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            line-height: 1.6;
                            white-space: pre-line;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        ">
                            ${message}
                        </div>
                        ${type === 'success' || type === 'error' || type === 'warning' ? `
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="closeWriteWranglerModal()">ç¡®å®š</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeWriteWranglerModal();
                }
            });

            // ESC é”®å…³é—­
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeWriteWranglerModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // å…³é—­å†™å…¥ Wrangler æ¶ˆæ¯æ¡†
        function closeWriteWranglerModal() {
            const modal = document.getElementById('writeWranglerModal');
            if (modal) {
                modal.remove();
            }
        }

        async function wranglerSnippetAction() {
            const namespaceId = document.getElementById('cfKvNamespaceId').value;
            if (!namespaceId) {
                showWranglerSnippetModal('âš ï¸ è¯·å…ˆå¡«å†™æˆ–åˆ›å»º KV Namespace ID\n\nè¯·ç¡®ä¿æ‚¨å·²å®Œæˆæ­¥éª¤ 2 å¹¶å¡«å…¥äº†æœ‰æ•ˆçš„ Namespace IDã€‚', 'warning');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            showWranglerSnippetModal('ğŸ”„ æ­£åœ¨ç”Ÿæˆ Wrangler é…ç½®ç‰‡æ®µ...', 'info');

            try {
                const token = localStorage.getItem('admin_token');
                const resp = await fetch(`/admin/cloudflare/wrangler-snippet?binding=EMAIL_STORAGE&namespace_id=${encodeURIComponent(namespaceId)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    const message = `âœ… Wrangler é…ç½®ç‰‡æ®µå·²ç”Ÿæˆ\n\nè¯·å°†ä»¥ä¸‹ç‰‡æ®µå¤åˆ¶åˆ° workers/wrangler.toml æ–‡ä»¶ä¸­ï¼š\n\n${data.snippet}\nä½¿ç”¨æ–¹æ³•ï¼š\n1. å¤åˆ¶ä¸Šé¢çš„é…ç½®ç‰‡æ®µ\n2. æ‰“å¼€ workers/wrangler.toml æ–‡ä»¶\n3. å°†ç‰‡æ®µç²˜è´´åˆ°æ–‡ä»¶ä¸­\n4. ä¿å­˜æ–‡ä»¶\n5. åœ¨ workers ç›®å½•æ‰§è¡Œ: wrangler deploy`;
                    showWranglerSnippetModal(message, 'success', data.snippet);
                } else {
                    showWranglerSnippetModal('âŒ ç”Ÿæˆå¤±è´¥\n\n' + (data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showWranglerSnippetModal('âŒ ç½‘ç»œé”™è¯¯\n\n' + e.message, 'error');
            }
        }

        async function writeWranglerAction() {
            const namespaceId = document.getElementById('cfKvNamespaceId').value;
            if (!namespaceId) {
                showWriteWranglerModal('âš ï¸ è¯·å…ˆå¡«å†™æˆ–åˆ›å»º KV Namespace ID\n\nè¯·ç¡®ä¿æ‚¨å·²å®Œæˆæ­¥éª¤ 2 å¹¶å¡«å…¥äº†æœ‰æ•ˆçš„ Namespace IDã€‚', 'warning');
                return;
            }

            // è·å–æ–‡ä»¶è·¯å¾„
            const filePath = prompt('wrangler.toml è·¯å¾„', 'workers/wrangler.toml');
            if (!filePath) return;

            // æ˜¾ç¤ºè½½å…¥çŠ¶æ€
            showWriteWranglerModal('ğŸ”„ æ­£åœ¨å†™å…¥ wrangler.toml æ–‡ä»¶...\n\næ­£åœ¨å°† KV Namespace é…ç½®å†™å…¥åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­...', 'info');

            try {
                const token = localStorage.getItem('admin_token');
                const resp = await fetch('/admin/cloudflare/write-wrangler', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: filePath, binding: 'EMAIL_STORAGE', namespace_id: namespaceId, confirm: true })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    const message = `âœ… wrangler.toml å·²æˆåŠŸæ›´æ–°\n\næ–‡ä»¶è·¯å¾„: ${data.file}\n\næ¥ä¸‹æ¥çš„æ­¥éª¤:\n1. ç¡®è®¤ workers/wrangler.toml æ–‡ä»¶å·²æ­£ç¡®æ›´æ–°\n2. åœ¨ workers ç›®å½•æ‰§è¡Œ: wrangler deploy\n3. å®Œæˆ Worker éƒ¨ç½²åˆ° Cloudflare`;
                    showWriteWranglerModal(message, 'success');
                } else {
                    const message = `âŒ å†™å…¥å¤±è´¥\n\né”™è¯¯è¯¦æƒ…: ${data.detail || 'æœªçŸ¥é”™è¯¯'}\n\nğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆ:\nâ€¢ æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®\nâ€¢ ç¡®ä¿æœ‰å†™å…¥æƒé™\nâ€¢ æˆ–ä½¿ç”¨ã€ŒğŸ§© Wrangler ç‰‡æ®µã€åŠŸèƒ½æ‰‹åŠ¨å¤åˆ¶é…ç½®`;
                    showWriteWranglerModal(message, 'error');
                }
            } catch (e) {
                showWriteWranglerModal('âŒ ç½‘ç»œé”™è¯¯\n\n' + e.message, 'error');
            }
        }

        // å·²ç§»é™¤ Cloudflare é¢æ¿å†…çš„ã€Œåˆ›å»º/ç‰‡æ®µ/å†™å…¥ã€æŒ‰é’®ï¼ˆä¿ç•™åœ¨é…ç½®å‘å¯¼å†…ï¼‰

        // æ˜¾ç¤ºé…ç½®å‘å¯¼æ¨¡æ€æ¡†
        function showWizardModal(steps) {
            const wizardSteps = document.getElementById('wizardSteps');
            wizardSteps.innerHTML = '';

            // å‘å¯¼å†…æ¶ˆæ¯æ¡†ï¼ˆç”¨äºæ˜¾ç¤º Wrangler ç‰‡æ®µç­‰ï¼‰
            const wizardMsgBox = document.createElement('div');
            wizardMsgBox.id = 'wizardMsgBox';
            wizardMsgBox.className = 'alert';
            wizardMsgBox.style.display = 'none';
            wizardSteps.appendChild(wizardMsgBox);

            steps.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'wizard-step';
                
                // æ„å»ºå‘½ä»¤å±•ç¤ºåŒºåŸŸï¼ˆå¦‚æœå­˜åœ¨å‘½ä»¤ï¼‰
                let commandHtml = '';
                if (step.command) {
                    commandHtml = `
                        <div style="background: var(--gray-900); color: #00ff00; padding: 12px; border-radius: 6px; margin: 12px 0; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; position: relative;">
                            <code style="display: block; white-space: pre-wrap;">${step.command}</code>
                        </div>
                        <button class="btn btn-ghost" onclick="copyCommand('${step.command.replace(/'/g, "\\'")}'); event.stopPropagation();" style="margin-bottom: 8px;">
                            ğŸ“‹ å¤åˆ¶å‘½ä»¤
                        </button>
                    `;
                }
                
                // æ„å»ºæŒ‰é’®åŒºåŸŸ
                let actionsHtml = '<div class="wizard-step-actions">';

                // æ·»åŠ  Cloudflare æœåŠ¡é“¾æ¥æŒ‰é’®ï¼ˆå¦‚æœæœ‰ URLï¼Œä½†æ’é™¤ step 4ï¼‰
                if (step.url && String(step.id) !== '4') {
                    // æ ¹æ®æ­¥éª¤ ID è‡ªå®šä¹‰æŒ‰é’®æ–‡æœ¬
                    let buttonText = 'ğŸ”— æ‰“å¼€é“¾æ¥';
                    if (String(step.id) === '1') {
                        buttonText = 'ğŸ”— æ‰“å¼€ Cloudflare Dashboard';
                    } else if (String(step.id) === '2') {
                        buttonText = 'ğŸ”— æ‰“å¼€ API Token ç®¡ç†';
                    } else if (String(step.id) === '3') {
                        buttonText = 'ğŸ”— æ‰“å¼€ Workers KV ç®¡ç†';
                    } else if (String(step.id) === '5') {
                        buttonText = 'ğŸ”— æ‰“å¼€ Email Routing é…ç½®';
                    }

                    actionsHtml += `
                        <a href="${step.url}" target="_blank" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                            ${buttonText}
                        </a>
                    `;
                }

                if (step.field_id) {
                    actionsHtml += `
                        <button class="btn btn-secondary" onclick="focusField('${step.field_id}')">
                            ğŸ“ å‰å¾€å¡«å†™
                        </button>
                    `;
                }
                // åœ¨æ­¥éª¤ 1 æ·»åŠ è‡ªåŠ¨æ£€æµ‹æŒ‰é’®
                if (String(step.id) === '1') {
                    actionsHtml += `
                        <button class="btn btn-ghost" onclick="triggerAutoDetectFromWizard(event)" style="font-size: 13px;">
                            ğŸ› ï¸ å¯é€‰åŠŸèƒ½: è‡ªåŠ¨æ£€æµ‹
                        </button>
                    `;
                }
                // å°†ã€Œåˆ›å»º KV Namespaceã€æŒ‰é’®æ·»åŠ åˆ°æ­¥éª¤ 3
                if (String(step.id) === '3') {
                    actionsHtml += `
                        <button class="btn btn-primary" onclick="ensureNamespaceAction()">
                            ğŸ› ï¸ å¯é€‰åŠŸèƒ½: å¿«é€Ÿå¡«å†™ KV Namespace
                        </button>
                    `;
                }
                // å°†ä¸€é”®éƒ¨ç½²æŒ‰é’®å’Œæ‰‹åŠ¨é…ç½®é€‰é¡¹æ·»åŠ åˆ°æ­¥éª¤ 4
                if (String(step.id) === '4') {
                    // è·å–æ‰‹åŠ¨é…ç½®è¯´æ˜ï¼ˆå¦‚æœæœ‰ï¼‰
                    const manualConfigDesc = step.manual_config_description || '';

                    actionsHtml += `
                        <div style="margin-top: 8px; display: flex; justify-content: center;">
                            <a href="https://deploy.workers.cloudflare.com/?url=https://github.com/TonnyWong1052/temp-email/tree/main/workers" target="_blank">
                                <img src="https://deploy.workers.cloudflare.com/button" alt="Deploy to Cloudflare Workers" style="border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';" />
                            </a>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-ghost" onclick="showManualConfigMessage(\`${manualConfigDesc}\`)" style="flex: 1; height: 40px; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1.2; padding: 8px;">
                                <span style="font-size: 14px;">ğŸ”§ æ‰‹åŠ¨é…ç½®é€‰é¡¹</span>
                            </button>
                        </div>
                    `;
                }
                actionsHtml += '</div>';
                
                stepDiv.innerHTML = `
                    <div class="wizard-step-header">
                        <div class="wizard-step-icon">${step.icon}</div>
                        <div class="wizard-step-title">æ­¥éª¤ ${step.id}: ${step.title}</div>
                    </div>
                    <div class="wizard-step-desc">${step.description}</div>
                    <div class="wizard-step-hint">ğŸ’¡ ${step.hint}</div>
                    ${commandHtml}
                    ${actionsHtml}
                `;
                wizardSteps.appendChild(stepDiv);
            });


            document.getElementById('wizardModal').classList.add('show');
        }

        // åœ¨å‘å¯¼å†…æ˜¾ç¤ºæ¶ˆæ¯
        function showWizardMessage(message, type, autoHide = false) {
            const box = document.getElementById('wizardMsgBox');
            if (!box) {
                showCfHelperResult(message, type || 'info');
                return;
            }
            box.innerHTML = message.replace(/\n/g, '<br>');
            box.className = `alert alert-${type || 'info'} show`;
            box.style.display = 'block';
            box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // å¦‚æœå¯ç”¨è‡ªåŠ¨éšè—ï¼Œæ ¹æ®æ¶ˆæ¯é•¿åº¦åŠ¨æ€è°ƒæ•´æ˜¾ç¤ºæ—¶é—´
            if (autoHide) {
                const messageLength = message.length;
                const displayTime = Math.min(30000, Math.max(5000, messageLength * 5));
                setTimeout(() => {
                    box.style.display = 'none';
                }, displayTime);
            }
        }
        
        // å¤åˆ¶å‘½ä»¤åˆ°å‰ªè´´æ¿
        function copyCommand(command) {
            navigator.clipboard.writeText(command).then(() => {
                showCfHelperResult('âœ… å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                setTimeout(() => {
                    document.getElementById('cfHelperResult').style.display = 'none';
                }, 2000);
            }).catch(err => {
                showCfHelperResult('âŒ å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
            });
        }

        // å…³é—­é…ç½®å‘å¯¼
        function closeWizardModal() {
            document.getElementById('wizardModal').classList.remove('show');
        }

        // ä»é…ç½®å‘å¯¼è§¦å‘è‡ªåŠ¨æ£€æµ‹
        async function triggerAutoDetectFromWizard(event) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const resultDiv = document.getElementById('cfHelperResult');

            // æ˜¾ç¤ºæŒ‰é’®è½½å…¥åŠ¨ç”»
            btn.innerHTML = '<span class="loading"></span> æ£€æµ‹ä¸­...';
            btn.disabled = true;

            // åœ¨ç»“æœåŒºåŸŸæ˜¾ç¤ºè½½å…¥åŠ¨ç”»ï¼ˆä¸æµ‹è¯•è¿æ¥ç›¸åŒçš„ä½ç½®ï¼‰
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info show';
            resultDiv.innerHTML = '<div style="padding: 16px;"><span class="loading"></span> æ­£åœ¨è‡ªåŠ¨æ£€æµ‹ Cloudflare é…ç½®...</div>';

            try {
                // å…³é—­å‘å¯¼æ¨¡æ€æ¡†
                closeWizardModal();

                // è°ƒç”¨è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½
                await autoDetectAction();
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // æ˜¾ç¤ºæ‰‹åŠ¨é…ç½®è¯´æ˜çš„ç‹¬ç«‹æ¨¡æ€æ¡†
        function showManualConfigMessage(manualConfigDesc) {
            if (!manualConfigDesc) {
                alert('æš‚æ— æ‰‹åŠ¨é…ç½®è¯´æ˜');
                return;
            }

            // æ„å»ºå®Œæ•´çš„æ¶ˆæ¯å†…å®¹
            const content = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 20px; white-space: pre-line; line-height: 1.8; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                    <div style="font-weight: 600; font-size: 18px; margin-bottom: 16px; text-align: center;">ğŸ“ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤è¯´æ˜</div>
                    <div style="font-size: 14px;">${manualConfigDesc}</div>
                </div>
                <div style="background: var(--gray-50); padding: 20px; border-radius: 12px; border: 1px solid var(--gray-200);">
                    <div style="font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 16px; text-align: center;">
                        ğŸ› ï¸ Wrangler é…ç½®å·¥å…·
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center;">
                        <button class="btn btn-secondary" onclick="wranglerSnippetAction(); closeManualConfigModal();" style="font-size: 14px; padding: 10px 20px;">
                            ğŸ§© Wrangler ç‰‡æ®µ
                        </button>
                        <span style="color: var(--gray-500); font-size: 14px;">æˆ–</span>
                        <button class="btn btn-ghost" onclick="writeWranglerAction(); closeManualConfigModal();" style="font-size: 14px; padding: 10px 20px;">
                            âœï¸ å†™å…¥ wrangler.toml
                        </button>
                    </div>
                    <div style="font-size: 13px; color: var(--gray-600); margin-top: 16px; text-align: center; background: white; padding: 12px; border-radius: 8px;">
                        ğŸ’¡ ä¼˜å…ˆä½¿ç”¨ä¸€é”®éƒ¨ç½²æŒ‰é’®ã€‚æ‰‹åŠ¨é…ç½®ä»…ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆã€‚
                    </div>
                </div>
            `;

            // è®¾ç½®å†…å®¹å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('manualConfigContent').innerHTML = content;
            document.getElementById('manualConfigModal').classList.add('show');
        }

        // å…³é—­æ‰‹åŠ¨é…ç½®æ¨¡æ€æ¡†
        function closeManualConfigModal() {
            document.getElementById('manualConfigModal').classList.remove('show');
        }

        // æ˜¾ç¤ºå·¥ä½œåŸç†æµç¨‹å›¾
        document.getElementById('showFlowBtn')?.addEventListener('click', function() {
            document.getElementById('flowDiagramModal').classList.add('show');
        });

        // å…³é—­æµç¨‹å›¾æ¨¡æ€æ¡†
        function closeFlowDiagramModal() {
            document.getElementById('flowDiagramModal').classList.remove('show');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æµç¨‹å›¾
        document.getElementById('flowDiagramModal')?.addEventListener('click', function(e) {
            if (e.target.id === 'flowDiagramModal') {
                closeFlowDiagramModal();
            }
        });

        // èšç„¦åˆ°æŒ‡å®šå­—æ®µ
        function focusField(fieldId) {
            closeWizardModal();
            // åˆ‡æ¢åˆ° Cloudflare é…ç½®é¡µé¢
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector('.nav-link[data-section="cloudflare"]').classList.add('active');
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById('section-cloudflare').classList.add('active');

            // èšç„¦å¹¶é«˜äº®
            const field = document.getElementById(fieldId);
            if (field) {
                field.focus();
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                field.style.borderColor = 'var(--primary)';
                field.style.boxShadow = '0 0 0 3px var(--primary-light)';
                setTimeout(() => {
                    field.style.borderColor = '';
                    field.style.boxShadow = '';
                }, 2000);
            }
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showTestResult(data) {
            const resultDiv = document.getElementById('cfHelperResult');
            let html = '';

            if (data.checks && data.checks.length > 0) {
                data.checks.forEach(check => {
                    const isPassed = check.status === 'passed';
                    html += `
                        <div class="check-item ${isPassed ? 'passed' : 'failed'}">
                            <div class="check-icon">${check.icon}</div>
                            <div style="flex: 1;">
                                <div class="check-name">${check.name}</div>
                                <div class="check-message">${check.message}</div>
                            </div>
                        </div>
                    `;
                });
            }

            html += `<div style="margin-top: 12px; font-weight: 600;">${data.message}</div>`;

            resultDiv.innerHTML = html;
            resultDiv.style.display = 'flex';
            resultDiv.style.flexDirection = 'column';
            resultDiv.className = `alert alert-${data.overall_status === 'success' ? 'success' : 'error'} show`;

            // è‡ªåŠ¨æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // æ˜¾ç¤ºè¾…åŠ©åŠŸèƒ½ç»“æœ
        function showCfHelperResult(message, type) {
            const resultDiv = document.getElementById('cfHelperResult');
            resultDiv.innerHTML = message.replace(/\n/g, '<br>');
            resultDiv.className = `alert alert-${type} show`;
            // æ ¹æ®æ¶ˆæ¯é•¿åº¦åŠ¨æ€è°ƒæ•´æ˜¾ç¤ºæ—¶é—´ï¼ˆæœ€å°‘ 15 ç§’ï¼Œæœ€å¤š 60 ç§’ï¼‰
            const messageLength = message.length;
            const displayTime = Math.min(60000, Math.max(15000, messageLength * 10));
            setTimeout(() => {
                resultDiv.className = 'alert';
            }, displayTime);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('wizardModal').addEventListener('click', (e) => {
            if (e.target.id === 'wizardModal') {
                closeWizardModal();
            }
        });

        document.getElementById('manualConfigModal').addEventListener('click', (e) => {
            if (e.target.id === 'manualConfigModal') {
                closeManualConfigModal();
            }
        });

        // ç›‘å¬ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.keyCode === 27) {
                // å…³é—­æ‰‹åŠ¨é…ç½®æ¨¡æ€æ¡†
                const manualConfigModal = document.getElementById('manualConfigModal');
                if (manualConfigModal && manualConfigModal.classList.contains('show')) {
                    closeManualConfigModal();
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                // å…³é—­æµç¨‹å›¾æ¨¡æ€æ¡†
                const flowDiagramModal = document.getElementById('flowDiagramModal');
                if (flowDiagramModal && flowDiagramModal.classList.contains('show')) {
                    closeFlowDiagramModal();
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                // å…³é—­é…ç½®å‘å¯¼æ¨¡æ€æ¡†
                const wizardModal = document.getElementById('wizardModal');
                if (wizardModal && wizardModal.classList.contains('show')) {
                    closeWizardModal();
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        });

        // ==================== Pattern Training Functions ====================

        // ç›‘å¬æ–‡æœ¬é€‰ä¸­äº‹ä»¶
        document.getElementById('emailSample').addEventListener('mouseup', function() {
            const textarea = this;
            const selectedText = textarea.value.substring(
                textarea.selectionStart,
                textarea.selectionEnd
            ).trim();

            const learnBtn = document.getElementById('learnPatternBtn');

            // åˆ¤æ–­æ˜¯å¦å¯èƒ½æ˜¯éªŒè¯ç  (4-10ä½å­—æ¯æ•°å­—)
            if (selectedText.length >= 4 && selectedText.length <= 10) {
                if (/^[A-Z0-9]+$/i.test(selectedText)) {
                    learnBtn.disabled = false;
                    learnBtn.innerHTML = `ğŸ“Œ å­¦ä¹ ã€Œ${selectedText}ã€`;
                    learnBtn.dataset.selectedText = selectedText;
                    learnBtn.dataset.selectionStart = textarea.selectionStart;
                } else {
                    learnBtn.disabled = true;
                    learnBtn.innerHTML = 'ğŸ“Œ å­¦ä¹ é€‰ä¸­çš„éªŒè¯ç æ¨¡å¼';
                }
            } else {
                learnBtn.disabled = true;
                learnBtn.innerHTML = 'ğŸ“Œ å­¦ä¹ é€‰ä¸­çš„éªŒè¯ç æ¨¡å¼';
            }
        });

        // å­¦ä¹ æ¨¡å¼æŒ‰é’®
        document.getElementById('learnPatternBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            const selectedText = btn.dataset.selectedText;
            const selectionStart = parseInt(btn.dataset.selectionStart);
            const emailContent = document.getElementById('emailSample').value;

            if (!selectedText || !emailContent) {
                showMessage(message, 'âŒ è¯·å…ˆç²˜è´´é‚®ä»¶å¹¶é€‰ä¸­éªŒè¯ç ', 'error');
                return;
            }

            btn.innerHTML = '<span class="loading"></span> å­¦ä¹ ä¸­...';
            btn.disabled = true;

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/patterns/learn', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email_content: emailContent,
                        highlighted_code: selectedText,
                        highlight_position: selectionStart
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const keywords = data.preview.keywords_before.join('ã€');
                    showMessage(message, `âœ… æ¨¡å¼å­¦ä¹ æˆåŠŸï¼å…³é”®è¯ï¼š${keywords}`, 'success');
                    loadPatterns(); // é‡æ–°åŠ è½½æ¨¡å¼åˆ—è¡¨
                } else {
                    showMessage(message, `âŒ ${data.message || 'å­¦ä¹ å¤±è´¥'}`, 'error');
                }
            } catch (error) {
                showMessage(message, `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // æ¸…ç©ºæŒ‰é’®
        document.getElementById('clearSampleBtn').addEventListener('click', function() {
            document.getElementById('emailSample').value = '';
            const learnBtn = document.getElementById('learnPatternBtn');
            learnBtn.disabled = true;
            learnBtn.innerHTML = 'ğŸ“Œ å­¦ä¹ é€‰ä¸­çš„éªŒè¯ç æ¨¡å¼';
        });

        // åŠ è½½å·²å­¦ä¹ æ¨¡å¼åˆ—è¡¨
        async function loadPatterns() {
            const patternsList = document.getElementById('patternsList');

            patternsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">åŠ è½½ä¸­...</div>';

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/patterns', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (data.patterns.length === 0) {
                        patternsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-500);">æš‚æ— å·²å­¦ä¹ æ¨¡å¼ï¼Œè¯·å…ˆè®­ç»ƒ</div>';
                        return;
                    }

                    let html = '';
                    data.patterns.forEach(pattern => {
                        const successRate = pattern.usage_count > 0 
                            ? Math.round(pattern.success_rate * 100) 
                            : 0;
                        
                        // æˆªå–é‚®ä»¶å†…å®¹é¢„è§ˆï¼ˆæœ€å¤š150ä¸ªå­—ç¬¦ï¼‰
                        const emailPreview = pattern.email_content.length > 150 
                            ? pattern.email_content.substring(0, 150) + '...' 
                            : pattern.email_content;
                        
                        html += `
                            <div class="pattern-item" style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 8px;">
                                            <span class="badge badge-info">${pattern.code_type}</span>
                                            <span style="margin-left: 8px;">å…³é”®è¯ï¼šã€Œ${pattern.keywords_before.join('ã€')}ã€â†’ ${pattern.code_length}ä½${pattern.code_type === 'numeric' ? 'æ•°å­—' : 'å­—æ¯æ•°å­—'}</span>
                                        </div>
                                        
                                        <!-- é‚®ä»¶å†…å®¹é¢„è§ˆ -->
                                        <div style="background: var(--gray-50); border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                                            <div style="font-size: 11px; color: var(--gray-500); margin-bottom: 4px; font-weight: 600;">é‚®ä»¶å†…å®¹ï¼š</div>
                                            <div style="font-size: 12px; color: var(--gray-700); line-height: 1.5; font-family: monospace; white-space: pre-wrap;">${emailPreview}</div>
                                        </div>
                                        
                                        <!-- é«˜äº®éªŒè¯ç  -->
                                        <div style="font-size: 13px; color: var(--gray-700); margin-top: 8px;">
                                            <span style="color: var(--gray-500);">é«˜äº®éªŒè¯ç ï¼š</span>
                                            <span style="background: #FEF3C7; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-family: monospace;">${pattern.example_code}</span>
                                        </div>
                                    </div>
                                    <div style="text-align: right; margin-left: 16px;">
                                        <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">
                                            ä½¿ç”¨ ${pattern.usage_count} æ¬¡
                                        </div>
                                        ${pattern.usage_count > 0 ? `
                                        <div style="font-size: 12px; color: ${successRate >= 80 ? 'var(--success)' : 'var(--warning)'};">
                                            æˆåŠŸç‡ ${successRate}%
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; border-top: 1px solid var(--gray-200); padding-top: 12px;">
                                    <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 12px;" onclick="deletePattern('${pattern.id}')">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    patternsList.innerHTML = html;
                } else {
                    patternsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                patternsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">ç½‘ç»œé”™è¯¯</div>';
            }
        }

        // åˆ é™¤æ¨¡å¼
        async function deletePattern(patternId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å¼å—ï¼Ÿ')) {
                return;
            }

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`/api/patterns/${patternId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showMessage(message, 'âœ… æ¨¡å¼å·²åˆ é™¤', 'success');
                    loadPatterns();
                } else {
                    showMessage(message, `âŒ åˆ é™¤å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage(message, `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ¨¡å¼åˆ—è¡¨
        window.addEventListener('load', function() {
            // å»¶è¿ŸåŠ è½½ï¼Œç­‰å¾…ç™»å½•å®Œæˆ
            setTimeout(() => {
                if (localStorage.getItem('admin_token')) {
                    loadPatterns();
                }
            }, 1000);
        });
    </script>
</body>
</html>
                                <div class="form-hint" style="margin-left: 28px;">ä½¿ç”¨ Cloudflare Workers 
